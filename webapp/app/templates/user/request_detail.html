{% extends "layout/base.html" %}

{% block title %}–ó–∞—è–≤–∫–∞ ‚Ññ{{ request_obj.id }}{% endblock %}

{% block content %}

{# --- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏, —á—Ç–æ–±—ã —à–∞–±–ª–æ–Ω –ù–ï –ü–ê–î–ê–õ –µ—Å–ª–∏ —Ä–æ—É—Ç–µ—Ä –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ --- #}
{% set request_status_labels = {
  "new": "–ù–æ–≤–∞—è",
  "sent": "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –°–¢–û",
  "accepted_by_service": "–ü—Ä–∏–Ω—è—Ç–∞ —Å–µ—Ä–≤–∏—Å–æ–º",
  "in_work": "–í —Ä–∞–±–æ—Ç–µ",
  "done": "–ó–∞–≤–µ—Ä—à–µ–Ω–∞",
  "cancelled": "–û—Ç–º–µ–Ω–µ–Ω–∞",
  "rejected_by_service": "–û—Ç–∫–ª–æ–Ω–µ–Ω–∞ —Å–µ—Ä–≤–∏—Å–æ–º"
} %}

{% set offer_status_labels = {
  "new": "–ù–æ–≤—ã–π",
  "accepted": "–ü—Ä–∏–Ω—è—Ç",
  "rejected": "–û—Ç–∫–ª–æ–Ω—ë–Ω"
} %}

<div class="max-w-4xl mx-auto px-4 py-6">

  <div class="flex items-center justify-between gap-3 mb-4">
    <a href="/me/requests" class="text-sm text-slate-300 hover:text-slate-100 transition">‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞—è–≤–∫–∞–º</a>
    <div class="text-xs text-slate-400">
      –ó–∞—è–≤–∫–∞ ‚Ññ<span class="text-slate-200 font-semibold">{{ request_obj.id }}</span>
    </div>
  </div>

  <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 mb-5">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h1 class="text-lg font-semibold text-slate-100">–ó–∞—è–≤–∫–∞ ‚Ññ{{ request_obj.id }}</h1>
        <div class="mt-1 text-xs text-slate-400">
          –°—Ç–∞—Ç—É—Å:
          <span class="text-slate-200 font-semibold">
            {{ request_status_labels.get(request_obj.status, request_obj.status) }}
          </span>
        </div>
      </div>

      {% if car %}
        <div class="text-right">
          <div class="text-xs text-slate-400">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</div>
          <div class="text-sm text-slate-100 font-semibold">
            {{ car.brand }} {{ car.model }} {% if car.year %}({{ car.year }}){% endif %}
          </div>
          {% if car.plate_number %}
            <div class="text-xs text-slate-400 mt-0.5">{{ car.plate_number }}</div>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4 pt-4 border-t border-slate-800/70">
      <div>
        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</p>
        <p class="text-sm text-slate-200 mt-1">{{ request_obj.service_category_label or request_obj.service_category or "‚Äî" }}</p>
      </div>
      <div>
        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–†–∞–¥–∏—É—Å</p>
        <p class="text-sm text-slate-200 mt-1">{{ request_obj.radius_km or "‚Äî" }} –∫–º</p>
      </div>

      <div class="sm:col-span-2">
        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–û–ø–∏—Å–∞–Ω–∏–µ</p>
        <p class="text-sm text-slate-200 mt-1 whitespace-pre-wrap break-words">{{ request_obj.description or "‚Äî" }}</p>
      </div>

      <div>
        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–õ–æ–∫–∞—Ü–∏—è</p>
        <p class="text-sm text-slate-200 mt-1 break-words">
          {{ request_obj.address_text or request_obj.address or "‚Äî" }}
        </p>
      </div>

      <div>
        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–≠–≤–∞–∫—É–∞—Ü–∏—è / –í—ã–µ–∑–¥</p>
        <p class="text-sm text-slate-200 mt-1">
          {% if request_obj.need_tow_truck or request_obj.need_mobile_master or request_obj.need_tow %}–î–∞{% else %}–ù–µ—Ç{% endif %}
        </p>
      </div>
    </div>
  </div>

  {% if sent_all %}
    <div class="rounded-2xl border border-emerald-500/30 bg-emerald-900/10 p-4 mb-4">
      <p class="text-sm text-emerald-200 font-semibold">‚úÖ –ó–∞—è–≤–∫–∞ —Ä–∞–∑–æ—Å–ª–∞–Ω–∞ –≤—Å–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–º –°–¢–û</p>
      <p class="mt-1 text-xs text-emerald-200/70">
        –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–∫–ª–∏–∫–∏ ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ –Ω–∏–∂–µ.
      </p>
    </div>
  {% endif %}

  {# --- –í—ã—á–∏—Å–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —á–∞—Ç–∞ --- #}
  {% set chat_sc_id = None %}
  {% if request_obj.service_center_id %}
    {% set chat_sc_id = request_obj.service_center_id %}
  {% endif %}
  {% if offers %}
    {% for off in offers %}
      {% if off.status == "accepted" %}
        {% set chat_sc_id = off.service_center_id %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if chat_sc_id %}
    {# ‚úÖ –í–ê–ñ–ù–û: service_centers_by_id —Ö—Ä–∞–Ω–∏—Ç—Å—è –ø–æ int-–∫–ª—é—á–∞–º (—Ä–æ—É—Ç–µ—Ä —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç int(sc_id)) #}
    {% set chosen_sc = service_centers_by_id.get(chat_sc_id|int) if chat_sc_id else None %}

    <div class="rounded-2xl border border-emerald-500/30 bg-emerald-900/10 p-4 mb-4">
      <p class="text-sm text-emerald-200 font-semibold">‚úÖ –°–µ—Ä–≤–∏—Å –≤—ã–±—Ä–∞–Ω</p>

      <div class="mt-2 text-[11px] text-emerald-200/80">
        {% if chosen_sc %}
          <div class="text-sm text-slate-100 font-semibold">
            {{ chosen_sc.get("name") or ("–°–µ—Ä–≤–∏—Å #" ~ (chat_sc_id|string)) }}
          </div>
          {% if chosen_sc.get("address") %}
            <div class="text-xs text-slate-300 mt-0.5">
              <span class="text-slate-400">–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–∏—Å–∞:</span> {{ chosen_sc.get("address") or chosen_sc.get("address_text") or chosen_sc.get("address_full") }}
            </div>
          {% endif %}
            {% set sc_lat = chosen_sc.get("latitude") or chosen_sc.get("lat") %}
            {% set sc_lon = chosen_sc.get("longitude") or chosen_sc.get("lon") %}
            {% if sc_lat and sc_lon %}
              <div class="text-xs text-slate-400 mt-1">
                <a class="underline underline-offset-2 hover:text-slate-200" target="_blank" rel="noopener noreferrer"
                   href="https://www.google.com/maps?q={{ sc_lat }},{{ sc_lon }}">üó∫ –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</a>
              </div>
            {% endif %}
          {% if chosen_sc.get("phone") %}
            <div class="text-xs text-slate-400 mt-0.5">
              –¢–µ–ª–µ—Ñ–æ–Ω: {{ chosen_sc.get("phone") }}
            </div>
          {% endif %}
        {% else %}
          –í—ã–±—Ä–∞–Ω —Å–µ—Ä–≤–∏—Å #{{ chat_sc_id }}.
        {% endif %}

        <div class="mt-1 text-[11px] text-emerald-200/70">
          –ö–Ω–æ–ø–∫–∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Å–∫—Ä—ã—Ç—ã, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞.
        </div>
      </div>

      <div class="mt-3">
        <button type="button"
                onclick="sendChatLinkAndClose('/me/requests/{{ request_obj.id }}/send-chat-link?service_center_id={{ chat_sc_id }}', '{{ bot_username }}')"
                class="inline-flex items-center gap-2 rounded-full bg-slate-800 px-5 py-2 text-xs font-semibold text-slate-100 border border-slate-700 hover:bg-slate-700 transition">
          üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram
        </button>
        <p class="mt-2 text-[11px] text-slate-400">
          –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–æ—Ç–µ —Å –∫–Ω–æ–ø–∫–æ–π, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–∫—Ä–æ–µ—Ç –ø—Ä—è–º–æ–π —á–∞—Ç.
        </p>
      </div>
    </div>
  {% endif %}

  {% if offers %}
    <div class="space-y-3">
      {% for offer in offers %}
        {% set sc = service_centers_by_id.get(offer.service_center_id|int) %}
        <div class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="space-y-2 min-w-0">
            <p class="text-sm font-semibold text-slate-100">
              {% if sc %}
                {{ sc.get("name") or ("–°–µ—Ä–≤–∏—Å #" ~ (offer.service_center_id|string)) }}
              {% else %}
                –°–µ—Ä–≤–∏—Å #{{ offer.service_center_id }}
              {% endif %}
            </p>

            {% if sc and sc.get("address") %}
              <p class="text-xs text-slate-400 break-words">
                <span class="text-slate-500">–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–∏—Å–∞:</span> {{ sc.get("address") or sc.get("address_text") or sc.get("address_full") }}
              </p>
            {% endif %}
              {% set sc_lat = sc.get("latitude") or sc.get("lat") %}
              {% set sc_lon = sc.get("longitude") or sc.get("lon") %}
              {% if sc_lat and sc_lon %}
                <p class="text-xs text-slate-400 break-words">
                  <a class="underline underline-offset-2 hover:text-slate-200" target="_blank" rel="noopener noreferrer"
                     href="https://www.google.com/maps?q={{ sc_lat }},{{ sc_lon }}">üó∫ –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</a>
                </p>
              {% endif %}

            <div class="text-xs text-slate-300 space-y-1">
              <div>
                <span class="text-slate-400">–¶–µ–Ω–∞:</span>
                {% if offer.price_text %} {{ offer.price_text }}
                {% elif offer.price is not none %} {{ offer.price }}
                {% else %} –Ω–µ —É–∫–∞–∑–∞–Ω–∞
                {% endif %}
              </div>

              <div>
                <span class="text-slate-400">–°—Ä–æ–∫:</span>
                {% if offer.eta_text %} {{ offer.eta_text }}
                {% elif offer.eta_hours is not none %} ~{{ offer.eta_hours }} —á.
                {% else %} –Ω–µ —É–∫–∞–∑–∞–Ω
                {% endif %}
              </div>

              <div>
                <span class="text-slate-400">–°—Ç–∞—Ç—É—Å:</span>
                {{ offer_status_labels.get(offer.status, offer.status) }}
              </div>
            </div>

            {% if offer.comment %}
              <p class="text-xs text-slate-400 whitespace-pre-wrap">{{ offer.comment }}</p>
            {% endif %}

            {% if offer.status == "accepted" %}
              <span class="inline-flex items-center rounded-full bg-emerald-500/15 px-3 py-1 text-[11px] font-semibold text-emerald-200 border border-emerald-500/30">
                ‚úÖ –í—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ñ—Ñ–µ—Ä
              </span>
            {% endif %}
          </div>

          <div class="flex flex-wrap gap-2 text-xs">
            <button type="button"
                    onclick="sendChatLinkAndClose('/me/requests/{{ request_obj.id }}/send-chat-link?service_center_id={{ offer.service_center_id }}', '{{ bot_username }}')"
                    class="inline-flex items-center gap-2 rounded-full bg-slate-800 px-4 py-2 font-semibold text-slate-100 border border-slate-700 hover:bg-slate-700 transition">
              üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram
            </button>

            {% if offer.status != "accepted" and not chat_sc_id %}
              <form method="post" action="/me/requests/{{ request_obj.id }}/offers/{{ offer.id }}/accept">
                <button type="submit"
                        class="inline-flex items-center gap-2 rounded-full bg-emerald-600 px-4 py-2 font-semibold text-white hover:bg-emerald-500 transition">
                  ‚úÖ –ü—Ä–∏–Ω—è—Ç—å
                </button>
              </form>

              <form method="post" action="/me/requests/{{ request_obj.id }}/offers/{{ offer.id }}/reject">
                <button type="submit"
                        class="inline-flex items-center gap-2 rounded-full bg-rose-600 px-4 py-2 font-semibold text-white hover:bg-rose-500 transition">
                  ‚úñ –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                </button>
              </form>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6 text-slate-200">
      –û—Ç–∫–ª–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.
    </div>
  {% endif %}

</div>

<script>
  function sendChatLinkAndClose(url, botUsername) {
    fetch(url, { method: "POST" })
      .then(() => {
        if (window.Telegram && window.Telegram.WebApp) {
          window.Telegram.WebApp.close();
        } else {
          alert("–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞.");
        }
      })
      .catch(() => alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."));
  }
</script>

{% endblock %}
