{% extends "layout/base.html" %}

{% block title %}–ó–∞—è–≤–∫–∞ ‚Ññ{{ request_obj.id }}{% endblock %}

{% block content %}

{# --- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏, —á—Ç–æ–±—ã —à–∞–±–ª–æ–Ω –ù–ï –ü–ê–î–ê–õ –µ—Å–ª–∏ —Ä–æ—É—Ç–µ—Ä –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ -- #}
{% set status_labels = {
  "new": "–ù–æ–≤–∞—è",
  "sent": "–†–∞–∑–æ—Å–ª–∞–Ω–∞ –°–¢–û",
  "accepted_by_service": "–ü—Ä–∏–Ω—è—Ç–∞ –°–¢–û",
  "in_work": "–í —Ä–∞–±–æ—Ç–µ",
  "done": "–ó–∞–≤–µ—Ä—à–µ–Ω–∞",
  "cancelled": "–û—Ç–º–µ–Ω–µ–Ω–∞",
  "rejected_by_service": "–û—Ç–∫–ª–æ–Ω–µ–Ω–∞ –°–¢–û"
} %}

{% set status_badges = {
  "new": "bg-slate-700/60 text-slate-100 border-slate-600",
  "sent": "bg-blue-900/30 text-blue-200 border-blue-700/40",
  "accepted_by_service": "bg-emerald-900/30 text-emerald-200 border-emerald-700/40",
  "in_work": "bg-amber-900/30 text-amber-200 border-amber-700/40",
  "done": "bg-emerald-900/40 text-emerald-200 border-emerald-700/50",
  "cancelled": "bg-red-900/30 text-red-200 border-red-700/40",
  "rejected_by_service": "bg-red-900/30 text-red-200 border-red-700/40"
} %}

{% set service_category_labels = {
  "mechanic": "–ê–≤—Ç–æ–º–µ—Ö–∞–Ω–∏–∫–∞",
  "tire": "–®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂",
  "body": "–ö—É–∑–æ–≤–Ω–æ–π —Ä–µ–º–æ–Ω—Ç",
  "electric": "–ê–≤—Ç–æ—ç–ª–µ–∫—Ç—Ä–∏–∫–∞",
  "diagnostic": "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞",
  "aggregates": "–ê–≥—Ä–µ–≥–∞—Ç—ã",
  "carwash_detailing": "–ú–æ–π–∫–∞, –¥–µ—Ç–µ–π–ª–∏–Ω–≥, —Ö–∏–º—á–∏—Å—Ç–∫–∞",
  "maintenance": "–¢–û / –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ",
  "road_help": "–ü–æ–º–æ—â—å –Ω–∞ –¥–æ—Ä–æ–≥–µ",
  "evacuation": "–≠–≤–∞–∫—É–∞—Ü–∏—è",
  "fuel_delivery": "–ü–æ–¥–≤–æ–∑ —Ç–æ–ø–ª–∏–≤–∞",
  "car_lockout": "–í—Å–∫—Ä—ã—Ç–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è",
  "jump_start": "–ü—Ä–∏–∫—É—Ä–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å"
} %}

{% set req_lat = request_obj.latitude or request_obj.lat %}
{% set req_lon = request_obj.longitude or request_obj.lon %}
{% set has_geo = true if (req_lat and req_lon) else false %}

{# –ê–≤—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∫–∞–∫ request_obj.car_id, —Ç–∞–∫ –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º car #}
{% set req_car_id = request_obj.car_id %}
{% if not req_car_id and car and car.id is defined %}
  {% set req_car_id = car.id %}
{% endif %}
{% set has_car = true if req_car_id else false %}

<div class="max-w-4xl mx-auto p-4">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
    <a href="/me/requests" class="text-sm text-slate-300 hover:text-slate-100 transition">‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞—è–≤–∫–∞–º</a>
    <div class="text-xs text-slate-400">
      –ó–∞—è–≤–∫–∞ ‚Ññ<span class="font-semibold text-slate-200">{{ request_obj.id }}</span>
    </div>
  </div>

  <div class="rounded-3xl border border-slate-800 bg-slate-950/60 p-5 shadow-xl shadow-black/20">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-lg font-bold text-slate-100 mb-1">
          {{ service_category_labels.get(request_obj.service_category, request_obj.service_category) }}
        </div>
        <div class="text-xs text-slate-400">
          –°–æ–∑–¥–∞–Ω–æ: {{ request_obj.created_at or "" }}
        </div>
      </div>

      {% set st = request_obj.status or "new" %}
      <span class="text-xs px-3 py-1 rounded-full border {{ status_badges.get(st, 'bg-slate-800 text-slate-200 border-slate-700') }}">
        {{ status_labels.get(st, st) }}
      </span>
    </div>

    <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
        <div class="text-[11px] uppercase tracking-wider text-slate-400 mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
        <div class="text-sm font-semibold text-slate-100">
          {{ service_category_labels.get(request_obj.service_category, request_obj.service_category) }}
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
        <div class="text-[11px] uppercase tracking-wider text-slate-400 mb-1">–†–∞–¥–∏—É—Å</div>
        <div class="text-sm font-semibold text-slate-100">
          {{ request_obj.radius_km }} –∫–º
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 sm:col-span-2">
        <div class="text-[11px] uppercase tracking-wider text-slate-400 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</div>
        <div class="text-sm text-slate-100 whitespace-pre-line">
          {{ request_obj.description or "‚Äî" }}
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 sm:col-span-2">
        <div class="text-[11px] uppercase tracking-wider text-slate-400 mb-1">–õ–æ–∫–∞—Ü–∏—è</div>
        {% if has_geo %}
          <div class="text-sm text-slate-100">
            {{ request_obj.address_text or "–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ" }}
          </div>
          <a class="text-xs text-blue-300 hover:text-blue-200 underline"
             target="_blank"
             href="https://maps.google.com/?q={{ req_lat }},{{ req_lon }}">
            –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
          </a>
        {% else %}
          <div class="text-sm text-slate-100">‚Äî</div>
        {% endif %}
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
        <div class="text-[11px] uppercase tracking-wider text-slate-400 mb-1">–≠–≤–∞–∫—É–∞—Ü–∏—è / –≤—ã–µ–∑–¥</div>
        <div class="text-sm font-semibold text-slate-100">
          {% if request_obj.is_car_movable is not none %}
            {% if request_obj.is_car_movable %}–ù–µ—Ç{% else %}–î–∞{% endif %}
          {% else %}
            ‚Äî
          {% endif %}
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
        <div class="text-[11px] uppercase tracking-wider text-slate-400 mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</div>
        <div class="text-sm font-semibold text-slate-100">
          {% if request_obj.hide_phone %}–°–∫—Ä—ã—Ç{% else %}–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è{% endif %}
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 sm:col-span-2">
        <div class="text-[11px] uppercase tracking-wider text-slate-400 mb-1">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</div>
        {% if has_car and car %}
          <div class="text-sm font-semibold text-slate-100">
            {{ car.brand or "" }} {{ car.model or "" }}
            {% if car.plate_number %}‚Ä¢ {{ car.plate_number }}{% endif %}
          </div>
        {% elif has_car %}
          <div class="text-sm text-slate-100">–ê–≤—Ç–æ –≤—ã–±—Ä–∞–Ω–æ</div>
        {% else %}
          <div class="text-sm text-slate-100">–ê–≤—Ç–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</div>
          <a href="/me/garage" class="text-xs text-blue-300 hover:text-blue-200 underline">–û—Ç–∫—Ä—ã—Ç—å –≥–∞—Ä–∞–∂</a>
        {% endif %}
      </div>
    </div>
  </div>

  {# --- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô --- #}
  {% if (request_obj.status or "new") == "new" %}
    <div class="rounded-2xl border border-slate-800 bg-slate-900/50 p-5 mb-5">
      <div class="flex flex-col gap-2">
        <div class="text-sm font-semibold text-slate-100">
          –î–∞–ª—å—à–µ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏
        </div>
        <div class="text-xs text-slate-400">
          –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –°–¢–û –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ —Ä–∞–∑–æ—Å–ª–∞—Ç—å –≤—Å–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–º –≤ —Ä–∞–¥–∏—É—Å–µ.
        </div>

        {# –ë–ª–æ–∫-–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –±–µ–∑ –∞–≤—Ç–æ –∏/–∏–ª–∏ –≥–µ–æ –Ω–µ –¥–∞—ë–º –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ #}
        {% if not has_car or not has_geo %}
          <div class="mt-3 rounded-xl border border-amber-500/30 bg-amber-900/10 p-4">
            <div class="text-sm font-semibold text-amber-200 mb-1">–ù—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</div>
            <div class="text-xs text-slate-300">
              {% if not has_car %}‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å (–∏–∑ –≥–∞—Ä–∞–∂–∞)<br>{% endif %}
              {% if not has_geo %}‚Ä¢ –£–∫–∞–∂–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é (—Ç–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ){% endif %}
            </div>

            <div class="mt-3 flex flex-col sm:flex-row gap-2">
              {% if not has_car %}
                <a href="/me/garage"
                   class="inline-flex items-center justify-center rounded-xl bg-slate-100 text-slate-900 px-4 py-2 text-sm font-semibold">
                  üöó –û—Ç–∫—Ä—ã—Ç—å –≥–∞—Ä–∞–∂
                </a>
              {% endif %}

              <a href="/me/requests"
                 class="inline-flex items-center justify-center rounded-xl bg-slate-800 text-slate-100 px-4 py-2 text-sm font-semibold border border-slate-700">
                ‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞—è–≤–∫–∞–º
              </a>
            </div>

            <div class="mt-3 text-[11px] text-slate-400">
              –ï—Å–ª–∏ —ç—Ç–∞ –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –±–µ–∑ –∞–≤—Ç–æ/–≥–µ–æ ‚Äî —É–¥–æ–±–Ω–µ–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥ –∏ —Å–æ–∑–¥–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–∏–Ω–∞—á–µ –°–¢–û –Ω–µ —Å–º–æ–≥—É—Ç –µ—ë –ø–æ–ª—É—á–∏—Ç—å).
            </div>
          </div>
        {% endif %}

        <div class="mt-4 flex flex-col gap-2">
          <a href="/me/requests/{{ request_obj.id }}/choose-service"
             class="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold border border-slate-700
                    {% if has_car and has_geo %}bg-slate-900 text-slate-100 hover:bg-slate-800{% else %}bg-slate-900/40 text-slate-500 pointer-events-none{% endif %}">
            üßæ –í—ã–±—Ä–∞—Ç—å –°–¢–û –∏–∑ —Å–ø–∏—Å–∫–∞
          </a>

          {# –†–∞–∑–æ—Å–ª–∞—Ç—å –≤—Å–µ–º (POST —Å JS, —á—Ç–æ–±—ã Telegram WebView –Ω–µ –ø–æ–¥–≤–∏—Å–∞–ª) #}
          <button type="button"
                  data-request-id="{{ request_obj.id }}"
                  class="send-to-all-btn inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold border border-slate-700
                         {% if has_car and has_geo %}bg-slate-900 text-slate-100 hover:bg-slate-800{% else %}bg-slate-900/40 text-slate-500 pointer-events-none{% endif %}">
            üì§ –†–∞–∑–æ—Å–ª–∞—Ç—å –≤—Å–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–º
          </button>

          <div class="text-[11px] text-slate-500">
            {% if has_car and has_geo %}
              –°–¢–û –ø–æ–ª—É—á–∞—Ç –∑–∞—è–≤–∫—É –ø–æ –≤–∞—à–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º –∏ —Å–º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫.
            {% else %}
              –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–≤—Ç–æ –∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é ‚Äî —Ç–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∫–∞.
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {% if sent_all %}
    <div class="rounded-2xl border border-emerald-500/30 bg-emerald-900/10 p-4 mb-4">
      <p class="text-sm text-emerald-200 font-semibold mb-1">‚úÖ –ó–∞—è–≤–∫–∞ —Ä–∞–∑–æ—Å–ª–∞–Ω–∞</p>
      <p class="text-xs text-slate-300">–û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–∫–ª–∏–∫–æ–≤ –æ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –°–¢–û. –û–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –Ω–∏–∂–µ.</p>
    </div>
  {% endif %}

  {# --- –û–¢–ö–õ–ò–ö–ò --- #}
  <div class="rounded-3xl border border-slate-800 bg-slate-950/60 p-5">
    <div class="flex items-center justify-between">
      <div class="text-sm font-semibold text-slate-100">–û—Ç–∫–ª–∏–∫–∏ –°–¢–û</div>
      <div class="text-xs text-slate-400">{{ offers|length }} —à—Ç.</div>
    </div>

    {% if offers %}
      <div class="mt-4 space-y-3">
        {% for offer in offers %}
          <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm font-semibold text-slate-100">
                  {{ offer.service_center_name or ("–°–¢–û #" ~ offer.service_center_id) }}
                </div>
                <div class="text-xs text-slate-400">
                  {% if offer.price is not none %}–¶–µ–Ω–∞: <span class="text-slate-200 font-semibold">{{ offer.price }}</span>{% endif %}
                  {% if offer.days is not none %} ‚Ä¢ –°—Ä–æ–∫: <span class="text-slate-200 font-semibold">{{ offer.days }}</span> –¥–Ω.{% endif %}
                </div>
              </div>

              {% if offer.status %}
                <span class="text-[11px] px-2 py-1 rounded-full border border-slate-700 bg-slate-800/60 text-slate-200">
                  {{ offer.status }}
                </span>
              {% endif %}
            </div>

            {% if offer.comment %}
              <div class="mt-3 text-sm text-slate-100 whitespace-pre-line">{{ offer.comment }}</div>
            {% endif %}

            {% if (request_obj.status in ["sent", "new"]) and (offer.status != "accepted") %}
              <form method="post" action="/me/offers/{{ offer.id }}/accept" class="mt-4">
                <button type="submit"
                        class="w-full rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 text-sm font-semibold">
                  ‚úÖ –ü—Ä–∏–Ω—è—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                </button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="mt-4 text-sm text-slate-300">
        –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∫–ª–∏–∫–æ–≤. –ï—Å–ª–∏ –≤—ã –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∑–∞—è–≤–∫—É –°–¢–û ‚Äî —Å–¥–µ–ª–∞–π—Ç–µ —ç—Ç–æ –≤—ã—à–µ.
      </div>
    {% endif %}
  </div>

</div>

<script>
  async function sendToAllWithFallback(requestId, btn) {
    if (!requestId) return;

    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º...";

    try {
      const resp = await fetch(`/me/requests/${requestId}/send-to-all`, {
        method: "POST",
        headers: { "X-Requested-With": "fetch" },
        credentials: "same-origin",
      });

      if (!resp.ok) {
        // fallback: –æ–±—ã—á–Ω—ã–π submit —á–µ—Ä–µ–∑ —Å–∫—Ä—ã—Ç—É—é —Ñ–æ—Ä–º—É
        const form = document.createElement("form");
        form.method = "post";
        form.action = `/me/requests/${requestId}/send-to-all`;
        document.body.appendChild(form);
        form.submit();
        return;
      }

      // —É—Å–ø–µ—à–Ω—ã–π fetch ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
      window.location.reload();
    } catch (e) {
      // fallback: –æ–±—ã—á–Ω—ã–π submit
      const form = document.createElement("form");
      form.method = "post";
      form.action = `/me/requests/${requestId}/send-to-all`;
      document.body.appendChild(form);
      form.submit();
    } finally {
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = originalText;
      }, 1500);
    }
  }

  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".send-to-all-btn");
    if (!btn) return;

    const requestId = btn.getAttribute("data-request-id");
    sendToAllWithFallback(requestId, btn);
  });
</script>

{# Sticky footer: —á—Ç–æ–±—ã –≤ Telegram WebView –≤—Å–µ–≥–¥–∞ –±—ã–ª –ø—É—Ç—å "–Ω–∞–∑–∞–¥" #}
<div class="fixed bottom-0 left-0 right-0 z-50">
  <div class="max-w-4xl mx-auto px-4 pb-4">
    <div class="rounded-2xl border border-slate-800 bg-slate-950/80 backdrop-blur px-4 py-3 flex items-center justify-between">
      <a href="/me/requests" class="text-sm font-semibold text-slate-100 hover:text-white">‚Üê –ù–∞–∑–∞–¥</a>
      <a href="/me/dashboard" class="text-sm font-semibold text-slate-300 hover:text-white">üè† –í –º–µ–Ω—é</a>
    </div>
  </div>
</div>

<div class="h-20"></div>

{% endblock %}
