{% extends "layout/base.html" %}

{% block title %}–ó–∞—è–≤–∫–∞ ‚Ññ{{ request_obj.id }} ‚Äî CarBot{% endblock %}

{% block content %}
<div class="mt-8 space-y-6">
    <a href="/me/requests" class="text-xs text-slate-400 hover:text-emerald-400 transition">
        ‚Üê –ö–æ –≤—Å–µ–º –∑–∞—è–≤–∫–∞–º
    </a>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ -->
    <div class="relative">
        <div class="absolute inset-0 rounded-3xl bg-slate-900/70 backdrop-blur-2xl border border-slate-800"></div>

        <div class="relative z-10 p-6 md:p-8 space-y-6">
            <!-- –®–∞–ø–∫–∞: –∞–≤—Ç–æ + —Å—Ç–∞—Ç—É—Å -->
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                <div class="space-y-2">
                    <p class="text-xs uppercase tracking-[0.25em] text-emerald-400/80">
                        –ó–∞—è–≤–∫–∞ ‚Ññ{{ request_obj.id }}
                    </p>

                    <div class="flex items-center gap-2 text-sm font-semibold text-slate-100">
                        {% set cat = request_obj.service_category %}
                        {% if cat == "sto" %}
                        <span class="text-lg">üõ†</span>
                        {% elif cat == "maint" %}
                        <span class="text-lg">üß∞</span>
                        {% elif cat == "mechanic" or cat == "mech" %}
                        <span class="text-lg">‚öôÔ∏è</span>
                        {% elif cat == "electric" or cat == "elec" %}
                        <span class="text-lg">üîå</span>
                        {% elif cat == "body" or cat == "paint" %}
                        <span class="text-lg">üé®</span>
                        {% elif cat == "tire" %}
                        <span class="text-lg">üõû</span>
                        {% elif cat == "wash" %}
                        <span class="text-lg">üöø</span>
                        {% elif cat == "agg" %}
                        <span class="text-lg">‚ö°</span>
                        {% else %}
                        <span class="text-lg">üìç</span>
                        {% endif %}
                        <span>{{ request_obj.service_category_label or "–£—Å–ª—É–≥–∞" }}</span>
                    </div>

                    {% if car %}
                    <div
                        class="mt-2 rounded-2xl border border-slate-800 bg-slate-950/80 px-4 py-3 flex items-center justify-between gap-3">
                        <div class="flex items-center gap-3">
                            <div
                                class="flex h-9 w-9 items-center justify-center rounded-2xl bg-slate-800 border border-slate-700 text-lg">
                                üöó
                            </div>
                            <div class="text-xs text-slate-300">
                                <div class="text-sm text-slate-100 font-semibold">
                                    {{ car.brand or "–ê–≤—Ç–æ" }}
                                    {% if car.model %} {{ car.model }}{% endif %}
                                </div>
                                <div>
                                    {% if car.year %}{{ car.year }} –≥.–≤.{% else %}–ì–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω{% endif %}
                                    {% if car.license_plate %} ¬∑ ‚Ññ {{ car.license_plate }}{% endif %}
                                </div>
                            </div>
                        </div>
                        <a href="/me/cars/{{ car.id }}"
                            class="inline-flex items-center gap-1 text-[11px] text-slate-400 hover:text-emerald-300 transition">
                            –û—Ç–∫—Ä—ã—Ç—å –∞–≤—Ç–æ
                            <span class="text-base leading-none">‚Üí</span>
                        </a>
                    </div>
                    {% endif %}
                </div>

                <!-- –°—Ç–∞—Ç—É—Å / —Ç–∞–π–º–ª–∞–π–Ω -->
                <div class="w-full md:w-64 space-y-3 text-xs">
                    {% set status = request_obj.status %}
                    <div class="flex flex-col items-end gap-2">
                        {% if status == "new" %}
                        <span
                            class="rounded-full bg-emerald-500/10 border border-emerald-400/70 px-3 py-1 font-semibold text-emerald-200">
                            ‚óè {{ request_obj.status_label }}
                        </span>
                        <p class="text-[11px] text-emerald-200/80 text-right">
                            –í—ã –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–ª–∏ —Å–µ—Ä–≤–∏—Å. –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–º –°–¢–û –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞.
                        </p>
                        {% elif status == "sent" %}
                        <span
                            class="rounded-full bg-sky-500/10 border border-sky-400/70 px-3 py-1 font-semibold text-sky-200">
                            ‚óè {{ request_obj.status_label }}
                        </span>
                        <p class="text-[11px] text-sky-200/80 text-right">
                            –ó–∞—è–≤–∫–∞ —Ä–∞–∑–æ—Å–ª–∞–Ω–∞ —Å–µ—Ä–≤–∏—Å–∞–º. –û–∂–∏–¥–∞–µ–º –æ—Ç–∫–ª–∏–∫–æ–≤.
                        </p>
                        {% elif status == "accepted_by_service" %}
                        <span
                            class="rounded-full bg-amber-500/10 border border-amber-400/70 px-3 py-1 font-semibold text-amber-200">
                            ‚óè {{ request_obj.status_label }}
                        </span>
                        <p class="text-[11px] text-amber-200/80 text-right">
                            –û–¥–∏–Ω –∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–∏–Ω—è–ª –≤–∞—à—É –∑–∞—è–≤–∫—É.
                        </p>
                        {% elif status == "in_work" %}
                        <span
                            class="rounded-full bg-amber-500/10 border border-amber-400/70 px-3 py-1 font-semibold text-amber-200">
                            ‚óè {{ request_obj.status_label }}
                        </span>
                        <p class="text-[11px] text-amber-200/80 text-right">
                            –†–∞–±–æ—Ç–∞ –ø–æ –∑–∞—è–≤–∫–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.
                        </p>
                        {% elif status == "done" %}
                        <span
                            class="rounded-full bg-emerald-500/15 border border-emerald-400/80 px-3 py-1 font-semibold text-emerald-200">
                            ‚óè {{ request_obj.status_label }}
                        </span>
                        <p class="text-[11px] text-emerald-200/90 text-right">
                            –ó–∞—è–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞. –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ—Ü–µ–Ω–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –∏ –±–æ–Ω—É—Å—ã.
                        </p>
                        {% elif status == "cancelled" %}
                        <span
                            class="rounded-full bg-slate-700/80 border border-slate-500 px-3 py-1 font-semibold text-slate-200">
                            ‚óè {{ request_obj.status_label }}
                        </span>
                        <p class="text-[11px] text-slate-300/90 text-right">
                            –ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.
                        </p>
                        {% elif status == "rejected_by_service" %}
                        <span
                            class="rounded-full bg-red-500/15 border border-red-400/80 px-3 py-1 font-semibold text-red-100">
                            ‚óè {{ request_obj.status_label }}
                        </span>
                        <p class="text-[11px] text-red-100/90 text-right">
                            –°–µ—Ä–≤–∏—Å –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞—è–≤–∫—É. –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É.
                        </p>
                        {% else %}
                        <span
                            class="rounded-full bg-slate-800/80 border border-slate-600 px-3 py-1 font-semibold text-slate-200">
                            ‚óè {{ request_obj.status_label or status }}
                        </span>
                        {% endif %}
                    </div>

                    <!-- –ú–∏–Ω–∏-—Ç–∞–π–º–ª–∞–π–Ω -->
                    <div class="mt-1 space-y-1.5">
                        {% set steps = [
                        ("new", "–ù–æ–≤–∞—è"),
                        ("sent", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –°–¢–û"),
                        ("accepted_by_service", "–ü—Ä–∏–Ω—è—Ç–∞ —Å–µ—Ä–≤–∏—Å–æ–º"),
                        ("in_work", "–í —Ä–∞–±–æ—Ç–µ"),
                        ("done", "–ó–∞–≤–µ—Ä—à–µ–Ω–∞"),
                        ] %}
                        <div class="flex flex-col gap-1.5">
                            {% for code, label in steps %}
                            {% set reached =
                            (status == code)
                            or (status == "sent" and code in ["new", "sent"])
                            or (status == "accepted_by_service" and code in ["new", "sent", "accepted_by_service"])
                            or (status == "in_work" and code in ["new", "sent", "accepted_by_service", "in_work"])
                            or (status == "done" and code in ["new", "sent", "accepted_by_service", "in_work", "done"])
                            %}
                            <div class="flex items-center gap-2 text-[11px]">
                                <div class="h-1 w-6 rounded-full
                                                {% if reached %}bg-emerald-400{% else %}bg-slate-700{% endif %}"></div>
                                <span class="{% if reached %}text-emerald-200{% else %}text-slate-500{% endif %}">
                                    {{ label }}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ê–¥—Ä–µ—Å + –∫–∞—Ä—Ç–∞ + –æ–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="grid gap-4 md:grid-cols-[minmax(0,1.3fr)_minmax(0,1.1fr)]">
                <div class="space-y-4">
                    <div class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 space-y-2">
                        <p class="text-xs font-semibold text-slate-300">
                            –ê–¥—Ä–µ—Å / —Ä–∞–π–æ–Ω
                        </p>
                        <p class="text-sm text-slate-100">
                            {{ req.address_text or "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω" }}
                        </p>

                        <p class="text-[11px] text-slate-500">
                            –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –∏–∑ –±–æ—Ç–∞.
                        </p>
                    </div>

                    <div class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 space-y-2">
                        <p class="text-xs font-semibold text-slate-300">
                            –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
                        </p>
                        <p class="text-sm text-slate-100 whitespace-pre-wrap">
                            {{ request_obj.description }}
                        </p>
                        {% if request_obj.is_car_movable is not none %}
                        <p class="text-[11px] text-slate-500">
                            {% if request_obj.is_car_movable %}
                            –ê–≤—Ç–æ–º–æ–±–∏–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–¥–≤–∏–≥–∞—Ç—å—Å—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.
                            {% else %}
                            –ê–≤—Ç–æ–º–æ–±–∏–ª—å –Ω–µ –Ω–∞ —Ö–æ–¥—É ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è —ç–≤–∞–∫—É–∞—Ç–æ—Ä –∏–ª–∏ –≤—ã–µ–∑–¥–Ω–æ–π –º–∞—Å—Ç–µ—Ä.
                            {% endif %}
                            {% if request_obj.radius_km %}
                            –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞: {{ request_obj.radius_km }} –∫–º.
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if request_obj.hide_phone %}
                        <p class="text-[11px] text-amber-200/90">
                            –¢–µ–ª–µ—Ñ–æ–Ω —Å–∫—Ä—ã—Ç –æ—Ç —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–æ —è–≤–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è.
                        </p>
                        {% endif %}
                    </div>
                </div>

                <!-- –ö–∞—Ä—Ç–∞ -->
                <div class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 space-y-2">
                    <p class="text-xs font-semibold text-slate-300">
                        –õ–æ–∫–∞—Ü–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
                    </p>
                    <div id="request-map" data-address="{{ request_obj.address_text or '' }}"
                        class="mt-1 rounded-2xl overflow-hidden bg-slate-900 h-56 relative">
                        <div id="request-map-inner" class="absolute inset-0"></div>
                    </div>
                    <p id="map-hint" class="text-[11px] text-slate-500 mt-1">
                        –ï—Å–ª–∏ –∞–¥—Ä–µ—Å –º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω–∞ –∫–∞—Ä—Ç–µ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ.
                    </p>
                </div>
            </div>

            <!-- –î–µ–π—Å—Ç–≤–∏—è –Ω–∞–¥ –∑–∞—è–≤–∫–æ–π -->
            <div class="flex flex-wrap items-center justify-between gap-3 pt-2 border-t border-slate-800/80 mt-4">
                <div class="text-[11px] text-slate-500">
                    {% if can_distribute and status == "new" %}
                    –í—ã –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–ª–∏ —Å–ø–æ—Å–æ–± —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Ä–≤–∏—Å–∞–º–∏.
                    {% endif %}
                </div>
                <div class="flex flex-wrap gap-2">
                    {% if can_distribute and status == "new" %}
                    <form method="post" action="/me/requests/{{ request_obj.id }}/send-all">
                        <button type="submit"
                            class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-5 py-2 text-xs font-semibold text-slate-900 shadow-lg shadow-emerald-500/30 hover:bg-emerald-400 transition">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–º –°–¢–û
                        </button>
                    </form>
                    <a href="/me/requests/{{ request_obj.id }}/choose-service"
                        class="inline-flex items-center gap-2 rounded-full border border-sky-400/70 px-5 py-2 text-xs font-semibold text-sky-200 hover:bg-sky-500/10 transition">
                        –í—ã–±—Ä–∞—Ç—å –°–¢–û –∏–∑ —Å–ø–∏—Å–∫–∞
                    </a>
                    {% elif status in ["sent", "accepted_by_service", "in_work"] %}
                    <a href="/me/requests/{{ request_obj.id }}/choose-service"
                        class="inline-flex items-center gap-2 rounded-full border border-slate-600 px-5 py-2 text-xs font-semibold text-slate-200 hover:bg-slate-800 transition">
                        –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–µ—Ä–≤–∏—Å—ã –∏ –æ—Ç–∫–ª–∏–∫–∏
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- –û—Ç–∫–ª–∏–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ -->
            <div class="pt-4 space-y-3">
                <div class="flex items-center justify-between gap-3">
                    <p class="text-xs uppercase tracking-[0.22em] text-slate-400">
                        –û—Ç–∫–ª–∏–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
                    </p>
                </div>

                {% set already_chosen = (request_obj.service_center_id is not none) or (accepted_offer_id is not none)
                %}

                {% if already_chosen %}
                <div class="rounded-2xl border border-emerald-500/30 bg-emerald-900/10 p-4">
                    <p class="text-sm text-emerald-200 font-semibold">
                        ‚úÖ –°–µ—Ä–≤–∏—Å –≤—ã–±—Ä–∞–Ω
                    </p>
                    <p class="text-[11px] text-emerald-200/80">
                        {% if accepted_sc_id %}
                        –í—ã–±—Ä–∞–Ω —Å–µ—Ä–≤–∏—Å #{{ accepted_sc_id }}.
                        {% elif request_obj.service_center_id %}
                        –í—ã–±—Ä–∞–Ω —Å–µ—Ä–≤–∏—Å #{{ request_obj.service_center_id }}.
                        {% endif %}
                        –ö–Ω–æ–ø–∫–∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Å–∫—Ä—ã—Ç—ã, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞.
                    </p>
                </div>
                {% endif %}

                {% if offers %}
                <div class="space-y-3">
                    {% for offer in offers %}
                    <div
                        class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div class="space-y-1">
                            <p class="text-sm font-semibold text-slate-100">
                                –°–µ—Ä–≤–∏—Å #{{ offer.service_center_id }}
                            </p>
                            <p class="text-xs text-slate-300">
                                {% if offer.price is not none %}–¶–µ–Ω–∞: {{ offer.price }}{% else %}–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞{% endif
                                %}
                                {% if offer.eta_hours is not none %} ¬∑ –°—Ä–æ–∫: ~{{ offer.eta_hours }} —á.{% endif %}
                            </p>

                            {% if offer.comment %}
                            <p class="text-xs text-slate-400">
                                {{ offer.comment }}
                            </p>
                            {% endif %}

                            {% if offer.status %}
                            <p class="text-[11px] text-slate-500">
                                –°—Ç–∞—Ç—É—Å: {{ offer.status }}
                            </p>
                            {% endif %}

                            {% if offer.status == "accepted" %}
                            <span
                                class="inline-flex items-center rounded-full bg-emerald-500/15 px-3 py-1 text-[11px] font-semibold text-emerald-200 border border-emerald-500/30">
                                ‚úÖ –í—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ñ—Ñ–µ—Ä
                            </span>
                            {% endif %}
                        </div>

                        {% if not already_chosen %}
                        <div class="flex flex-wrap gap-2 text-xs">
                            <form method="post" action="/me/requests/{{ request_obj.id }}/offers/{{ offer.id }}/accept">
                                <button type="submit"
                                    class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 font-semibold text-slate-900 shadow-md shadow-emerald-500/30 hover:bg-emerald-400 transition">
                                    –ü—Ä–∏–Ω—è—Ç—å
                                </button>
                            </form>

                            <form method="post" action="/me/requests/{{ request_obj.id }}/offers/{{ offer.id }}/reject">
                                <button type="submit"
                                    class="inline-flex items-center gap-2 rounded-full border border-slate-600 px-4 py-2 font-semibold text-slate-200 hover:bg-slate-800 transition">
                                    –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                            </form>
                        </div>
                        {% else %}
                        <div class="text-[11px] text-slate-500">
                            –î–µ–π—Å—Ç–≤–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã ‚Äî —Å–µ—Ä–≤–∏—Å —É–∂–µ –≤—ã–±—Ä–∞–Ω.
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-sm text-slate-400">
                    –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∫–ª–∏–∫–æ–≤ –æ—Ç —Å–µ—Ä–≤–∏—Å–æ–≤. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è, –æ–Ω–∏ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –∑–¥–µ—Å—å.
                </p>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<!-- Leaflet + –≥–µ–æ–∫–æ–¥–∏–Ω–≥ —á–µ—Ä–µ–∑ Nominatim -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    (function () {
        const mapContainer = document.getElementById("request-map-inner");
        const wrapper = document.getElementById("request-map");
        const hint = document.getElementById("map-hint");

        if (!mapContainer || !wrapper) return;

        // ‚úÖ Jinja ‚Üí JS: –±–µ–∑–æ–ø–∞—Å–Ω–æ (number | null)
        const lat = {{ request_obj.latitude | tojson
    }};
    const lon = {{ request_obj.longitude | tojson }};
    const address = wrapper.dataset.address || "";

    function showError(msg) {
        if (!hint) return;
        hint.textContent = msg;
        hint.classList.remove("text-slate-500");
        hint.classList.add("text-slate-400");
    }

    function initMap(centerLat, centerLon) {
        const map = L.map(mapContainer).setView([centerLat, centerLon], 14);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);
        L.marker([centerLat, centerLon]).addTo(map);
    }

    // –ï—Å–ª–∏ –≤ –∑–∞—è–≤–∫–µ —É–∂–µ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
    if (lat !== null && lon !== null) {
        initMap(lat, lon);
        return;
    }

    // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç, –Ω–∏ –∞–¥—Ä–µ—Å–∞ ‚Äî –Ω–∏—á–µ–≥–æ —Å–¥–µ–ª–∞—Ç—å –Ω–µ–ª—å–∑—è
    if (!address) {
        showError("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –∞–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω—ã ‚Äî –∫–∞—Ä—Ç—É –ø–æ–∫–∞–∑–∞—Ç—å –Ω–µ–ª—å–∑—è.");
        return;
    }

    // –ì–µ–æ–∫–æ–¥–∏–Ω–≥ –∞–¥—Ä–µ—Å–∞ —á–µ—Ä–µ–∑ Nominatim (OpenStreetMap)
    fetch("https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(address))
        .then(function (r) { return r.json(); })
        .then(function (data) {
            if (!Array.isArray(data) || data.length === 0) {
                showError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ –∞–¥—Ä–µ—Å—É.");
                return;
            }
            const item = data[0];
            const glat = parseFloat(item.lat);
            const glon = parseFloat(item.lon);

            if (Number.isNaN(glat) || Number.isNaN(glon)) {
                showError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ –∞–¥—Ä–µ—Å—É.");
                return;
            }
            initMap(glat, glon);
        })
        .catch(function () {
            showError("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –≥–µ–æ—Å–µ—Ä–≤–∏—Å—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        });
}) ();
</script>
{% endblock %}