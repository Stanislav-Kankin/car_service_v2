{% extends "layout/base.html" %}

{% block title %}–ó–∞—è–≤–∫–∞ ‚Ññ{{ request_obj.id }}{% endblock %}

{% block content %}

{# --- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏, —á—Ç–æ–±—ã —à–∞–±–ª–æ–Ω –ù–ï –ü–ê–î–ê–õ –µ—Å–ª–∏ —Ä–æ—É—Ç–µ—Ä –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ --- #}
{% set request_status_labels = {
  "new": "–ù–æ–≤–∞—è",
  "sent": "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –°–¢–û",
  "accepted_by_service": "–ü—Ä–∏–Ω—è—Ç–∞ —Å–µ—Ä–≤–∏—Å–æ–º",
  "in_work": "–í —Ä–∞–±–æ—Ç–µ",
  "done": "–ó–∞–≤–µ—Ä—à–µ–Ω–∞",
  "cancelled": "–û—Ç–º–µ–Ω–µ–Ω–∞",
  "rejected_by_service": "–û—Ç–∫–ª–æ–Ω–µ–Ω–∞ —Å–µ—Ä–≤–∏—Å–æ–º"
} %}

{% set offer_status_labels = {
  "new": "–ù–æ–≤—ã–π",
  "accepted": "–ü—Ä–∏–Ω—è—Ç",
  "rejected": "–û—Ç–∫–ª–æ–Ω—ë–Ω"
} %}

{# –†–∞–Ω–≥–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ #}
{% set status_rank = {
  "new": 1,
  "sent": 2,
  "accepted_by_service": 3,
  "in_work": 4,
  "done": 5
} %}
{% set current_rank = status_rank.get(request_obj.status, 0) %}

<div class="max-w-5xl mx-auto px-4 py-6">
  <div class="rounded-3xl border border-slate-800 bg-slate-950/70 backdrop-blur p-5 md:p-6">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
      <div class="space-y-1">
        <div class="text-xs uppercase tracking-[0.25em] text-emerald-300/80">
          –ó–∞—è–≤–∫–∞ ‚Ññ{{ request_obj.id }}
        </div>

        <div class="text-lg md:text-xl font-semibold text-slate-100">
          {{ request_obj.service_category_label or request_obj.service_category or "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" }}
        </div>

        {% if car %}
        <div class="mt-3 rounded-2xl border border-slate-800 bg-slate-900/30 p-3 flex items-center gap-3">
          <div class="text-2xl">üöó</div>
          <div class="min-w-0">
            <div class="text-sm font-semibold text-slate-100 truncate">
              {{ car.brand }} {{ car.model }}
            </div>
            <div class="text-xs text-slate-400">
              {{ car.year }} –≥.–≤. ¬∑ ‚Ññ {{ car.plate_number or "‚Äî" }}
            </div>
          </div>
          <a href="/me/cars/{{ car.id }}" class="ml-auto text-xs text-slate-300 hover:text-slate-100 transition">
            –û—Ç–∫—Ä—ã—Ç—å –∞–≤—Ç–æ ‚Üí
          </a>
        </div>
        {% endif %}
      </div>

      <!-- Status pill -->
      <div class="rounded-full border border-slate-700 bg-slate-900/50 px-4 py-2 text-xs font-semibold text-slate-200">
        ‚óè {{ request_status_labels.get(request_obj.status, request_obj.status) }}
      </div>
    </div>

    <!-- Progress -->
    <div class="mt-6 rounded-2xl border border-slate-800 bg-slate-950/40 p-4">
      <div class="text-xs text-slate-400 mb-3">–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏</div>

      {% set steps = [
        ("new", "–ù–æ–≤–∞—è", 1),
        ("sent", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –°–¢–û", 2),
        ("accepted_by_service", "–ü—Ä–∏–Ω—è—Ç–∞ —Å–µ—Ä–≤–∏—Å–æ–º", 3),
        ("in_work", "–í —Ä–∞–±–æ—Ç–µ", 4),
        ("done", "–ó–∞–≤–µ—Ä—à–µ–Ω–∞", 5)
      ] %}

      <div class="space-y-2">
        {% for key, label, rank in steps %}
        <div class="flex items-center gap-3">
          {% if rank <= current_rank %}
            <div class="h-1.5 w-10 rounded-full bg-emerald-400"></div>
            <div class="text-xs text-emerald-200">{{ label }}</div>
          {% else %}
            <div class="h-1.5 w-10 rounded-full bg-slate-800"></div>
            <div class="text-xs text-slate-500">{{ label }}</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>

      {% if request_obj.status == "sent" %}
      <div class="mt-3 text-xs text-slate-400">
        –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–µ—Ä–≤–∏—Å–∞–º. –û–∂–∏–¥–∞–µ–º –æ—Ç–∫–ª–∏–∫–æ–≤.
      </div>
      {% endif %}
    </div>

    <!-- Main blocks -->
    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">

      <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4">
        <div class="text-xs text-slate-400 mb-2">–ú–µ—Å—Ç–æ –∑–∞—è–≤–∫–∏ (–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞)</div>
        <div class="text-sm text-slate-100">
          {{ request_obj.address_text or "‚Äî" }}
        </div>
        <div class="mt-2 text-xs text-slate-500">
          –≠—Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∞–≤—Ç–æ / –∫—É–¥–∞ –Ω—É–∂–µ–Ω —Å–µ—Ä–≤–∏—Å. –ê–¥—Ä–µ—Å–∞ –°–¢–û ‚Äî –≤ –æ—Ç–∫–ª–∏–∫–∞—Ö.
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4"
           id="request-map"
           data-address="{{ request_obj.address_text or '' }}">
        <div class="text-xs text-slate-400 mb-2">–ú–µ—Å—Ç–æ –∑–∞—è–≤–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ</div>

        <div class="rounded-xl overflow-hidden border border-slate-800 bg-slate-900/40">
          <div id="request-map-inner" style="height: 220px;"></div>
        </div>

        <div class="mt-2 text-[11px] text-slate-500" id="map-hint">
          –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—á–∫—É –∑–∞—è–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞. –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–µ—Ç ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –∞–¥—Ä–µ—Å—É (–ø—Ä–∏–º–µ—Ä–Ω–æ).
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 md:col-span-2">
        <div class="text-xs text-slate-400 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</div>
        <div class="text-sm text-slate-100 whitespace-pre-wrap">
          {{ request_obj.description or "‚Äî" }}
        </div>
        <div class="mt-2 text-xs text-slate-500">
          {% if request_obj.is_car_movable %}
            –ê–≤—Ç–æ–º–æ–±–∏–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–¥–≤–∏–≥–∞—Ç—å—Å—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.
          {% else %}
            –¢—Ä–µ–±—É–µ—Ç—Å—è —ç–≤–∞–∫—É–∞—Ü–∏—è/–≤—ã–µ–∑–¥–Ω–æ–π –º–∞—Å—Ç–µ—Ä.
          {% endif %}
          {% if request_obj.radius_km %}
            –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞: {{ request_obj.radius_km }} –∫–º.
          {% endif %}
        </div>
      </div>
    </div>

    <!-- CTA -->
    <div class="mt-6 flex items-center justify-end">
      <a href="/me/requests/{{ request_obj.id }}/choose-service"
         class="inline-flex items-center justify-center rounded-full border border-slate-700 bg-slate-900/60 px-6 py-2.5 text-xs font-semibold text-slate-100 hover:bg-slate-800 transition">
        –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–µ—Ä–≤–∏—Å—ã –∏ –æ—Ç–∫–ª–∏–∫–∏
      </a>
    </div>

    <hr class="my-8 border-slate-800">

    <!-- Offers -->
    <div class="text-xs uppercase tracking-[0.25em] text-slate-400 mb-4">
      –û—Ç–∫–ª–∏–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
    </div>

    {% set service_centers_by_id = {} %}
    {% for sc in service_centers or [] %}
      {% set _ = service_centers_by_id.update({(sc.id|string): sc}) %}
    {% endfor %}

    {# –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å (–ª–∏–±–æ request_obj.service_center_id, –ª–∏–±–æ accepted offer) #}
    {% set chat_sc_id = None %}
    {% if request_obj.service_center_id %}
      {% set chat_sc_id = request_obj.service_center_id %}
    {% else %}
      {% for off in offers or [] %}
        {% if off.status == "accepted" %}
          {% set chat_sc_id = off.service_center_id %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if chat_sc_id %}
      {% set chosen_sc = service_centers_by_id.get(chat_sc_id|string) if chat_sc_id else None %}

      <div class="rounded-2xl border border-emerald-500/30 bg-emerald-900/10 p-4 mb-4">
        <p class="text-sm text-emerald-200 font-semibold">‚úÖ –°–µ—Ä–≤–∏—Å –≤—ã–±—Ä–∞–Ω</p>

        <div class="mt-2 text-[11px] text-emerald-200/80">
          {% if chosen_sc %}
            <div class="text-sm text-slate-100 font-semibold">
              {{ chosen_sc.get("name") or ("–°–µ—Ä–≤–∏—Å #" ~ (chat_sc_id|string)) }}
            </div>
            {% if chosen_sc.get("address") %}
              <div class="text-xs text-slate-300 mt-0.5">
                <span class="text-slate-400">–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–∏—Å–∞:</span> {{ chosen_sc.get("address") }}
              </div>
            {% endif %}
            {% if chosen_sc.get("phone") %}
              <div class="text-xs text-slate-400 mt-0.5">
                –¢–µ–ª–µ—Ñ–æ–Ω: {{ chosen_sc.get("phone") }}
              </div>
            {% endif %}
          {% else %}
            –í—ã–±—Ä–∞–Ω —Å–µ—Ä–≤–∏—Å #{{ chat_sc_id }}.
          {% endif %}

          <div class="mt-1 text-[11px] text-emerald-200/70">
            –ö–Ω–æ–ø–∫–∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Å–∫—Ä—ã—Ç—ã, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞.
          </div>
        </div>

        <div class="mt-3">
          <button type="button"
                  onclick="sendChatLinkAndClose('/me/requests/{{ request_obj.id }}/send-chat-link?service_center_id={{ chat_sc_id }}', '{{ bot_username }}')"
                  class="inline-flex items-center gap-2 rounded-full bg-slate-800 px-5 py-2 text-xs font-semibold text-slate-100 border border-slate-700 hover:bg-slate-700 transition">
            üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram
          </button>
          <p class="mt-2 text-[11px] text-slate-400">
            –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–æ—Ç–µ —Å –∫–Ω–æ–ø–∫–æ–π, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–∫—Ä–æ–µ—Ç –ø—Ä—è–º–æ–π —á–∞—Ç.
          </p>
        </div>
      </div>
    {% endif %}

    {% if offers %}
      <div class="space-y-3">
        {% for offer in offers %}
          {% set sc = service_centers_by_id.get(offer.service_center_id|string) %}
          <div class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="space-y-2 min-w-0">
              <p class="text-sm font-semibold text-slate-100">
                {% if sc %}
                  {{ sc.get("name") or ("–°–µ—Ä–≤–∏—Å #" ~ (offer.service_center_id|string)) }}
                {% else %}
                  –°–µ—Ä–≤–∏—Å #{{ offer.service_center_id }}
                {% endif %}
              </p>

              {% if sc and sc.get("address") %}
                <p class="text-xs text-slate-400 break-words">
                  <span class="text-slate-500">–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–∏—Å–∞:</span> {{ sc.get("address") }}
                </p>
              {% endif %}

              <div class="text-xs text-slate-300 space-y-1">
                <div>
                  <span class="text-slate-400">–¶–µ–Ω–∞:</span>
                  {% if offer.price_text %} {{ offer.price_text }}
                  {% elif offer.price is not none %} {{ offer.price }}
                  {% else %} –Ω–µ —É–∫–∞–∑–∞–Ω–∞
                  {% endif %}
                </div>

                <div>
                  <span class="text-slate-400">–°—Ä–æ–∫:</span>
                  {% if offer.eta_text %} {{ offer.eta_text }}
                  {% elif offer.eta_hours is not none %} ~{{ offer.eta_hours }} —á.
                  {% else %} –Ω–µ —É–∫–∞–∑–∞–Ω
                  {% endif %}
                </div>

                <div>
                  <span class="text-slate-400">–°—Ç–∞—Ç—É—Å:</span>
                  {{ offer_status_labels.get(offer.status, offer.status) }}
                </div>
              </div>

              {% if offer.comment %}
                <p class="text-xs text-slate-400 whitespace-pre-wrap">{{ offer.comment }}</p>
              {% endif %}

              {% if offer.status == "accepted" %}
                <span class="inline-flex items-center rounded-full bg-emerald-500/15 px-3 py-1 text-[11px] font-semibold text-emerald-200 border border-emerald-500/30">
                  ‚úÖ –í—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ñ—Ñ–µ—Ä
                </span>
              {% endif %}
            </div>

            <div class="flex flex-wrap gap-2 text-xs">
              <button type="button"
                      onclick="sendChatLinkAndClose('/me/requests/{{ request_obj.id }}/send-chat-link?service_center_id={{ offer.service_center_id }}', '{{ bot_username }}')"
                      class="inline-flex items-center gap-2 rounded-full bg-slate-900/60 px-5 py-2 text-xs font-semibold text-slate-100 border border-slate-700 hover:bg-slate-800 transition">
                üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram
              </button>

              {% if not chat_sc_id and offer.status != "accepted" %}
                <form method="post" action="/me/requests/{{ request_obj.id }}/offers/{{ offer.id }}/accept" class="inline">
                  <button type="submit"
                          class="inline-flex items-center justify-center rounded-full bg-emerald-500/20 px-5 py-2 text-xs font-semibold text-emerald-200 border border-emerald-500/30 hover:bg-emerald-500/25 transition">
                    –ü—Ä–∏–Ω—è—Ç—å
                  </button>
                </form>

                <form method="post" action="/me/requests/{{ request_obj.id }}/offers/{{ offer.id }}/reject" class="inline">
                  <button type="submit"
                          class="inline-flex items-center justify-center rounded-full bg-slate-900/60 px-5 py-2 text-xs font-semibold text-slate-100 border border-slate-700 hover:bg-slate-800 transition">
                    –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                  </button>
                </form>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 text-sm text-slate-400">
        –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∫–ª–∏–∫–æ–≤ –æ—Ç —Å–µ—Ä–≤–∏—Å–æ–≤.
      </div>
    {% endif %}

  </div>
</div>

<!-- leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
(function () {
  const mapContainer = document.getElementById("request-map-inner");
  const wrapper = document.getElementById("request-map");
  const hint = document.getElementById("map-hint");

  if (!mapContainer || !wrapper) return;

  const lat = {{ request_obj.latitude | tojson }};
  const lon = {{ request_obj.longitude | tojson }};
  const address = wrapper.dataset.address || "";

  function showError(msg) {
    if (!hint) return;
    hint.textContent = msg;
    hint.classList.remove("text-slate-500");
    hint.classList.add("text-slate-400");
  }

  function initMap(centerLat, centerLon) {
    const map = L.map(mapContainer, { attributionControl: false, zoomControl: false }).setView([centerLat, centerLon], 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: "" }).addTo(map);
    L.marker([centerLat, centerLon]).addTo(map);

    setTimeout(() => {
      try { map.invalidateSize(); } catch(e) {}
    }, 50);
  }

  if (lat !== null && lon !== null) {
    initMap(lat, lon);
    return;
  }

  if (!address) {
    showError("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –∞–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω—ã ‚Äî –∫–∞—Ä—Ç—É –ø–æ–∫–∞–∑–∞—Ç—å –Ω–µ–ª—å–∑—è.");
    return;
  }

  fetch("https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(address))
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data) || data.length === 0) {
        showError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ –∞–¥—Ä–µ—Å—É.");
        return;
      }
      const item = data[0];
      const glat = parseFloat(item.lat);
      const glon = parseFloat(item.lon);

      if (Number.isNaN(glat) || Number.isNaN(glon)) {
        showError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ –∞–¥—Ä–µ—Å—É.");
        return;
      }
      initMap(glat, glon);
    })
    .catch(() => showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã (–Ω–µ—Ç —Å–µ—Ç–∏ –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)."));
})();

function sendChatLinkAndClose(url, botUsername) {
  fetch(url, { method: "POST" })
    .then(() => {
      try {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.close();
          return;
        }
      } catch(e) {}
      if (botUsername) window.location.href = "https://t.me/" + botUsername;
    })
    .catch(() => {
      if (botUsername) window.location.href = "https://t.me/" + botUsername;
    });
}
</script>

{% endblock %}
—ã–≤–∞—ã