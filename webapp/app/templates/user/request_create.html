{% extends "layout/base.html" %}

{% block title %}–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ ‚Äî CarBot{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Leaflet (–∫–∞—Ä—Ç–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏) -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />
{% endblock %}

{% block content %}
{% set fd = form_data or {} %}
<div class="mt-8 space-y-6">

    <div class="relative">
        <div class="absolute inset-0 rounded-3xl bg-slate-900/70 backdrop-blur-2xl border border-slate-800"></div>

        <div class="relative z-10 p-6 md:p-8 space-y-6">
            <div>
                <p class="text-xs uppercase tracking-[0.25em] text-emerald-400/80 mb-1">
                    –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞
                </p>
                <h1 class="text-2xl md:text-3xl font-black text-slate-50 leading-tight">
                    –û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É ‚Äî –º—ã –ø–æ–¥–±–µ—Ä—ë–º –°–¢–û
                </h1>
                <p class="text-sm text-slate-400 mt-2 max-w-xl">
                    –£–∫–∞–∂–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é, —Ä–∞–¥–∏—É—Å –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —É—Å–ª—É–≥–∏ ‚Äî –¥–∞–ª—å—à–µ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –°–¢–û –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ —Ä–∞–∑–æ—Å–ª–∞—Ç—å –≤—Å–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–º.
                </p>
            </div>

            {# ------------------------------------------------------------
               –í—ã–±–æ—Ä –∞–≤—Ç–æ: –µ—Å–ª–∏ –∞–≤—Ç–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä—è–º–æ —Ç—É—Ç
               ------------------------------------------------------------ #}
            {% if car %}
                <div class="rounded-2xl border border-slate-800 bg-slate-900/50 p-4">
                    <div class="text-xs uppercase tracking-[0.25em] text-slate-400">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</div>
                    <div class="mt-1 text-lg font-bold text-slate-100">
                        {{ car.brand }} {{ car.model }}
                        {% if car.year %}<span class="text-slate-400 font-semibold">¬∑ {{ car.year }}</span>{% endif %}
                    </div>
                    <div class="text-xs text-slate-400 mt-1">
                        {% if car.plate_number %} –ì–æ—Å–Ω–æ–º–µ—Ä: <span class="text-slate-200 font-semibold">{{ car.plate_number }}</span> {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 space-y-2">
                    <div class="text-xs uppercase tracking-[0.25em] text-slate-400">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</div>
                    <div class="text-sm text-slate-200 font-semibold">
                        {% if cars and cars|length > 0 %}
                            –í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ –∏–∑ —Å–ø–∏—Å–∫–∞:
                        {% else %}
                            –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–≤—Ç–æ –≤ –≥–∞—Ä–∞–∂–µ.
                        {% endif %}
                    </div>

                    {% if cars and cars|length > 0 %}
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            {% for c in cars %}
                                <a href="/me/requests/create?car_id={{ c.id }}"
                                   class="rounded-2xl border border-slate-800 bg-slate-900/50 hover:bg-slate-900/70 transition p-3">
                                    <div class="font-semibold text-slate-100 text-sm">
                                        {{ c.brand }} {{ c.model }}
                                    </div>
                                    <div class="text-xs text-slate-400 mt-1">
                                        {% if c.year %}{{ c.year }}{% endif %}
                                        {% if c.plate_number %} ¬∑ {{ c.plate_number }}{% endif %}
                                    </div>
                                </a>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <a href="/me/cars/create"
                       class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-900 hover:bg-slate-800 text-slate-100 px-5 py-2 text-xs font-bold border border-slate-700 transition">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ –≤ –≥–∞—Ä–∞–∂
                    </a>
                </div>
            {% endif %}

            {% if error_message %}
            <div class="rounded-2xl bg-red-500/10 border border-red-500/30 p-4 text-sm text-red-200">
                {{ error_message }}
            </div>
            {% endif %}

            {% if created_request %}
            <div class="rounded-2xl bg-emerald-500/10 border border-emerald-500/30 p-4 text-sm text-emerald-200 space-y-3">
                <div class="font-semibold">
                    ‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ (‚Ññ{{ created_request.id }})
                </div>

                <div class="flex flex-wrap gap-2">
                    <a href="/me/requests/{{ created_request.id }}"
                       class="inline-flex items-center gap-2 rounded-full bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 text-xs font-semibold transition">
                        –û—Ç–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É
                    </a>

                    <a href="/me/requests/{{ created_request.id }}/choose-service"
                       class="inline-flex items-center gap-2 rounded-full bg-slate-900 hover:bg-slate-800 text-slate-100 px-4 py-2 text-xs font-semibold border border-slate-700 transition">
                        –í—ã–±—Ä–∞—Ç—å –°–¢–û –∏–∑ —Å–ø–∏—Å–∫–∞
                    </a>

                    {% if created_request.latitude and created_request.longitude %}
            <form method="post" action="/me/requests/{{ created_request.id }}/send-all">
                <button type="submit"
                        class="inline-flex items-center gap-2 rounded-full bg-slate-900 hover:bg-slate-800 text-slate-100 px-4 py-2 text-xs font-semibold border border-slate-700 transition">
                    –†–∞–∑–æ—Å–ª–∞—Ç—å –≤—Å–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–º –°–¢–û
                </button>
            </form>
            {% else %}
            <span class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-xs font-semibold text-slate-400 border border-slate-700">
                üìç –ß—Ç–æ–±—ã —Ä–∞–∑–æ—Å–ª–∞—Ç—å –≤—Å–µ–º ‚Äî —É–∫–∞–∂–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
            </span>
            {% endif %}
                </div>
            </div>
            {% endif %}

            <form method="post" class="space-y-6">
                <input type="hidden" name="car_id" value="{{ car_id or '' }}"/>
                <input type="hidden" id="geo-lat" name="latitude" value="{{ fd.latitude or '' }}"/>
                <input type="hidden" id="geo-lon" name="longitude" value="{{ fd.longitude or '' }}"/>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∑–∞—è–≤–∫–∏
                        </label>
                            <div class="mt-2 flex flex-wrap items-center gap-2">
                                <button type="button" id="btn-geo"
                                        class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-900/70 px-4 py-2 text-xs font-semibold text-slate-100 hover:bg-slate-800 transition">
                                    üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                                </button>
                                <button type="button" id="btn-map"
                                        class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-900/70 px-4 py-2 text-xs font-semibold text-slate-100 hover:bg-slate-800 transition">
                                    üó∫ –í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
                                </button>
                                <span id="geo-status" class="text-[11px] text-slate-500">
                                    {% if fd.latitude and fd.longitude %}
                                        –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ ‚úÖ
                                    {% else %}
                                        –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞
                                    {% endif %}
                                </span>
                            </div>
                            <p id="geo-coords" class="text-[11px] text-slate-500 mt-2">
                                {% if fd.latitude and fd.longitude %}
                                    –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: {{ fd.latitude }}, {{ fd.longitude }}
                                {% endif %}
                            </p>
                        <p class="text-[11px] text-slate-500">
                            –ë–µ–∑ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ —Ä–∞—Å—Å—ã–ª–∫–∞ "–≤—Å–µ–º –°–¢–û" –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.
                        </p>
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –ê–≤—Ç–æ–º–æ–±–∏–ª—å –ø–µ—Ä–µ–¥–≤–∏–≥–∞–µ—Ç—Å—è —Å–∞–º?
                        </label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-2 rounded-2xl border border-slate-700 bg-slate-900/40 px-4 py-3 cursor-pointer hover:bg-slate-900/60 transition">
                                <input type="radio" name="is_car_movable" value="movable"
                                       {% if (fd.is_car_movable or "movable") == "movable" %}checked{% endif %}
                                       class="accent-emerald-500">
                                <span class="text-sm text-slate-100">–î–∞</span>
                            </label>
                            <label class="flex items-center gap-2 rounded-2xl border border-slate-700 bg-slate-900/40 px-4 py-3 cursor-pointer hover:bg-slate-900/60 transition">
                                <input type="radio" name="is_car_movable" value="not_movable"
                                       {% if fd.is_car_movable == "not_movable" %}checked{% endif %}
                                       class="accent-emerald-500">
                                <span class="text-sm text-slate-100">–ù–µ—Ç</span>
                            </label>
                        </div>
                        <p class="text-[11px] text-slate-500">
                            –ï—Å–ª–∏ ‚Äú–ù–µ—Ç‚Äù ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –Ω—É–∂–µ–Ω –≤—ã–µ–∑–¥/—ç–≤–∞–∫—É–∞—Ü–∏—è (–¥–æ—Ä–∞–±–æ—Ç–∞–µ–º –≤—ã–±–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è –ø–æ–∑–∂–µ).
                        </p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞: <span id="radius-value" class="text-emerald-300 font-bold"></span> –∫–º
                        </label>
                        <input type="range" name="radius_km"
                               min="1" max="100" step="1"
                               value="{{ fd.radius_km or 5 }}"
                               id="radius-range"
                               class="w-full accent-emerald-500">
                        <p class="text-[11px] text-slate-500">
                            –ß–µ–º –±–æ–ª—å—à–µ —Ä–∞–¥–∏—É—Å ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ –°–¢–û –ø–æ–ª—É—á–∞—Ç –∑–∞—è–≤–∫—É.
                        </p>
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ª—É–≥–∏
                        </label>
                        <select name="service_category"
                                class="w-full rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500/70 focus:border-emerald-400 transition">
                            {% for code, label in primary_categories %}
                                <option value="{{ code }}" {% if (fd.service_category or 'mechanic') == code %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                            {% if extra_categories and extra_categories|length > 0 %}
                                <optgroup label="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ">
                                    {% for code, label in extra_categories %}
                                        <option value="{{ code }}" {% if fd.service_category == code %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endif %}
                        </select>
                        <p class="text-[11px] text-slate-500">
                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–ø–∏—Å–æ–∫ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –°–¢–û.
                        </p>
                    </div>
                </div>

                <div class="space-y-1.5">
                    <label class="block text-xs font-semibold text-slate-300">
                        –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã <span class="text-emerald-300">*</span>
                    </label>
                    <textarea name="description"
                              rows="5"
                              required
                              minlength="3"
                              class="w-full rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/70 focus:border-emerald-400 transition"
                              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–∫—Ä–∏–ø –ø—Ä–∏ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–∏, –Ω—É–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –∫–æ–ª–æ–¥–∫–∏">{{ fd.description or "" }}</textarea>
                    <p class="text-[11px] text-slate-500">
                        –ß–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ ‚Äî —Ç–µ–º —Ç–æ—á–Ω–µ–µ –æ—Ç–∫–ª–∏–∫–∏ –æ—Ç –°–¢–û.
                    </p>
                </div>

                <label class="flex items-center gap-3 rounded-2xl border border-slate-700 bg-slate-900/40 px-4 py-3 cursor-pointer hover:bg-slate-900/60 transition">
                    <input type="checkbox" name="hide_phone" value="1"
                           {% if fd.hide_phone %}checked{% endif %}
                           class="accent-emerald-500">
                    <div>
                        <div class="text-sm text-slate-100 font-semibold">
                            –°–∫—Ä—ã–≤–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –¥–æ —Å–æ–≥–ª–∞—Å–∏—è
                        </div>
                        <div class="text-[11px] text-slate-500">
                            –°–¢–û —É–≤–∏–¥–∏—Ç –Ω–æ–º–µ—Ä —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤–∞—à–µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–¥–æ —ç—Ç–æ–≥–æ –æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —á–∞—Ç/–±–æ—Ç).
                        </div>
                    </div>
                </label>

                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="submit"
                            class="inline-flex items-center justify-center gap-2 rounded-full bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 text-sm font-bold shadow-md shadow-emerald-600/20 transition">
                        –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                    </button>

                    <a href="/me/dashboard"
                       class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-900 hover:bg-slate-800 text-slate-100 px-6 py-3 text-sm font-bold border border-slate-700 transition">
                        –û—Ç–º–µ–Ω–∞
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ -->
<div id="map-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-950/70 backdrop-blur" id="map-modal-bg"></div>

    <div class="absolute inset-0 flex items-end md:items-center justify-center p-4">
        <div class="w-full max-w-2xl rounded-3xl border border-slate-800 bg-slate-950/90 overflow-hidden">
            <div class="p-4 border-b border-slate-800 flex items-center justify-between gap-3">
                <div>
                    <div class="text-xs uppercase tracking-[0.25em] text-slate-400">–í—ã–±–æ—Ä —Ç–æ—á–∫–∏</div>
                    <div class="text-sm font-semibold text-slate-100">–¢–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∞–≤—Ç–æ–º–æ–±–∏–ª—å</div>
                </div>
                <button type="button" id="map-close-x"
                        class="rounded-full px-3 py-1.5 text-xs font-semibold bg-slate-900/70 ring-1 ring-slate-800 hover:bg-slate-900">
                    ‚úï
                </button>
            </div>

            <div class="p-4 space-y-3">
                <div id="pick-map" class="w-full rounded-2xl border border-slate-800" style="height: 380px;"></div>
                <div class="flex flex-col sm:flex-row gap-2 sm:justify-between sm:items-center">
                    <div id="map-hint" class="text-[11px] text-slate-400">
                        –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É ‚Äî –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.
                    </div>
                    <div class="flex gap-2">
                        <button type="button" id="map-cancel"
                                class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-900 hover:bg-slate-800 text-slate-100 px-5 py-2 text-xs font-bold border border-slate-700 transition">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="button" id="map-apply" disabled
                                class="inline-flex items-center justify-center gap-2 rounded-full bg-emerald-600 hover:bg-emerald-500 disabled:opacity-40 disabled:hover:bg-emerald-600 text-white px-5 py-2 text-xs font-bold transition">
                            ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ—á–∫—É
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const range = document.getElementById("radius-range");
        const label = document.getElementById("radius-value");
        if (range && label) {
            const update = () => {
                label.textContent = range.value;
            };
            range.addEventListener("input", update);
            update();
        }

        const btn = document.getElementById("btn-geo");
        const btnMap = document.getElementById("btn-map");
        const status = document.getElementById("geo-status");
        const coords = document.getElementById("geo-coords");
        const latInput = document.getElementById("geo-lat");
        const lonInput = document.getElementById("geo-lon");

        // --- modal/map elements ---
        const modal = document.getElementById("map-modal");
        const modalBg = document.getElementById("map-modal-bg");
        const modalCloseX = document.getElementById("map-close-x");
        const modalCancel = document.getElementById("map-cancel");
        const modalApply = document.getElementById("map-apply");
        const mapHint = document.getElementById("map-hint");

        const setStatus = (text, ok = false) => {
            if (!status) return;
            status.textContent = text;
            status.className = "text-[11px] " + (ok ? "text-emerald-300" : "text-slate-500");
        };

        const setCoords = (lat, lon) => {
            if (latInput) latInput.value = String(lat);
            if (lonInput) lonInput.value = String(lon);
            if (coords) coords.textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat}, ${lon}`;
        };

        const getCurrentCoords = () => {
            const lat = latInput && latInput.value ? parseFloat(latInput.value) : null;
            const lon = lonInput && lonInput.value ? parseFloat(lonInput.value) : null;
            if (Number.isFinite(lat) && Number.isFinite(lon)) {
                return { lat, lon };
            }
            return null;
        };

        if (btn) {
            btn.addEventListener("click", () => {
                if (!navigator.geolocation) {
                    setStatus("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ", false);
                    return;
                }

                setStatus("–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ‚Ä¶", false);

                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const lat = pos.coords.latitude.toFixed(6);
                        const lon = pos.coords.longitude.toFixed(6);
                        setCoords(lat, lon);
                        setStatus("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ ‚úÖ", true);
                    },
                    (err) => {
                        setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é: " + (err && err.message ? err.message : "–æ—à–∏–±–∫–∞"), false);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            });
        }

        // -------------------------
        // –†—É—á–Ω–æ–π –≤—ã–±–æ—Ä —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
        // -------------------------
        let leafletLoaded = false;
        let mapInstance = null;
        let marker = null;
        let picked = null;

        const loadLeaflet = () => {
            return new Promise((resolve, reject) => {
                if (window.L && window.L.map) {
                    resolve();
                    return;
                }

                const script = document.createElement("script");
                script.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
                script.integrity = "sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=";
                script.crossOrigin = "";
                script.onload = () => resolve();
                script.onerror = () => reject(new Error("leaflet load failed"));
                document.head.appendChild(script);
            });
        };

        const openModal = async () => {
            if (!modal) return;
            modal.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");

            try {
                if (!leafletLoaded) {
                    await loadLeaflet();
                    leafletLoaded = true;
                }
            } catch (e) {
                setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", false);
                closeModal();
                return;
            }

            const current = getCurrentCoords();
            const startLat = current ? current.lat : 55.751244;
            const startLon = current ? current.lon : 37.618423;
            const startZoom = current ? 15 : 11;

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É 1 —Ä–∞–∑, –¥–∞–ª—å—à–µ —Ç–æ–ª—å–∫–æ setView
            if (!mapInstance) {
                mapInstance = L.map("pick-map", {
                    zoomControl: true,
                }).setView([startLat, startLon], startZoom);

                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    maxZoom: 19,
                }).addTo(mapInstance);

                mapInstance.on("click", (e) => {
                    const lat = Number(e.latlng.lat.toFixed(6));
                    const lon = Number(e.latlng.lng.toFixed(6));
                    picked = { lat, lon };
                    if (!marker) {
                        marker = L.marker([lat, lon]).addTo(mapInstance);
                    } else {
                        marker.setLatLng([lat, lon]);
                    }
                    if (mapHint) mapHint.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${lat}, ${lon}`;
                    if (modalApply) modalApply.disabled = false;
                });
            } else {
                mapInstance.setView([startLat, startLon], startZoom);
            }

            // –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–∂–µ –µ—Å—Ç—å ‚Äî —Å—Ç–∞–≤–∏–º –º–∞—Ä–∫–µ—Ä
            if (current) {
                picked = { lat: Number(current.lat.toFixed(6)), lon: Number(current.lon.toFixed(6)) };
                if (!marker) {
                    marker = L.marker([picked.lat, picked.lon]).addTo(mapInstance);
                } else {
                    marker.setLatLng([picked.lat, picked.lon]);
                }
                if (mapHint) mapHint.textContent = `–¢–µ–∫—É—â–∞—è —Ç–æ—á–∫–∞: ${picked.lat}, ${picked.lon}`;
                if (modalApply) modalApply.disabled = false;
            } else {
                picked = null;
                if (modalApply) modalApply.disabled = true;
                if (mapHint) mapHint.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É ‚Äî –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.";

                // –ü—ã—Ç–∞–µ–º—Å—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ç–µ–∫—É—â–µ–º—É –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é (–±–µ–∑ –∞–≤—Ç–æ–∑–∞–ø–∏—Å–∏)
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            try {
                                const lat = Number(pos.coords.latitude.toFixed(6));
                                const lon = Number(pos.coords.longitude.toFixed(6));
                                mapInstance.setView([lat, lon], 15);
                            } catch (e) {}
                        },
                        () => {},
                        { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
                    );
                }
            }

            // –í–∞–∂–Ω–æ: Leaflet –≤ –º–æ–¥–∞–ª–∫–µ –º–æ–∂–µ—Ç –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è –∫—Ä–∏–≤–æ –±–µ–∑ invalidateSize
            setTimeout(() => {
                try { mapInstance.invalidateSize(); } catch (e) {}
            }, 150);
        };

        const closeModal = () => {
            if (!modal) return;
            modal.classList.add("hidden");
            document.body.classList.remove("overflow-hidden");
        };

        if (btnMap) {
            btnMap.addEventListener("click", () => {
                openModal();
            });
        }

        const closeHandlers = [modalBg, modalCloseX, modalCancel].filter(Boolean);
        closeHandlers.forEach((el) => {
            el.addEventListener("click", () => closeModal());
        });

        if (modalApply) {
            modalApply.addEventListener("click", () => {
                if (!picked) return;
                setCoords(picked.lat.toFixed(6), picked.lon.toFixed(6));
                setStatus("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–∞ –Ω–∞ –∫–∞—Ä—Ç–µ ‚úÖ", true);
                closeModal();
            });
        }
    })();
</script>

{% endblock %}
