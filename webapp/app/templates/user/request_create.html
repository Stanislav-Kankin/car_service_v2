{% extends "layout/base.html" %}

{% block title %}–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ ‚Äî CarBot{% endblock %}

{% block content %}
{% set fd = form_data or {} %}
<div class="mt-8 space-y-6">

    <div class="relative">
        <div class="absolute inset-0 rounded-3xl bg-slate-900/70 backdrop-blur-2xl border border-slate-800"></div>

        <div class="relative z-10 p-6 md:p-8 space-y-6">
            <div>
                <p class="text-xs uppercase tracking-[0.25em] text-emerald-400/80 mb-1">
                    –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞
                </p>
                <h1 class="text-2xl md:text-3xl font-black text-slate-50 leading-tight">
                    –û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É ‚Äî –º—ã –ø–æ–¥–±–µ—Ä—ë–º –°–¢–û
                </h1>
                <p class="text-sm text-slate-400 mt-2 max-w-xl">
                    –£–∫–∞–∂–∏ –∞–¥—Ä–µ—Å, —Ä–∞–¥–∏—É—Å –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —É—Å–ª—É–≥–∏ ‚Äî –¥–∞–ª—å—à–µ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –°–¢–û –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ —Ä–∞–∑–æ—Å–ª–∞—Ç—å –≤—Å–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–º.
                </p>
            </div>

            {% if error_message %}
            <div class="rounded-2xl bg-red-500/10 border border-red-500/30 p-4 text-sm text-red-200">
                {{ error_message }}
            </div>
            {% endif %}

            {% if created_request %}
            <div class="rounded-2xl bg-emerald-500/10 border border-emerald-500/30 p-4 text-sm text-emerald-200 space-y-3">
                <div class="font-semibold">
                    ‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ (‚Ññ{{ created_request.id }})
                </div>

                <div class="flex flex-wrap gap-2">
                    <a href="/me/requests/{{ created_request.id }}"
                       class="inline-flex items-center gap-2 rounded-full bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 text-xs font-semibold transition">
                        –û—Ç–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É
                    </a>

                    <a href="/me/requests/{{ created_request.id }}/choose-service"
                       class="inline-flex items-center gap-2 rounded-full bg-slate-900 hover:bg-slate-800 text-slate-100 px-4 py-2 text-xs font-semibold border border-slate-700 transition">
                        –í—ã–±—Ä–∞—Ç—å –°–¢–û –∏–∑ —Å–ø–∏—Å–∫–∞
                    </a>

                    {% if created_request.latitude and created_request.longitude %}
            <form method="post" action="/me/requests/{{ created_request.id }}/send-all">
                <button type="submit"
                        class="inline-flex items-center gap-2 rounded-full bg-slate-900 hover:bg-slate-800 text-slate-100 px-4 py-2 text-xs font-semibold border border-slate-700 transition">
                    –†–∞–∑–æ—Å–ª–∞—Ç—å –≤—Å–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–º –°–¢–û
                </button>
            </form>
            {% else %}
            <span class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-xs font-semibold text-slate-400 border border-slate-700">
                üìç –ß—Ç–æ–±—ã —Ä–∞–∑–æ—Å–ª–∞—Ç—å –≤—Å–µ–º ‚Äî —É–∫–∞–∂–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
            </span>
            {% endif %}
                </div>
            </div>
            {% endif %}

            <form method="post" class="space-y-6">
                <input type="hidden" name="car_id" value="{{ car_id }}"/>
                <input type="hidden" id="geo-lat" name="latitude" value="{{ fd.latitude or '' }}"/>
                <input type="hidden" id="geo-lon" name="longitude" value="{{ fd.longitude or '' }}"/>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –ê–¥—Ä–µ—Å / –æ—Ä–∏–µ–Ω—Ç–∏—Ä
                        </label>
                        <input type="text"
                               name="address_text" required
                               value="{{ fd.address_text or '' }}"
                               class="w-full rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/70 focus:border-emerald-400 transition"
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, —É–ª. –°–µ–≤–µ—Ä–Ω–∞—è 10"
                            />
                            <div class="mt-2 flex flex-wrap items-center gap-2">
                                <button type="button" id="btn-geo"
                                        class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-900/70 px-4 py-2 text-xs font-semibold text-slate-100 hover:bg-slate-800 transition">
                                    üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                                </button>
                                <span id="geo-status" class="text-[11px] text-slate-500">
                                    {% if fd.latitude and fd.longitude %}
                                        –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ ‚úÖ
                                    {% else %}
                                        –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞
                                    {% endif %}
                                </span>
                            </div>
                            <p id="geo-coords" class="text-[11px] text-slate-500 mt-2">
                                {% if fd.latitude and fd.longitude %}
                                    –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: {{ fd.latitude }}, {{ fd.longitude }}
                                {% endif %}
                            </p>
                        <p class="text-[11px] text-slate-500">
                            –ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å/–æ—Ä–∏–µ–Ω—Ç–∏—Ä –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é. –ë–µ–∑ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ —Ä–∞—Å—Å—ã–ª–∫–∞ "–≤—Å–µ–º –°–¢–û" –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.
                        </p>
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –ê–≤—Ç–æ–º–æ–±–∏–ª—å –ø–µ—Ä–µ–¥–≤–∏–≥–∞–µ—Ç—Å—è —Å–∞–º?
                        </label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-2 rounded-2xl border border-slate-700 bg-slate-900/40 px-4 py-3 cursor-pointer hover:bg-slate-900/60 transition">
                                <input type="radio" name="is_car_movable" value="movable"
                                       {% if (fd.is_car_movable or "movable") == "movable" %}checked{% endif %}
                                       class="accent-emerald-500">
                                <span class="text-sm text-slate-100">–î–∞</span>
                            </label>
                            <label class="flex items-center gap-2 rounded-2xl border border-slate-700 bg-slate-900/40 px-4 py-3 cursor-pointer hover:bg-slate-900/60 transition">
                                <input type="radio" name="is_car_movable" value="not_movable"
                                       {% if fd.is_car_movable == "not_movable" %}checked{% endif %}
                                       class="accent-emerald-500">
                                <span class="text-sm text-slate-100">–ù–µ—Ç</span>
                            </label>
                        </div>
                        <p class="text-[11px] text-slate-500">
                            –ï—Å–ª–∏ ‚Äú–ù–µ—Ç‚Äù ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –Ω—É–∂–µ–Ω –≤—ã–µ–∑–¥/—ç–≤–∞–∫—É–∞—Ü–∏—è (–¥–æ—Ä–∞–±–æ—Ç–∞–µ–º –≤—ã–±–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è –ø–æ–∑–∂–µ).
                        </p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞: <span id="radius-value" class="text-emerald-300 font-bold"></span> –∫–º
                        </label>
                        <input type="range" name="radius_km"
                               min="1" max="100" step="1"
                               value="{{ fd.radius_km or 5 }}"
                               class="w-full accent-emerald-500"
                               id="radius-range">
                        <p class="text-[11px] text-slate-500">
                            –û–±—ã—á–Ω–æ 5‚Äì10 –∫–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 100 –∫–º.
                        </p>
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ª—É–≥–∏
                        </label>

                        <select name="service_category"
                                class="w-full rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500/70 focus:border-emerald-400 transition">
                            {% for code, label in primary_categories %}
                                <option value="{{ code }}" {% if (fd.service_category or "mechanic") == code %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                            {% if extra_categories %}
                                <optgroup label="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ">
                                    {% for code, label in extra_categories %}
                                        <option value="{{ code }}" {% if fd.service_category == code %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endif %}
                        </select>
                    </div>
                </div>

                <div class="space-y-1.5">
                    <label class="block text-xs font-semibold text-slate-300">
                        –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
                    </label>
                    <textarea name="description"
                              rows="4"
                              class="w-full rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/70 focus:border-emerald-400 transition"
                              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–∫—Ä–∏–ø –ø—Ä–∏ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–∏, –Ω—É–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –∫–æ–ª–æ–¥–∫–∏">{{ fd.description or "" }}</textarea>
                    <p class="text-[11px] text-slate-500">
                        –ß–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ ‚Äî —Ç–µ–º —Ç–æ—á–Ω–µ–µ –æ—Ç–∫–ª–∏–∫–∏ –æ—Ç –°–¢–û.
                    </p>
                </div>

                <label class="flex items-center gap-3 rounded-2xl border border-slate-700 bg-slate-900/40 px-4 py-3 cursor-pointer hover:bg-slate-900/60 transition">
                    <input type="checkbox" name="hide_phone" value="1"
                           {% if fd.hide_phone %}checked{% endif %}
                           class="accent-emerald-500">
                    <div>
                        <div class="text-sm text-slate-100 font-semibold">
                            –°–∫—Ä—ã–≤–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –¥–æ —Å–æ–≥–ª–∞—Å–∏—è
                        </div>
                        <div class="text-[11px] text-slate-500">
                            –°–¢–û —É–≤–∏–¥–∏—Ç –Ω–æ–º–µ—Ä —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤–∞—à–µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–¥–æ —ç—Ç–æ–≥–æ –æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —á–∞—Ç/–±–æ—Ç).
                        </div>
                    </div>
                </label>

                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="submit"
                            class="inline-flex items-center justify-center gap-2 rounded-full bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 text-sm font-bold shadow-md shadow-emerald-600/20 transition">
                        –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                    </button>

                    <a href="/me/dashboard"
                       class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-900 hover:bg-slate-800 text-slate-100 px-6 py-3 text-sm font-bold border border-slate-700 transition">
                        –û—Ç–º–µ–Ω–∞
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (function () {
        const range = document.getElementById("radius-range");
        const label = document.getElementById("radius-value");
        if (range && label) {
            const update = () => {
                label.textContent = range.value;
            };
            range.addEventListener("input", update);
            update();
        }

        const btn = document.getElementById("btn-geo");
        const status = document.getElementById("geo-status");
        const coords = document.getElementById("geo-coords");
        const latInput = document.getElementById("geo-lat");
        const lonInput = document.getElementById("geo-lon");
        const addressInput = document.querySelector('input[name="address_text"]');

        const setStatus = (text, ok = false) => {
            if (!status) return;
            status.textContent = text;
            status.className = "text-[11px] " + (ok ? "text-emerald-300" : "text-slate-500");
        };

        const setCoords = (lat, lon) => {
            if (latInput) latInput.value = String(lat);
            if (lonInput) lonInput.value = String(lon);
            if (coords) coords.textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat}, ${lon}`;
        };

        if (btn) {
            btn.addEventListener("click", () => {
                if (!navigator.geolocation) {
                    setStatus("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ", false);
                    return;
                }

                setStatus("–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ‚Ä¶", false);

                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const lat = pos.coords.latitude.toFixed(6);
                        const lon = pos.coords.longitude.toFixed(6);
                        setCoords(lat, lon);
                        setStatus("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ ‚úÖ", true);

                        // –µ—Å–ª–∏ –∞–¥—Ä–µ—Å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω ‚Äî –ø–æ–¥—Å—Ç–∞–≤–∏–º –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
                        if (addressInput && !addressInput.value.trim()) {
                            addressInput.value = "–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ";
                        }
                    },
                    (err) => {
                        setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é: " + (err && err.message ? err.message : "–æ—à–∏–±–∫–∞"), false);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            });
        }
    })();
</script>

{% endblock %}
