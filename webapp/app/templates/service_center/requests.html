{% extends "layout/base.html" %}

{% block title %}–ó–∞—è–≤–∫–∏ –¥–ª—è {{ service_center.name }} ‚Äî CarBot{% endblock %}

{% block content %}
{# ‚úÖ –ª–æ–∫–∞–ª—å–Ω—ã–π mapping –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è UI #}
{% set category_labels = {
    "sto": "–°–¢–û / –æ–±—â–∏–π —Ä–µ–º–æ–Ω—Ç",
    "wash": "–ê–≤—Ç–æ–º–æ–π–∫–∞",
    "tire": "–®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂",
    "electric": "–ê–≤—Ç–æ—ç–ª–µ–∫—Ç—Ä–∏–∫",
    "mechanic": "–°–ª–µ—Å–∞—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
    "paint": "–ú–∞–ª—è—Ä–Ω—ã–µ / –∫—É–∑–æ–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
    "maint": "–¢–û / –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ",
    "agg_turbo": "–†–µ–º–æ–Ω—Ç —Ç—É—Ä–±–∏–Ω",
    "agg_starter": "–†–µ–º–æ–Ω—Ç —Å—Ç–∞—Ä—Ç–µ—Ä–æ–≤",
    "agg_generator": "–†–µ–º–æ–Ω—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤",
    "agg_steering": "–†—É–ª–µ–≤—ã–µ —Ä–µ–π–∫–∏",
    "mech": "–°–ª–µ—Å–∞—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
    "elec": "–ê–≤—Ç–æ—ç–ª–µ–∫—Ç—Ä–∏–∫",
    "body": "–ú–∞–ª—è—Ä–Ω—ã–µ / –∫—É–∑–æ–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
    "diag": "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞",
    "agg": "–†–µ–º–æ–Ω—Ç –∞–≥—Ä–µ–≥–∞—Ç–æ–≤"
} %}

{% set status_badges = {
    "new": ("–ù–æ–≤–∞—è", "border-sky-400/60", "bg-sky-500/10", "text-sky-200"),
    "sent": ("–†–∞–∑–æ—Å–ª–∞–Ω–∞", "border-amber-400/60", "bg-amber-500/10", "text-amber-200"),
    "accepted_by_service": ("–ü—Ä–∏–Ω—è—Ç–∞ –°–¢–û", "border-emerald-400/60", "bg-emerald-500/10", "text-emerald-200"),
    "in_work": ("–í —Ä–∞–±–æ—Ç–µ", "border-violet-400/60", "bg-violet-500/10", "text-violet-200"),
    "done": ("–ó–∞–≤–µ—Ä—à–µ–Ω–∞", "border-emerald-400/60", "bg-emerald-500/10", "text-emerald-200"),
    "cancelled": ("–û—Ç–º–µ–Ω–µ–Ω–∞", "border-rose-400/60", "bg-rose-500/10", "text-rose-200"),
    "rejected_by_service": ("–û—Ç–∫–ª–æ–Ω–µ–Ω–∞", "border-rose-400/60", "bg-rose-500/10", "text-rose-200")
} %}

{% set active_status = filter_status %}
{% set active_no_offer = (filter_no_offer == 1) %}

<div class="mt-8 space-y-6">
    <a href="/sc/dashboard" class="text-xs text-slate-400 hover:text-emerald-400 transition">
        ‚Üê –ù–∞–∑–∞–¥ –≤ –∫–∞–±–∏–Ω–µ—Ç –°–¢–û
    </a>

    <div class="space-y-1">
        <p class="text-xs uppercase tracking-[0.25em] text-emerald-400/80">
            –ó–∞—è–≤–∫–∏ –ø–æ —Å–µ—Ä–≤–∏—Å—É
        </p>
        <h1 class="text-2xl font-semibold">
            {{ service_center.name or "–°–µ—Ä–≤–∏—Å –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}
        </h1>
        <p class="text-sm text-slate-300">
            –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∑–∞—è–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —ç—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å.
        </p>
    </div>

    {% if error_message %}
    <div class="rounded-2xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-100">
        {{ error_message }}
    </div>
    {% endif %}

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="flex flex-wrap gap-2">
        <a href="/sc/{{ service_center.id }}/requests"
           class="inline-flex items-center gap-2 rounded-full border px-4 py-2 text-xs font-semibold transition
                  {% if not active_status and not active_no_offer %}
                    border-emerald-400/60 bg-emerald-500/10 text-emerald-200
                  {% else %}
                    border-slate-700 bg-slate-900/60 text-slate-200 hover:bg-slate-800
                  {% endif %}">
            –í—Å–µ–≥–æ
            <span class="rounded-full bg-slate-800/70 px-2 py-0.5 text-[11px] text-slate-200">{{ counters.total }}</span>
        </a>

        <a href="/sc/{{ service_center.id }}/requests?no_offer=1"
           class="inline-flex items-center gap-2 rounded-full border px-4 py-2 text-xs font-semibold transition
                  {% if active_no_offer %}
                    border-amber-400/60 bg-amber-500/10 text-amber-200
                  {% else %}
                    border-slate-700 bg-slate-900/60 text-slate-200 hover:bg-slate-800
                  {% endif %}">
            –ë–µ–∑ –æ—Ç–∫–ª–∏–∫–∞
            <span class="rounded-full bg-slate-800/70 px-2 py-0.5 text-[11px] text-slate-200">{{ counters.no_offer }}</span>
        </a>

        <a href="/sc/{{ service_center.id }}/requests?status=in_work"
           class="inline-flex items-center gap-2 rounded-full border px-4 py-2 text-xs font-semibold transition
                  {% if active_status == 'in_work' %}
                    border-violet-400/60 bg-violet-500/10 text-violet-200
                  {% else %}
                    border-slate-700 bg-slate-900/60 text-slate-200 hover:bg-slate-800
                  {% endif %}">
            –í —Ä–∞–±–æ—Ç–µ
            <span class="rounded-full bg-slate-800/70 px-2 py-0.5 text-[11px] text-slate-200">{{ counters.in_work }}</span>
        </a>

        <a href="/sc/{{ service_center.id }}/requests?status=done"
           class="inline-flex items-center gap-2 rounded-full border px-4 py-2 text-xs font-semibold transition
                  {% if active_status == 'done' %}
                    border-emerald-400/60 bg-emerald-500/10 text-emerald-200
                  {% else %}
                    border-slate-700 bg-slate-900/60 text-slate-200 hover:bg-slate-800
                  {% endif %}">
            –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
            <span class="rounded-full bg-slate-800/70 px-2 py-0.5 text-[11px] text-slate-200">{{ counters.done }}</span>
        </a>
    </div>

    <div class="relative">
        <div class="absolute inset-0 rounded-3xl bg-slate-900/70 backdrop-blur-2xl border border-slate-800"></div>

        <div class="relative z-10 p-5 space-y-3">
            {% if requests_list %}
                <div class="space-y-3">
                    {% for r in requests_list %}
                        {% set st = r.status %}
                        {% set badge = status_badges.get(st, (st or "‚Äî", "border-slate-600/60", "bg-slate-800/40", "text-slate-200")) %}
                        {% set cat = r.service_category or r.category %}
                        {% set cat_label = r.service_category_label or category_labels.get(cat, cat) %}
                        {% set addr = r.address_text or r.address or "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω" %}
                        {% set car_line = (r.car_brand or "") ~ " " ~ (r.car_model or "") ~ " " ~ (r.car_year or "") %}

                        <a href="/sc/{{ service_center.id }}/requests/{{ r.id }}"
                           class="block group rounded-2xl border border-slate-800 bg-slate-900/80 p-4 hover:border-emerald-400/70 hover:bg-slate-900 transition">
                            <div class="flex items-start justify-between gap-3">
                                <div class="min-w-0 space-y-2">
                                    <div class="flex flex-wrap items-center gap-2">
                                        <span class="text-xs uppercase tracking-[0.18em] text-slate-500">
                                            –ó–∞—è–≤–∫–∞ ‚Ññ{{ r.id }}
                                        </span>

                                        <span class="inline-flex items-center rounded-full border px-2.5 py-1 text-[11px] font-semibold {{ badge[1] }} {{ badge[2] }} {{ badge[3] }}">
                                            {{ badge[0] }}
                                        </span>

                                        {% if cat_label %}
                                        <span class="inline-flex items-center rounded-full border border-slate-700 bg-slate-950/40 px-2.5 py-1 text-[11px] text-slate-200">
                                            {{ cat_label }}
                                        </span>
                                        {% endif %}

                                        {% if r.my_offer %}
                                        <span class="inline-flex items-center rounded-full border border-emerald-400/60 bg-emerald-500/10 px-2.5 py-1 text-[11px] font-semibold text-emerald-200">
                                            ‚úÖ –í—ã –æ—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å
                                        </span>
                                        {% endif %}
                                    </div>

                                    <div class="text-sm text-slate-200 break-words">
                                        {{ addr }}
                                    </div>

                                    {% if car_line.strip() %}
                                    <div class="text-xs text-slate-400">
                                        üöó {{ car_line }}
                                    </div>
                                    {% endif %}

                                    {% if r.my_offer %}
                                    <div class="text-xs text-slate-300">
                                        –í–∞—à –æ—Ç–∫–ª–∏–∫: <span class="font-semibold">{{ r.my_offer.price }}</span> ‚ÇΩ ‚Ä¢
                                        <span class="font-semibold">{{ r.my_offer.eta_hours }}</span> —á.
                                        {% if r.my_offer.status %} ‚Ä¢ <span class="opacity-90">{{ r.my_offer.status }}</span>{% endif %}
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="shrink-0 text-xs text-slate-400 group-hover:text-emerald-300 transition">
                                    –û—Ç–∫—Ä—ã—Ç—å ‚Üí
                                </div>
                            </div>
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-6 text-sm text-slate-300">
                    –ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
