{% extends "layout/base.html" %}

{% block title %}Заявка №{{ req.id if req else "" }} — {{ service_center.name }}{% endblock %}

{% block content %}
<div class="mt-8 space-y-6">
    <a href="/sc/{{ service_center.id }}/requests" class="text-xs text-slate-400 hover:text-emerald-400 transition">
        ← Ко всем заявкам сервиса
    </a>

    <div class="relative">
        <div class="absolute inset-0 rounded-3xl bg-slate-900/70 backdrop-blur-2xl border border-slate-800"></div>

        <div class="relative z-10 p-6 md:p-8 space-y-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <p class="text-xs uppercase tracking-[0.25em] text-emerald-400/80 mb-1">
                        Заявка №{{ req.id if req else "—" }}
                    </p>
                    <h1 class="text-2xl font-semibold">
                        {{ req.service_category or "Без категории" }}
                    </h1>
                    {% if req and req.status %}
                    <p class="text-sm text-slate-300 mt-1">
                        Текущий статус: <span class="font-semibold">{{ req.status }}</span>
                    </p>
                    {% endif %}
                </div>
                {% if service_center %}
                <div class="text-xs text-slate-400">
                    <p class="mb-1">Сервис:</p>
                    <p class="font-semibold text-slate-100">{{ service_center.name }}</p>
                    {% if service_center.address %}
                    <p>{{ service_center.address }}</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            {% if error_message %}
            <div class="rounded-2xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-100">
                {{ error_message }}
            </div>
            {% endif %}

            {% if req %}
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">

                    <!-- Автомобиль -->
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-2">
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                            Автомобиль
                        </p>

                        {# Важно: backend request не содержит вложенный car, обычно есть только car_id #}
                        {% if req.car %}
                            <p class="text-sm text-slate-100">
                                {{ req.car.brand }} {{ req.car.model }}
                                {% if req.car.year %}({{ req.car.year }} г.){% endif %}
                            </p>
                            {% if req.car.license_plate %}
                            <p class="text-xs text-slate-400">
                                Госномер: {{ req.car.license_plate }}
                            </p>
                            {% endif %}
                        {% else %}
                            <p class="text-sm text-slate-300">
                                Данные об автомобиле недоступны.
                                {% if req.car_id %}
                                <span class="text-slate-400">ID авто: {{ req.car_id }}</span>
                                {% endif %}
                            </p>
                        {% endif %}
                    </div>

                    <!-- Описание -->
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-2">
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                            Описание проблемы
                        </p>
                        <p class="text-sm text-slate-100 whitespace-pre-line">
                            {{ req.description or "Клиент не указал подробностей." }}
                        </p>
                    </div>

                    <!-- Адрес -->
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-2">
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                            Адрес / район
                        </p>
                        <p class="text-sm text-slate-100">
                            {{ req.address_text or "Не указан" }}
                        </p>
                    </div>

                    <!-- Итог / отказ -->
                    {% if req.status == "done" %}
                    <div class="rounded-2xl border border-emerald-500/30 bg-emerald-500/10 p-4 space-y-1">
                        <p class="text-sm text-emerald-200 font-semibold">✅ Заявка завершена</p>
                        {% if req.final_price is not none %}
                        <p class="text-sm text-emerald-100/90">
                            Итоговая цена: <b>{{ req.final_price }}</b>
                        </p>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if req.status == "rejected_by_service" %}
                    <div class="rounded-2xl border border-red-500/30 bg-red-500/10 p-4 space-y-1">
                        <p class="text-sm text-red-200 font-semibold">❌ Заявка отклонена сервисом</p>
                        {% if req.reject_reason %}
                        <p class="text-sm text-red-100/90">
                            Причина: <b>{{ req.reject_reason }}</b>
                        </p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <div class="space-y-4">
                    <!-- Ваш отклик -->
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-3">
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                            Ваш отклик
                        </p>

                        {% if my_offer %}
                        <p class="text-sm text-slate-300">
                            Вы уже отправили отклик по этой заявке. Вы можете обновить его.
                        </p>
                        <ul class="text-xs text-slate-300 space-y-1">
                            <li>Цена: <span class="font-semibold">{{ my_offer.price }}</span></li>
                            <li>Срок: <span class="font-semibold">{{ my_offer.eta_hours }} ч.</span></li>
                            {% if my_offer.comment %}
                            <li>Комментарий: <span class="font-semibold">{{ my_offer.comment }}</span></li>
                            {% endif %}
                            {% if my_offer.status %}
                            <li>Статус: <span class="font-semibold">{{ my_offer.status }}</span></li>
                            {% endif %}
                        </ul>
                        {% else %}
                        <p class="text-sm text-slate-300">
                            Отправьте предложение по цене и срокам. Клиент увидит его в своём кабинете и сможет выбрать ваш сервис.
                        </p>
                        {% endif %}

                        <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/offer" class="space-y-3">
                            <div class="grid grid-cols-1 gap-3">
                                <div class="space-y-1.5">
                                    <label class="block text-xs font-semibold text-slate-300">
                                        Цена, ₽
                                    </label>
                                    <input type="number" step="0.01" min="0" name="price"
                                           value="{{ my_offer.price if my_offer else '' }}"
                                           required
                                           class="w-full rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                                </div>
                                <div class="space-y-1.5">
                                    <label class="block text-xs font-semibold text-slate-300">
                                        Ориентировочный срок, ч.
                                    </label>
                                    <input type="number" min="1" name="eta_hours"
                                           value="{{ my_offer.eta_hours if my_offer else '' }}"
                                           required
                                           class="w-full rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                                </div>
                            </div>

                            <div class="space-y-1.5">
                                <label class="block text-xs font-semibold text-slate-300">
                                    Комментарий для клиента
                                </label>
                                <textarea name="comment" rows="3"
                                          class="w-full rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40"
                                          placeholder="Например: «Диагностика в подарок при ремонте».">{{ my_offer.comment if my_offer else "" }}</textarea>
                            </div>

                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 pt-2">
                                <p class="text-xs text-slate-400">
                                    После отправки отклика клиент увидит его в своём кабинете и сможет выбрать ваш сервис.
                                </p>
                                <button type="submit"
                                        class="inline-flex items-center justify-center gap-2 rounded-full bg-emerald-500 px-6 py-2.5 text-sm font-semibold text-slate-900 shadow-lg shadow-emerald-500/30 hover:bg-emerald-400 transition">
                                    {% if my_offer %}Обновить отклик{% else %}Отправить отклик{% endif %}
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Действия по заявке (СТО) -->
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-3">
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                            Действия по заявке
                        </p>

                        {% if req.status == "accepted_by_service" %}
                        <div class="flex flex-wrap gap-2">
                            <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/set-in-work">
                                <button type="submit"
                                        class="inline-flex items-center justify-center rounded-full bg-amber-400 px-5 py-2 text-sm font-semibold text-slate-900 hover:bg-amber-300 transition">
                                    В работу
                                </button>
                            </form>

                            <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/reject"
                                  class="flex flex-wrap gap-2 items-center">
                                <input name="reason" placeholder="Причина отказа"
                                       class="w-64 rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 outline-none focus:border-red-400">
                                <button type="submit"
                                        class="inline-flex items-center justify-center rounded-full border border-red-400/70 px-5 py-2 text-sm font-semibold text-red-200 hover:bg-red-500/10 transition">
                                    Отказать
                                </button>
                            </form>
                        </div>

                        {% elif req.status == "in_work" %}
                        <div class="space-y-2">
                            <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/set-done"
                                  class="flex flex-wrap gap-2 items-center">
                                <input type="number" step="0.01" min="0" name="final_price" required
                                       placeholder="Итоговая цена, ₽"
                                       class="w-64 rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 outline-none focus:border-emerald-400">
                                <button type="submit"
                                        class="inline-flex items-center justify-center rounded-full bg-emerald-500 px-6 py-2 text-sm font-semibold text-slate-900 hover:bg-emerald-400 transition">
                                    Завершить
                                </button>
                            </form>

                            <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/reject"
                                  class="flex flex-wrap gap-2 items-center">
                                <input name="reason" placeholder="Причина отказа"
                                       class="w-64 rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 outline-none focus:border-red-400">
                                <button type="submit"
                                        class="inline-flex items-center justify-center rounded-full border border-red-400/70 px-5 py-2 text-sm font-semibold text-red-200 hover:bg-red-500/10 transition">
                                    Отказать
                                </button>
                            </form>
                        </div>

                        {% elif req.status == "done" %}
                        <p class="text-sm text-emerald-200">
                            ✅ Заявка завершена.
                            {% if req.final_price is not none %}
                            Итоговая цена: <b>{{ req.final_price }}</b>
                            {% endif %}
                        </p>

                        {% elif req.status == "rejected_by_service" %}
                        <p class="text-sm text-red-200">
                            ❌ Заявка отклонена.
                            {% if req.reject_reason %}
                            Причина: <b>{{ req.reject_reason }}</b>
                            {% endif %}
                        </p>

                        {% else %}
                        <p class="text-sm text-slate-400">
                            Для текущего статуса действий нет.
                        </p>
                        {% endif %}
                    </div>

                    {% if offers and offers|length > 0 %}
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-2">
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                            Все отклики (для информации)
                        </p>
                        <ul class="space-y-1.5 text-xs text-slate-300">
                            {% for o in offers %}
                            <li>
                                ID {{ o.id }} — {{ o.price }} ₽, {{ o.eta_hours }} ч.
                                {% if o.service_center_id == service_center.id %}
                                <span class="text-emerald-300">(это вы)</span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <p class="text-sm text-slate-300">
                Не удалось загрузить данные заявки.
            </p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
