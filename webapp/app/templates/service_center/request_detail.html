<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>–ó–∞—è–≤–∫–∞ ‚Ä¢ –°–¢–û</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
<div class="max-w-6xl mx-auto p-4 sm:p-6 space-y-6">

    <div class="flex items-start justify-between gap-4">
        <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–ö–∞—Ä–ë–æ—Ç ‚Ä¢ –°–¢–û</p>
            <h1 class="text-xl sm:text-2xl font-semibold mt-1">–ó–∞—è–≤–∫–∞ ‚Ññ{{ req.id if req else "‚Äî" }}</h1>
        </div>

        <a href="/sc/{{ service_center.id }}/requests"
           class="inline-flex items-center gap-2 rounded-full border border-slate-800 bg-slate-900/60 px-4 py-2 text-sm font-semibold hover:bg-slate-900 transition">
            ‚Üê –ù–∞–∑–∞–¥
        </a>
    </div>

    {% if not req %}
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
            <p class="text-sm text-slate-300">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞—è–≤–∫—É.</p>
        </div>
    {% else %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∑–∞—è–≤–∫–∞ -->
        <div class="lg:col-span-2 space-y-6">

            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 space-y-4">
                <div class="flex flex-wrap items-center gap-3 justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-xs uppercase tracking-[0.25em] text-slate-400">–°—Ç–∞—Ç—É—Å</span>
                        <span class="inline-flex items-center rounded-full border border-slate-800 bg-slate-900/60 px-3 py-1 text-xs font-semibold">
                            {{ req.status }}
                        </span>
                    </div>

                    <div class="flex items-center gap-2">
                        {% if req.status == "accepted_by_service" %}
                        <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/set-in-work">
                            <button type="submit"
                                    class="rounded-full bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 text-sm font-semibold transition">
                                ‚ñ∂ –í —Ä–∞–±–æ—Ç—É
                            </button>
                        </form>
                        {% endif %}

                        {% if req.status == "in_work" %}
                        <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/set-done" class="flex items-center gap-2">
                            <input type="number" step="0.01" name="final_price"
                                   placeholder="–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞"
                                   class="w-40 rounded-full border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                            <button type="submit"
                                    class="rounded-full bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 text-sm font-semibold transition">
                                ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</p>
                        <p class="text-sm text-slate-200 mt-1">{{ req.category or "‚Äî" }}</p>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–ê–≤—Ç–æ</p>
                        <p class="text-sm text-slate-200 mt-1">
                            {{ req.car_brand or "" }} {{ req.car_model or "" }} {{ req.car_year or "" }}
                        </p>
                    </div>
                </div>

                <div>
                    <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–û–ø–∏—Å–∞–Ω–∏–µ</p>
                    <p class="text-sm text-slate-200 mt-1 whitespace-pre-line">{{ req.description or "‚Äî" }}</p>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–õ–æ–∫–∞—Ü–∏—è</p>
                        <p class="text-sm text-slate-200 mt-1">
                            {{ req.address or "‚Äî" }}
                        </p>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–≠–≤–∞–∫—É–∞—Ü–∏—è / –í—ã–µ–∑–¥</p>
                        <p class="text-sm text-slate-200 mt-1">
                            {% if req.need_tow %}–î–∞{% else %}–ù–µ—Ç{% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- –û—Ç–∫–ª–∏–∫–∏ –ø–æ –∑–∞—è–≤–∫–µ -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 space-y-3">
                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                    –û—Ç–∫–ª–∏–∫–∏ (–≤—Å–µ –°–¢–û)
                </p>

                {% if offers and offers|length > 0 %}
                    <div class="space-y-3">
                        {% for o in offers %}
                        <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
                            <div class="flex items-start justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="text-sm font-semibold">
                                        –°–¢–û #{{ o.service_center_id }}
                                    </div>
                                    <div class="text-xs text-slate-400 mt-1">
                                        {{ o.status or "‚Äî" }}
                                    </div>
                                </div>
                                <div class="text-right text-sm text-slate-200">
                                    <div class="font-semibold">{{ o.price or "‚Äî" }}</div>
                                    <div class="text-xs text-slate-400 mt-1">{{ o.eta_hours or "‚Äî" }} —á.</div>
                                </div>
                            </div>

                            {% if o.comment %}
                            <div class="text-sm text-slate-300 mt-3 whitespace-pre-line">{{ o.comment }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-sm text-slate-300">–û—Ç–∫–ª–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
                {% endif %}
            </div>

        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Å–≤—è–∑–∏/—á–∞—Ç/–æ—Ç–∫–ª–∏–∫ -->
        <div class="space-y-6">

            <!-- –ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 space-y-3">
                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                    –°–≤—è–∑—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º
                </p>

                {% if client_telegram_id %}
                <a class="w-full inline-flex items-center justify-center gap-2 rounded-2xl bg-slate-800 hover:bg-slate-700 text-slate-100 py-2.5 text-sm font-semibold transition"
                   href="https://t.me/{{ bot_username }}?start=chat_{{ req.id }}">
                    üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É (Telegram)
                </a>
                {% else %}
                <button type="button"
                        class="w-full rounded-2xl bg-slate-800/60 text-slate-300 py-2.5 text-sm font-semibold cursor-not-allowed"
                        disabled>
                    Telegram –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                </button>
                {% endif %}
            </div>

            <!-- –í–∞—à –æ—Ç–∫–ª–∏–∫ -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-3">
                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                    –í–∞—à –æ—Ç–∫–ª–∏–∫
                </p>

                {% if my_offer %}
                <p class="text-sm text-slate-300">
                    –í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ—Ç–∫–ª–∏–∫ –ø–æ —ç—Ç–æ–π –∑–∞—è–≤–∫–µ. –í—ã –º–æ–∂–µ—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ.
                </p>
                <ul class="text-xs text-slate-300 space-y-1">
                    <li>–¶–µ–Ω–∞: <span class="font-semibold">{{ my_offer.price }}</span></li>
                    <li>–°—Ä–æ–∫: <span class="font-semibold">{{ my_offer.eta_hours }} —á.</span></li>
                    {% if my_offer.comment %}
                    <li>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: <span class="font-semibold">{{ my_offer.comment }}</span></li>
                    {% endif %}
                    {% if my_offer.status %}
                    <li>–°—Ç–∞—Ç—É—Å: <span class="font-semibold">{{ my_offer.status }}</span></li>
                    {% endif %}
                </ul>
                {% endif %}

                {% set offer_locked = req.status in ["in_work", "done", "cancelled"] %}
                {% if not offer_locked %}

                <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/offer" class="space-y-3">
                    <div class="grid grid-cols-1 gap-3">
                        <div class="space-y-1.5">
                            <label class="block text-xs font-semibold text-slate-300">
                                –¶–µ–Ω–∞, ‚ÇΩ
                            </label>
                            <input type="number" step="0.01" min="0" name="price"
                                   value="{{ my_offer.price if my_offer else '' }}"
                                   required
                                   class="w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                        </div>
                        <div class="space-y-1.5">
                            <label class="block text-xs font-semibold text-slate-300">
                                –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Å—Ä–æ–∫, —á.
                            </label>
                            <input type="number" min="1" name="eta_hours"
                                   value="{{ my_offer.eta_hours if my_offer else '' }}"
                                   required
                                   class="w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
                        </label>
                        <textarea name="comment" rows="4"
                                  class="w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40"
                                  placeholder="–£—Ç–æ—á–Ω–µ–Ω–∏—è, –¥–µ—Ç–∞–ª–∏, —á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —Ü–µ–Ω—É...">{{ my_offer.comment if my_offer else '' }}</textarea>
                    </div>

                    <button type="submit"
                            class="w-full rounded-2xl bg-emerald-600 hover:bg-emerald-500 text-white py-2.5 text-sm font-semibold transition">
                        {% if my_offer %}üîÑ –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫{% else %}üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫{% endif %}
                    </button>
                </form>

                {% else %}
                <p class="text-sm text-slate-300">
                    –û—Ç–∫–ª–∏–∫ –ø–æ —ç—Ç–æ–π –∑–∞—è–≤–∫–µ –±–æ–ª—å—à–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –∑–∞—è–≤–∫–∞ –≤ —Ä–∞–±–æ—Ç–µ –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç–∞.
                </p>
                {% endif %}

                {% if error_message %}
                <p class="text-xs text-rose-300">{{ error_message }}</p>
                {% endif %}
            </div>

        </div>
    </div>

    {% endif %}
</div>
</body>
</html>
