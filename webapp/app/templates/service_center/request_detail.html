{% extends "layout/base.html" %}

{% block title %}–ó–∞—è–≤–∫–∞ ‚Ññ{{ req.id if req else "" }} ‚Äî {{ service_center.name }}{% endblock %}

{% block content %}
{# ‚úÖ –ª–æ–∫–∞–ª—å–Ω—ã–π mapping –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è UI #}
{% set category_labels = {
    "sto": "–°–¢–û / –æ–±—â–∏–π —Ä–µ–º–æ–Ω—Ç",
    "wash": "–ê–≤—Ç–æ–º–æ–π–∫–∞",
    "tire": "–®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂",
    "electric": "–ê–≤—Ç–æ—ç–ª–µ–∫—Ç—Ä–∏–∫",
    "mechanic": "–°–ª–µ—Å–∞—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
    "paint": "–ú–∞–ª—è—Ä–Ω—ã–µ / –∫—É–∑–æ–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
    "maint": "–¢–û / –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ",
    "agg_turbo": "–†–µ–º–æ–Ω—Ç —Ç—É—Ä–±–∏–Ω",
    "agg_starter": "–†–µ–º–æ–Ω—Ç —Å—Ç–∞—Ä—Ç–µ—Ä–æ–≤",
    "agg_generator": "–†–µ–º–æ–Ω—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤",
    "agg_steering": "–†—É–ª–µ–≤—ã–µ —Ä–µ–π–∫–∏",
    "mech": "–°–ª–µ—Å–∞—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
    "elec": "–ê–≤—Ç–æ—ç–ª–µ–∫—Ç—Ä–∏–∫",
    "body": "–ú–∞–ª—è—Ä–Ω—ã–µ / –∫—É–∑–æ–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
    "diag": "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞",
    "agg": "–†–µ–º–æ–Ω—Ç –∞–≥—Ä–µ–≥–∞—Ç–æ–≤"
} %}

<div class="mt-8 space-y-6">
    <a href="/sc/{{ service_center.id }}/requests" class="text-xs text-slate-400 hover:text-emerald-400 transition">
        ‚Üê –ö–æ –≤—Å–µ–º –∑–∞—è–≤–∫–∞–º —Å–µ—Ä–≤–∏—Å–∞
    </a>

    <div class="relative">
        <div class="absolute inset-0 rounded-3xl bg-slate-900/70 backdrop-blur-2xl border border-slate-800"></div>

        <div class="relative z-10 p-6 md:p-8 space-y-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <p class="text-xs uppercase tracking-[0.25em] text-emerald-400/80 mb-1">
                        –ó–∞—è–≤–∫–∞ ‚Ññ{{ req.id if req else "‚Äî" }}
                    </p>
                    <h1 class="text-2xl font-semibold">
                        {{ category_labels.get(req.service_category, req.service_category) if req and req.service_category else "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" }}
                    </h1>
                    {% if req and req.status %}
                    <p class="text-sm text-slate-300 mt-1">
                        –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: <span class="font-semibold">{{ req.status }}</span>
                    </p>
                    {% endif %}
                </div>
                {% if service_center %}
                <div class="text-xs text-slate-400">
                    <p class="mb-1">–°–µ—Ä–≤–∏—Å:</p>
                    <p class="font-semibold text-slate-100">{{ service_center.name }}</p>
                    {% if service_center.address %}
                    <p>{{ service_center.address }}</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            {% if error_message %}
            <div class="rounded-2xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-100">
                {{ error_message }}
            </div>
            {% endif %}

            {% if req %}
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">

                    <!-- –ê–≤—Ç–æ–º–æ–±–∏–ª—å -->
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-2">
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                            –ê–≤—Ç–æ–º–æ–±–∏–ª—å
                        </p>

                        {% if req.car %}
                            <p class="text-sm text-slate-100">
                                {{ req.car.brand }} {{ req.car.model }}
                                {% if req.car.year %}({{ req.car.year }} –≥.){% endif %}
                            </p>
                            {% if req.car.license_plate %}
                            <p class="text-xs text-slate-400">
                                –ì–æ—Å–Ω–æ–º–µ—Ä: {{ req.car.license_plate }}
                            </p>
                            {% endif %}
                        {% else %}
                            <p class="text-sm text-slate-300">
                                –î–∞–Ω–Ω—ã–µ –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.
                                {% if req.car_id %}
                                <span class="text-slate-400">ID –∞–≤—Ç–æ: {{ req.car_id }}</span>
                                {% endif %}
                            </p>
                        {% endif %}
                    </div>

                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-2">
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                            –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
                        </p>
                        <p class="text-sm text-slate-100 whitespace-pre-line">
                            {{ req.description or "–ö–ª–∏–µ–Ω—Ç –Ω–µ —É–∫–∞–∑–∞–ª –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π." }}
                        </p>
                    </div>

                    <!-- –ê–¥—Ä–µ—Å -->
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-2">
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                            –ê–¥—Ä–µ—Å / —Ä–∞–π–æ–Ω
                        </p>
                        <p class="text-sm text-slate-100">
                            {{ req.address_text or "–ù–µ —É–∫–∞–∑–∞–Ω" }}
                        </p>
                    </div>

                    <!-- –ò—Ç–æ–≥ / –æ—Ç–∫–∞–∑ -->
                    {% if req.status == "done" %}
                    <div class="rounded-2xl border border-emerald-500/30 bg-emerald-500/10 p-4 space-y-1">
                        <p class="text-sm text-emerald-200 font-semibold">‚úÖ –ó–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</p>
                        {% if req.final_price is not none %}
                        <p class="text-sm text-emerald-100/90">
                            –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞: <b>{{ req.final_price }}</b>
                        </p>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if req.status == "rejected_by_service" %}
                    <div class="rounded-2xl border border-red-500/30 bg-red-500/10 p-4 space-y-1">
                        <p class="text-sm text-red-200 font-semibold">‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ —Å–µ—Ä–≤–∏—Å–æ–º</p>
                        {% if req.reject_reason %}
                        <p class="text-sm text-red-100/90">
                            –ü—Ä–∏—á–∏–Ω–∞: <b>{{ req.reject_reason }}</b>
                        </p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <div class="space-y-4">

                    <!-- ‚úÖ –ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º -->
                    {% if req and service_center %}
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-2">
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                            –ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º
                        </p>

                        <button type="button"
                                onclick="sendChatLinkAndClose('/sc/{{ service_center.id }}/requests/{{ req.id }}/send-chat-link', '{{ bot_username }}')"
                                class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-800 px-5 py-2 text-xs font-semibold text-slate-100 border border-slate-700 hover:bg-slate-700 transition">
                            üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É (–∫–Ω–æ–ø–∫–∞ –ø—Ä–∏–¥—ë—Ç –≤ –±–æ—Ç–µ)
                        </button>
                        <p class="text-[11px] text-slate-400">
                            –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–æ—Ç–µ —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ –ø–æ –∑–∞—è–≤–∫–µ.
                        </p>
                    </div>
                    {% endif %}

                    <!-- –í–∞—à –æ—Ç–∫–ª–∏–∫ -->
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-3">
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                            –í–∞—à –æ—Ç–∫–ª–∏–∫
                        </p>

                        {% if my_offer %}
                        <p class="text-sm text-slate-300">
                            –í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ—Ç–∫–ª–∏–∫ –ø–æ —ç—Ç–æ–π –∑–∞—è–≤–∫–µ. –í—ã –º–æ–∂–µ—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ.
                        </p>
                        <ul class="text-xs text-slate-300 space-y-1">
                            <li>–¶–µ–Ω–∞: <span class="font-semibold">{{ my_offer.price }}</span></li>
                            <li>–°—Ä–æ–∫: <span class="font-semibold">{{ my_offer.eta_hours }} —á.</span></li>
                            {% if my_offer.comment %}
                            <li>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: <span class="font-semibold">{{ my_offer.comment }}</span></li>
                            {% endif %}
                            {% if my_offer.status %}
                            <li>–°—Ç–∞—Ç—É—Å: <span class="font-semibold">{{ my_offer.status }}</span></li>
                            {% endif %}
                        </ul>
                        {% else %}
                        <p class="text-sm text-slate-300">
                            –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —Ü–µ–Ω–µ –∏ —Å—Ä–æ–∫–∞–º. –ö–ª–∏–µ–Ω—Ç —É–≤–∏–¥–∏—Ç –µ–≥–æ –≤ —Å–≤–æ—ë–º –∫–∞–±–∏–Ω–µ—Ç–µ –∏ —Å–º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –≤–∞—à —Å–µ—Ä–≤–∏—Å.
                        </p>
                        {% endif %}

                        <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/offer" class="space-y-3">
                            <div class="grid grid-cols-1 gap-3">
                                <div class="space-y-1.5">
                                    <label class="block text-xs font-semibold text-slate-300">
                                        –¶–µ–Ω–∞, ‚ÇΩ
                                    </label>
                                    <input type="number" step="0.01" min="0" name="price"
                                           value="{{ my_offer.price if my_offer else '' }}"
                                           required
                                           class="w-full rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                                </div>
                                <div class="space-y-1.5">
                                    <label class="block text-xs font-semibold text-slate-300">
                                        –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Å—Ä–æ–∫, —á.
                                    </label>
                                    <input type="number" min="1" name="eta_hours"
                                           value="{{ my_offer.eta_hours if my_offer else '' }}"
                                           required
                                           class="w-full rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                                </div>
                            </div>

                            <div class="space-y-1.5">
                                <label class="block text-xs font-semibold text-slate-300">
                                    –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
                                </label>
                                <textarea name="comment" rows="3"
                                          class="w-full rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40"
                                          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤ –ø–æ–¥–∞—Ä–æ–∫ –ø—Ä–∏ —Ä–µ–º–æ–Ω—Ç–µ¬ª.">{{ my_offer.comment if my_offer else "" }}</textarea>
                            </div>

                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 pt-2">
                                <p class="text-xs text-slate-400">
                                    –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∫–ª–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç —É–≤–∏–¥–∏—Ç –µ–≥–æ –≤ —Å–≤–æ—ë–º –∫–∞–±–∏–Ω–µ—Ç–µ –∏ —Å–º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –≤–∞—à —Å–µ—Ä–≤–∏—Å.
                                </p>
                                <button type="submit"
                                        class="inline-flex items-center justify-center gap-2 rounded-full bg-emerald-500 px-6 py-2.5 text-sm font-semibold text-slate-900 shadow-lg shadow-emerald-500/30 hover:bg-emerald-400 transition">
                                    {% if my_offer %}–û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫{% else %}–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫{% endif %}
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- –î–µ–π—Å—Ç–≤–∏—è –ø–æ –∑–∞—è–≤–∫–µ (–°–¢–û) -->
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-3">
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                            –î–µ–π—Å—Ç–≤–∏—è –ø–æ –∑–∞—è–≤–∫–µ
                        </p>

                        {% if req.status == "accepted_by_service" %}
                        <div class="flex flex-wrap gap-2">
                            <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/set-in-work">
                                <button type="submit"
                                        class="inline-flex items-center justify-center rounded-full bg-amber-400 px-5 py-2 text-sm font-semibold text-slate-900 hover:bg-amber-300 transition">
                                    –í —Ä–∞–±–æ—Ç—É
                                </button>
                            </form>

                            <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/reject"
                                  class="flex flex-wrap gap-2 items-center">
                                <input name="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞"
                                       class="w-64 rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 outline-none focus:border-red-400">
                                <button type="submit"
                                        class="inline-flex items-center justify-center rounded-full border border-red-400/70 px-5 py-2 text-sm font-semibold text-red-200 hover:bg-red-500/10 transition">
                                    –û—Ç–∫–∞–∑–∞—Ç—å
                                </button>
                            </form>
                        </div>

                        {% elif req.status == "in_work" %}
                        <div class="space-y-2">
                            <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/set-done"
                                  class="flex flex-wrap gap-2 items-center">
                                <input type="number" step="0.01" min="0" name="final_price" required
                                       placeholder="–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞, ‚ÇΩ"
                                       class="w-64 rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 outline-none focus:border-emerald-400">
                                <button type="submit"
                                        class="inline-flex items-center justify-center rounded-full bg-emerald-500 px-6 py-2 text-sm font-semibold text-slate-900 hover:bg-emerald-400 transition">
                                    –ó–∞–≤–µ—Ä—à–∏—Ç—å
                                </button>
                            </form>

                            <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/reject"
                                  class="flex flex-wrap gap-2 items-center">
                                <input name="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞"
                                       class="w-64 rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 outline-none focus:border-red-400">
                                <button type="submit"
                                        class="inline-flex items-center justify-center rounded-full border border-red-400/70 px-5 py-2 text-sm font-semibold text-red-200 hover:bg-red-500/10 transition">
                                    –û—Ç–∫–∞–∑–∞—Ç—å
                                </button>
                            </form>
                        </div>

                        {% elif req.status == "done" %}
                        <p class="text-sm text-emerald-200">
                            ‚úÖ –ó–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.
                            {% if req.final_price is not none %}
                            –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞: <b>{{ req.final_price }}</b>
                            {% endif %}
                        </p>

                        {% elif req.status == "rejected_by_service" %}
                        <p class="text-sm text-red-200">
                            ‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.
                            {% if req.reject_reason %}
                            –ü—Ä–∏—á–∏–Ω–∞: <b>{{ req.reject_reason }}</b>
                            {% endif %}
                        </p>

                        {% else %}
                        <p class="text-sm text-slate-400">
                            –î–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ—Ç.
                        </p>
                        {% endif %}
                    </div>

                </div>
            </div>
            {% else %}
            <p class="text-sm text-slate-300">
                –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏.
            </p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
