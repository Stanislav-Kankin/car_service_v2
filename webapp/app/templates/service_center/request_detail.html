{% extends "layout/base.html" %}

{% block title %}–ó–∞—è–≤–∫–∞ ‚Ññ{{ req.id if req else request_id }}{% endblock %}

{% block content %}

<div class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <div class="flex items-center justify-between gap-3">
        <a href="/sc/{{ service_center.id }}/requests"
           class="text-sm text-slate-300 hover:text-slate-100 transition">‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞—è–≤–∫–∞–º</a>

        <div class="text-xs text-slate-400">
            –°–¢–û: <span class="text-slate-200 font-semibold">{{ service_center.name }}</span>
        </div>
    </div>

    {% if error_message %}
      <div class="rounded-2xl border border-rose-500/30 bg-rose-900/10 p-4 text-sm text-rose-200">
        {{ error_message }}
      </div>
    {% endif %}

    {% if not req %}
      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6 text-slate-200">
        –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.
      </div>
    {% else %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¥–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ -->
        <div class="lg:col-span-2 space-y-6">
            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 space-y-4">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-100">–ó–∞—è–≤–∫–∞ ‚Ññ{{ req.id }}</h2>
                        <p class="text-xs text-slate-400 mt-1">
                            –°—Ç–∞—Ç—É—Å: <span class="text-slate-200 font-semibold">{{ req.status }}</span>
                        </p>
                    </div>

                    {% if req.car %}
                        <div class="text-right">
                            <p class="text-xs text-slate-400">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</p>
                            <p class="text-sm text-slate-100 font-semibold">
                                {{ req.car.brand }} {{ req.car.model }} {% if req.car.year %}({{ req.car.year }}){% endif %}
                            </p>
                            {% if req.car.plate_number %}
                                <p class="text-xs text-slate-400 mt-0.5">{{ req.car.plate_number }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2 border-t border-slate-800/70">
                    <div>
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</p>
                        <p class="text-sm text-slate-200 mt-1">{{ req.service_category or "‚Äî" }}</p>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–†–∞–¥–∏—É—Å</p>
                        <p class="text-sm text-slate-200 mt-1">{{ req.radius_km or "‚Äî" }} –∫–º</p>
                    </div>
                    <div class="sm:col-span-2">
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–û–ø–∏—Å–∞–Ω–∏–µ</p>
                        <p class="text-sm text-slate-200 mt-1 whitespace-pre-wrap break-words">{{ req.description or "‚Äî" }}</p>
                    </div>

                    <div>
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–õ–æ–∫–∞—Ü–∏—è</p>
                        <p class="text-sm text-slate-200 mt-1 break-words">
                            {{ req.address_text or req.address or "‚Äî" }}
                        </p>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–≠–≤–∞–∫—É–∞—Ü–∏—è / –í—ã–µ–∑–¥</p>
                        <p class="text-sm text-slate-200 mt-1">
                            {% if req.need_tow_truck or req.need_mobile_master or req.need_tow %}–î–∞{% else %}–ù–µ—Ç{% endif %}
                        </p>
                    </div>
                </div>

                {% if req.status == "done" and (req.final_price_text or req.final_price) %}
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2 border-t border-slate-800/70">
                    <div>
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞</p>
                        <p class="text-sm text-slate-200 mt-1">
                            {{ req.final_price_text or req.final_price }}
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>

        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Å–≤—è–∑—å/–æ—Ç–∫–ª–∏–∫/–∑–∞–∫—Ä—ã—Ç–∏–µ -->
        <div class="space-y-6">

            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 space-y-3">
                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                    –°–≤—è–∑—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º
                </p>

                {% set is_closed = req.status in ["done", "cancelled"] %}

                {% if is_closed %}
                <div class="w-full rounded-2xl bg-slate-800/50 text-slate-300 py-2.5 text-sm font-semibold text-center">
                    –ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞ ‚Äî –∫–Ω–æ–ø–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
                </div>
                {% else %}
                    {% if client_telegram_id %}
                    <button type="button" id="sendChatLinkBtn"
                            class="w-full inline-flex items-center justify-center gap-2 rounded-2xl bg-slate-800 hover:bg-slate-700 text-slate-100 py-2.5 text-sm font-semibold transition">
                        üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É (Telegram)
                    </button>
                    <p class="mt-2 text-[11px] text-slate-400">
                        –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–æ—Ç–µ —Å –∫–Ω–æ–ø–∫–æ–π, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–∫—Ä–æ–µ—Ç –ø—Ä—è–º–æ–π —á–∞—Ç.
                    </p>
                    {% else %}
                    <button type="button"
                            class="w-full rounded-2xl bg-slate-800/60 text-slate-300 py-2.5 text-sm font-semibold cursor-not-allowed"
                            disabled>
                        Telegram –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                    </button>
                    {% endif %}
                {% endif %}
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-3">
                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                    –í–∞—à –æ—Ç–∫–ª–∏–∫
                </p>

                {% if my_offer %}
                <ul class="text-xs text-slate-300 space-y-1">
                    <li>–¶–µ–Ω–∞: <span class="font-semibold">{{ my_offer.price_text or my_offer.price or "‚Äî" }}</span></li>
                    <li>–°—Ä–æ–∫: <span class="font-semibold">{{ my_offer.eta_text or (my_offer.eta_hours ~ " —á.") or "‚Äî" }}</span></li>
                    {% if my_offer.comment %}
                    <li>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: <span class="font-semibold">{{ my_offer.comment }}</span></li>
                    {% endif %}
                    {% if my_offer.status %}
                    <li>–°—Ç–∞—Ç—É—Å: <span class="font-semibold">{{ offer_status_labels.get(my_offer.status, my_offer.status) }}</span></li>
                    {% endif %}
                </ul>
                {% endif %}

                {% set offer_locked = req.status in ["accepted_by_service", "in_work", "done", "cancelled", "rejected_by_service"] %}
                {% set is_done = req.status == "done" %}

                {% if not offer_locked and not is_done %}
                <p class="text-sm text-slate-300">
                    {% if my_offer %}
                        –í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ—Ç–∫–ª–∏–∫. –í—ã –º–æ–∂–µ—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ.
                    {% else %}
                        –û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—Ç–∫–ª–∏–∫ –ø–æ —ç—Ç–æ–π –∑–∞—è–≤–∫–µ.
                    {% endif %}
                </p>

                <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/offer" class="space-y-3">
                    <div class="grid grid-cols-1 gap-3">
                        <div class="space-y-1.5">
                            <label class="block text-xs font-semibold text-slate-300">
                                –°—Ç–æ–∏–º–æ—Å—Ç—å (—Å–≤–æ–±–æ–¥–Ω–æ)
                            </label>
                            <input type="text" name="price_text"
                                   value="{{ (my_offer.price_text if my_offer else '') or (my_offer.price if my_offer else '') }}"
                                   required
                                   placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 5000 / –æ—Ç 5000 / 5000‚Äì7000 / –ø–æ—Å–ª–µ –æ—Å–º–æ—Ç—Ä–∞"
                                   class="w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                        </div>
                        <div class="space-y-1.5">
                            <label class="block text-xs font-semibold text-slate-300">
                                –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Å—Ä–æ–∫ (—Å–≤–æ–±–æ–¥–Ω–æ)
                            </label>
                            <input type="text" name="eta_text"
                                   value="{{ (my_offer.eta_text if my_offer else '') or ((my_offer.eta_hours ~ ' —á.') if my_offer and my_offer.eta_hours else '') }}"
                                   required
                                   placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 15 –º–∏–Ω—É—Ç / 1 —á–∞—Å / –≤ —Ç–µ—á–µ–Ω–∏–µ 2-—Ö –¥–Ω–µ–π"
                                   class="w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
                        </label>
                        <textarea name="comment" rows="4"
                                  class="w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40"
                                  placeholder="–£—Ç–æ—á–Ω–µ–Ω–∏—è, –¥–µ—Ç–∞–ª–∏, —á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —Ü–µ–Ω—É.">{{ my_offer.comment if my_offer else '' }}</textarea>
                    </div>

                    <button type="submit"
                            class="w-full rounded-2xl bg-emerald-600 hover:bg-emerald-500 text-white py-2.5 text-sm font-semibold transition">
                        {% if my_offer %}üîÑ –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫{% else %}üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫{% endif %}
                    </button>
                </form>
                {% else %}
                    <p class="text-sm text-slate-300">
                        {% if is_done %}
                            –ó–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚Äî –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.
                        {% elif req.status == "accepted_by_service" %}
                            –ö–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª –≤–∞—à —Å–µ—Ä–≤–∏—Å ‚Äî –æ—Ç–∫–ª–∏–∫ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –∏ –±–æ–ª—å—à–µ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è.
                        {% elif req.status == "in_work" %}
                            –ó–∞—è–≤–∫–∞ –≤ —Ä–∞–±–æ—Ç–µ ‚Äî –æ—Ç–∫–ª–∏–∫ –±–æ–ª—å—à–µ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è.
                        {% else %}
                            –û—Ç–∫–ª–∏–∫ –ø–æ —ç—Ç–æ–π –∑–∞—è–≤–∫–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
                        {% endif %}
                    </p>
                {% endif %}
            </div>

        </div>
    </div>

    {% endif %}
</div>

<script>
(function () {
  const btn = document.getElementById('sendChatLinkBtn');
  if (!btn) return;

  btn.addEventListener('click', async () => {
    btn.disabled = true;
    const original = btn.innerText;
    btn.innerText = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶';
    try {
      const resp = await fetch('/sc/{{ service_center.id }}/requests/{{ req.id }}/send-chat-link', {
        method: 'POST',
        headers: { 'X-Requested-With': 'fetch' },
      });
      const data = await resp.json().catch(() => null);

      if (!resp.ok || !data || data.ok !== true) {
        const msg = (data && data.error) ? data.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –≤ Telegram. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
        alert(msg);
        return;
      }

      if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.close();
      } else {
        alert('–ì–æ—Ç–æ–≤–æ! –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞.');
      }
    } catch (e) {
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –≤ Telegram. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    } finally {
      btn.disabled = false;
      btn.innerText = original;
    }
  });
})();
</script>

{% endblock %}
