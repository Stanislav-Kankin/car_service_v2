{% extends "layout/base.html" %}

{% block title %}–ó–∞—è–≤–∫–∞ ‚Ññ{{ req.id }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-6 space-y-6">

    <div class="flex items-start justify-between gap-4">
        <div class="space-y-1">
            <h1 class="text-xl font-semibold text-slate-100">
                –ó–∞—è–≤–∫–∞ ‚Ññ{{ req.id }}
            </h1>
            <p class="text-xs text-slate-400">
                –°—Ç–∞—Ç—É—Å: <span class="font-semibold text-slate-200">{{ req.status }}</span>
                {% if req.created_at %}
                ¬∑ –°–æ–∑–¥–∞–Ω–∞: <span class="text-slate-300">{{ req.created_at }}</span>
                {% endif %}
            </p>
        </div>

        <a href="/sc/{{ service_center.id }}/requests"
           class="inline-flex items-center gap-2 rounded-2xl border border-slate-800 bg-slate-900/60 px-4 py-2 text-sm text-slate-200 hover:bg-slate-900 transition">
            ‚Üê –ö —Å–ø–∏—Å–∫—É –∑–∞—è–≤–æ–∫
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ -->
        <div class="lg:col-span-2 space-y-6">

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞—è–≤–∫–∏ -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 space-y-4">

                <div class="flex flex-wrap items-center gap-2">
                    {% if req.service_category %}
                    <span class="text-xs rounded-full border border-emerald-700/60 bg-emerald-950/30 px-3 py-1 text-emerald-200">
                        {{ req.service_category }}
                    </span>
                    {% endif %}

                    {% if req.radius_km %}
                    <span class="text-xs rounded-full border border-slate-700 bg-slate-900/50 px-3 py-1 text-slate-200">
                        –†–∞–¥–∏—É—Å: {{ req.radius_km }} –∫–º
                    </span>
                    {% endif %}

                    {% if req.is_car_movable is not none %}
                        {% if req.is_car_movable %}
                        <span class="text-xs rounded-full border border-slate-700 bg-slate-900/50 px-3 py-1 text-slate-200">
                            –ê–≤—Ç–æ –Ω–∞ —Ö–æ–¥—É
                        </span>
                        {% else %}
                        <span class="text-xs rounded-full border border-amber-700/60 bg-amber-950/30 px-3 py-1 text-amber-200">
                            –ù—É–∂–Ω–∞ —ç–≤–∞–∫—É–∞—Ü–∏—è / –≤—ã–µ–∑–¥
                        </span>
                        {% endif %}
                    {% endif %}
                </div>

                <div class="space-y-2">
                    <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                        –û–ø–∏—Å–∞–Ω–∏–µ
                    </p>
                    <p class="text-sm text-slate-200 leading-relaxed whitespace-pre-line">
                        {{ req.description }}
                    </p>
                </div>

                {% if req.address_text %}
                <div class="space-y-1">
                    <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                        –õ–æ–∫–∞—Ü–∏—è
                    </p>
                    <p class="text-sm text-slate-200">
                        {{ req.address_text }}
                    </p>
                </div>
                {% endif %}

                {% if req.car %}
                <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 space-y-2">
                    <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                        –ê–≤—Ç–æ–º–æ–±–∏–ª—å
                    </p>
                    <div class="text-sm text-slate-200 space-y-1">
                        <div>
                            <span class="text-slate-400">–ú–∞—Ä–∫–∞/–º–æ–¥–µ–ª—å:</span>
                            <span class="font-semibold">{{ req.car.brand }} {{ req.car.model }}</span>
                        </div>
                        {% if req.car.year %}
                        <div>
                            <span class="text-slate-400">–ì–æ–¥:</span>
                            <span class="font-semibold">{{ req.car.year }}</span>
                        </div>
                        {% endif %}
                        {% if req.car.plate_number %}
                        <div>
                            <span class="text-slate-400">–ù–æ–º–µ—Ä:</span>
                            <span class="font-semibold">{{ req.car.plate_number }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

            </div>

            <!-- –î–µ–π—Å—Ç–≤–∏—è –ø–æ –∑–∞—è–≤–∫–µ -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 space-y-4">
                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                    –î–µ–π—Å—Ç–≤–∏—è
                </p>

                {% set assigned_to_me = (req.service_center_id is not none) and (req.service_center_id == service_center.id) %}

                {% if req.status == 'accepted_by_service' and assigned_to_me %}
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/set-in-work">
                        <button type="submit"
                                class="w-full rounded-2xl bg-emerald-600 hover:bg-emerald-500 text-white py-2.5 text-sm font-semibold transition">
                            üõ† –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É
                        </button>
                    </form>
                </div>
                {% elif req.status == 'in_work' and assigned_to_me %}
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/set-done" class="space-y-2">
                        <div class="space-y-1.5">
                            <label class="block text-xs font-semibold text-slate-300">
                                –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞, ‚ÇΩ
                            </label>
                            <input type="number" step="0.01" min="0" name="final_price"
                                   value="{{ req.final_price if req.final_price else '' }}"
                                   required
                                   class="w-full rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                        </div>
                        <button type="submit"
                                class="w-full rounded-2xl bg-sky-600 hover:bg-sky-500 text-white py-2.5 text-sm font-semibold transition">
                            ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å
                        </button>
                    </form>
                </div>
                {% else %}
                <p class="text-sm text-slate-300">
                    –î–µ–π—Å—Ç–≤–∏—è —Å—Ç–∞–Ω—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç –≤—ã–±–µ—Ä–µ—Ç –≤–∞—à –æ—Ç–∫–ª–∏–∫.
                </p>
                {% endif %}

                {% if assigned_to_me and req.status in ['sent', 'accepted_by_service', 'in_work'] %}
                <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/reject" class="space-y-2">
                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                        </label>
                        <input type="text" name="reason" value=""
                               class="w-full rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40"
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω–µ—Ç –º–µ—Å—Ç / –Ω–µ –Ω–∞—à–∞ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è">
                    </div>
                    <button type="submit"
                            class="w-full rounded-2xl bg-rose-600 hover:bg-rose-500 text-white py-2.5 text-sm font-semibold transition">
                        ‚ùå –û—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –∑–∞—è–≤–∫–∏
                    </button>
                </form>
                {% endif %}
            </div>

        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Å–≤—è–∑–∏/—á–∞—Ç/–æ—Ç–∫–ª–∏–∫ -->
        <div class="space-y-6">

            <!-- –ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 space-y-3">
                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                    –°–≤—è–∑—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º
                </p>

                {% if client_telegram_id %}
                <a class="w-full inline-flex items-center justify-center rounded-2xl bg-slate-800 hover:bg-slate-700 text-slate-100 py-2.5 text-sm font-semibold transition"
                   href="https://t.me/{{ bot_username }}?start=chat_{{ req.id }}">
                    üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É (Telegram)
                </a>
                {% else %}
                <button type="button"
                        class="w-full rounded-2xl bg-slate-800 hover:bg-slate-700 text-slate-100 py-2.5 text-sm font-semibold transition">
                    üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É (–∫–Ω–æ–ø–∫–∞ –ø—Ä–∏–¥—ë—Ç –≤ –±–æ—Ç–µ)
                </button>
                <p class="text-[11px] text-slate-400">
                    –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–æ—Ç–µ —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ –ø–æ –∑–∞—è–≤–∫–µ.
                </p>
                {% endif %}
            </div>

            <!-- –í–∞—à –æ—Ç–∫–ª–∏–∫ -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-3">
                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                    –í–∞—à –æ—Ç–∫–ª–∏–∫
                </p>

                {% if my_offer %}
                <p class="text-sm text-slate-300">
                    –í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ—Ç–∫–ª–∏–∫ –ø–æ —ç—Ç–æ–π –∑–∞—è–≤–∫–µ. –í—ã –º–æ–∂–µ—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ.
                </p>
                <ul class="text-xs text-slate-300 space-y-1">
                    <li>–¶–µ–Ω–∞: <span class="font-semibold">{{ my_offer.price }}</span></li>
                    <li>–°—Ä–æ–∫: <span class="font-semibold">{{ my_offer.eta_hours }} —á.</span></li>
                    {% if my_offer.cashback_percent is not none %}
                    <li>–ö—ç—à–±–µ–∫: <span class="font-semibold">{{ my_offer.cashback_percent }}%</span></li>
                    {% endif %}
                    {% if my_offer.comment %}
                    <li>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: <span class="font-semibold">{{ my_offer.comment }}</span></li>
                    {% endif %}
                    {% if my_offer.status %}
                    <li>–°—Ç–∞—Ç—É—Å: <span class="font-semibold">{{ my_offer.status }}</span></li>
                    {% endif %}
                </ul>
                {% endif %}

                <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/offer" class="space-y-3">
                    <div class="grid grid-cols-1 gap-3">
                        <div class="space-y-1.5">
                            <label class="block text-xs font-semibold text-slate-300">
                                –¶–µ–Ω–∞, ‚ÇΩ
                            </label>
                            <input type="number" step="0.01" min="0" name="price"
                                   value="{{ my_offer.price if my_offer else '' }}"
                                   required
                                   class="w-full rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                        </div>
                        <div class="space-y-1.5">
                            <label class="block text-xs font-semibold text-slate-300">
                                –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Å—Ä–æ–∫, —á.
                            </label>
                            <input type="number" min="1" name="eta_hours"
                                   value="{{ my_offer.eta_hours if my_offer else '' }}"
                                   required
                                   class="w-full rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                        </div>
                        <div class="space-y-1.5">
                            <label class="block text-xs font-semibold text-slate-300">
                                –ö—ç—à–±–µ–∫, %
                            </label>
                            <input type="number" step="1" min="0" max="100" name="cashback_percent"
                                   value="{{ my_offer.cashback_percent if my_offer else '' }}"
                                   class="w-full rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40"
                                   placeholder="0‚Äì100">
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
                        </label>
                        <textarea name="comment" rows="3"
                                  class="w-full rounded-2xl border border-slate-700 bg-slate-900/70 px-3 py-2 text-slate-100 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40"
                                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–ü—Ä–∏–µ–∑–∂–∞–π—Ç–µ –∫ 14:00, —Å–¥–µ–ª–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∏ —Å–æ–æ–±—â–∏–º –ø–æ —Ä–µ–º–æ–Ω—Ç–µ¬ª.">{{ my_offer.comment if my_offer else "" }}</textarea>
                    </div>

                    <button type="submit"
                            class="w-full rounded-2xl bg-emerald-600 hover:bg-emerald-500 text-white py-2.5 text-sm font-semibold transition">
                        {% if my_offer %}üîÑ –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫{% else %}üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫{% endif %}
                    </button>
                </form>

                {% if error_message %}
                <p class="text-xs text-rose-300">{{ error_message }}</p>
                {% endif %}
            </div>

        </div>
    </div>

</div>
{% endblock %}
