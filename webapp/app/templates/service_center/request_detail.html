{% extends "layout/base.html" %}

{% block title %}–ó–∞—è–≤–∫–∞ ‚Ññ{{ req.id if req else "‚Äî" }} ‚Äî –°–¢–û{% endblock %}

{% block content %}
{% set category_labels = {
    "sto": "–°–¢–û / –æ–±—â–∏–π —Ä–µ–º–æ–Ω—Ç",
    "wash": "–ê–≤—Ç–æ–º–æ–π–∫–∞",
    "tire": "–®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂",
    "electric": "–ê–≤—Ç–æ—ç–ª–µ–∫—Ç—Ä–∏–∫",
    "mechanic": "–°–ª–µ—Å–∞—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
    "paint": "–ú–∞–ª—è—Ä–Ω—ã–µ / –∫—É–∑–æ–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
    "maint": "–¢–û / –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ",
    "agg_turbo": "–†–µ–º–æ–Ω—Ç —Ç—É—Ä–±–∏–Ω",
    "agg_starter": "–†–µ–º–æ–Ω—Ç —Å—Ç–∞—Ä—Ç–µ—Ä–æ–≤",
    "agg_generator": "–†–µ–º–æ–Ω—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤",
    "agg_steering": "–†—É–ª–µ–≤—ã–µ —Ä–µ–π–∫–∏",
    "mech": "–°–ª–µ—Å–∞—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
    "elec": "–ê–≤—Ç–æ—ç–ª–µ–∫—Ç—Ä–∏–∫",
    "body": "–ú–∞–ª—è—Ä–Ω—ã–µ / –∫—É–∑–æ–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",
    "diag": "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞",
    "agg": "–†–µ–º–æ–Ω—Ç –∞–≥—Ä–µ–≥–∞—Ç–æ–≤"
} %}

<div class="mt-8 space-y-6">
    <div class="flex items-start justify-between gap-4">
        <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–ö–∞—Ä–ë–æ—Ç ‚Ä¢ –°–¢–û</p>
            <h1 class="text-xl sm:text-2xl font-semibold mt-1">–ó–∞—è–≤–∫–∞ ‚Ññ{{ req.id if req else "‚Äî" }}</h1>
        </div>

        <a href="/sc/{{ service_center.id }}/requests"
           class="inline-flex items-center gap-2 rounded-full border border-slate-800 bg-slate-900/60 px-4 py-2 text-sm font-semibold hover:bg-slate-900 transition">
            ‚Üê –ù–∞–∑–∞–¥
        </a>
    </div>

    {% if not req %}
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
            <p class="text-sm text-slate-300">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞—è–≤–∫—É.</p>
        </div>
    {% else %}

    {% set category_code = req.service_category or req.category %}
    {% set address_text = req.address_text or req.address %}
    {% set car_obj = req.car if req.car is defined else None %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∑–∞—è–≤–∫–∞ -->
        <div class="lg:col-span-2 space-y-6">

            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 space-y-4">
                <div class="flex flex-wrap items-center gap-3 justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-xs uppercase tracking-[0.25em] text-slate-400">–°—Ç–∞—Ç—É—Å</span>
                        <span class="inline-flex items-center rounded-full border border-slate-800 bg-slate-950/40 px-3 py-1 text-xs font-semibold">
                            {{ req.status }}
                        </span>
                    </div>

                    <div class="flex items-center gap-2">
                        {% if req.status == "accepted_by_service" %}
                        <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/set-in-work">
                            <button type="submit"
                                    class="rounded-full bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 text-sm font-semibold transition">
                                ‚ñ∂ –í —Ä–∞–±–æ—Ç—É
                            </button>
                        </form>
                        {% endif %}

                        {% if req.status == "in_work" %}
                        <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/set-done" class="flex items-center gap-2">
                            <input type="number" step="0.01" name="final_price"
                                   placeholder="–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞"
                                   class="w-40 rounded-full border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                            <button type="submit"
                                    class="rounded-full bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 text-sm font-semibold transition">
                                ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</p>
                        <p class="text-sm text-slate-200 mt-1">
                            {% if category_code %}
                                {{ category_labels.get(category_code, category_code) }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </p>
                    </div>

                    <div>
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–ê–≤—Ç–æ</p>
                        <p class="text-sm text-slate-200 mt-1">
                            {% if car_obj %}
                                {{ car_obj.brand or "" }} {{ car_obj.model or "" }} {{ car_obj.year or "" }}
                                {% if car_obj.license_plate %} ¬∑ ‚Ññ {{ car_obj.license_plate }}{% endif %}
                            {% else %}
                                {{ req.car_brand or "" }} {{ req.car_model or "" }} {{ req.car_year or "" }}
                            {% endif %}
                        </p>
                    </div>
                </div>

                <div>
                    <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–û–ø–∏—Å–∞–Ω–∏–µ</p>
                    <p class="text-sm text-slate-200 mt-1 whitespace-pre-line">{{ req.description or "‚Äî" }}</p>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–õ–æ–∫–∞—Ü–∏—è</p>
                        <p class="text-sm text-slate-200 mt-1">
                            {{ address_text or "‚Äî" }}
                        </p>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">–≠–≤–∞–∫—É–∞—Ü–∏—è / –í—ã–µ–∑–¥</p>
                        <p class="text-sm text-slate-200 mt-1">
                            {% if req.is_car_movable is not none %}
                                {% if req.is_car_movable %}–ù–µ—Ç{% else %}–î–∞{% endif %}
                            {% else %}
                                {% if req.need_tow %}–î–∞{% else %}–ù–µ—Ç{% endif %}
                            {% endif %}
                        </p>
                    </div>
                </div>

                {% if req.hide_phone %}
                <div class="rounded-2xl border border-amber-500/30 bg-amber-500/10 px-4 py-3 text-xs text-amber-100">
                    ‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç —Å–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–æ –≤—ã–±–æ—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞ / —Å–æ–≥–ª–∞—Å–∏—è.
                </div>
                {% endif %}
            </div>

        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Å–≤—è–∑—å/—á–∞—Ç/–æ—Ç–∫–ª–∏–∫ -->
        <div class="space-y-6">

            <!-- –ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 space-y-3">
                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                    –°–≤—è–∑—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º
                </p>

                {% if client_telegram_id %}
                <a class="w-full inline-flex items-center justify-center gap-2 rounded-2xl bg-slate-800 hover:bg-slate-700 text-slate-100 py-2.5 text-sm font-semibold transition"
                   href="https://t.me/{{ bot_username }}?start=chat_{{ req.id }}">
                    üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É (Telegram)
                </a>
                <p class="text-[11px] text-slate-400">
                    –ú—ã –æ—Ç–∫—Ä–æ–µ–º —á–∞—Ç –ø–æ —ç—Ç–æ–π –∑–∞—è–≤–∫–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.
                </p>
                {% else %}
                <button type="button"
                        class="w-full rounded-2xl bg-slate-800/60 text-slate-300 py-2.5 text-sm font-semibold cursor-not-allowed"
                        disabled>
                    Telegram –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                </button>
                {% endif %}
            </div>

            <!-- –í–∞—à –æ—Ç–∫–ª–∏–∫ -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 space-y-3">
                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">
                    –í–∞—à –æ—Ç–∫–ª–∏–∫
                </p>

                {% if my_offer %}
                <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4">
                    <p class="text-sm text-slate-200 font-semibold">–¢–µ–∫—É—â–∏–π –æ—Ç–∫–ª–∏–∫</p>
                    <ul class="text-xs text-slate-300 space-y-1 mt-2">
                        <li>–¶–µ–Ω–∞: <span class="font-semibold">{{ my_offer.price }}</span></li>
                        <li>–°—Ä–æ–∫: <span class="font-semibold">{{ my_offer.eta_hours }} —á.</span></li>
                        {% if my_offer.comment %}
                        <li>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: <span class="font-semibold">{{ my_offer.comment }}</span></li>
                        {% endif %}
                        {% if my_offer.status %}
                        <li>–°—Ç–∞—Ç—É—Å: <span class="font-semibold">{{ my_offer.status }}</span></li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}

                {% set offer_locked = req.status in ["in_work", "done", "cancelled"] %}
                {% if not offer_locked %}

                <form method="post" action="/sc/{{ service_center.id }}/requests/{{ req.id }}/offer" class="space-y-3">
                    <div class="grid grid-cols-1 gap-3">
                        <div class="space-y-1.5">
                            <label class="block text-xs font-semibold text-slate-300">
                                –¶–µ–Ω–∞, ‚ÇΩ
                            </label>
                            <input type="number" step="0.01" min="0" name="price"
                                   value="{{ my_offer.price if my_offer else '' }}"
                                   required
                                   class="w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                        </div>
                        <div class="space-y-1.5">
                            <label class="block text-xs font-semibold text-slate-300">
                                –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Å—Ä–æ–∫, —á.
                            </label>
                            <input type="number" min="1" name="eta_hours"
                                   value="{{ my_offer.eta_hours if my_offer else '' }}"
                                   required
                                   class="w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
                        </label>
                        <textarea name="comment" rows="4"
                                  class="w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40"
                                  placeholder="–£—Ç–æ—á–Ω–µ–Ω–∏—è, –¥–µ—Ç–∞–ª–∏, —á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —Ü–µ–Ω—É...">{{ my_offer.comment if my_offer else '' }}</textarea>
                    </div>

                    <button type="submit"
                            class="w-full rounded-2xl bg-emerald-600 hover:bg-emerald-500 text-white py-2.5 text-sm font-semibold transition">
                        {% if my_offer %}üîÑ –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫{% else %}üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫{% endif %}
                    </button>
                </form>

                {% else %}
                <p class="text-sm text-slate-300">
                    –û—Ç–∫–ª–∏–∫ –ø–æ —ç—Ç–æ–π –∑–∞—è–≤–∫–µ –±–æ–ª—å—à–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –∑–∞—è–≤–∫–∞ –≤ —Ä–∞–±–æ—Ç–µ –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç–∞.
                </p>
                {% endif %}

                {% if error_message %}
                <p class="text-xs text-rose-300">{{ error_message }}</p>
                {% endif %}
            </div>

        </div>
    </div>

    {% endif %}
</div>
{% endblock %}
