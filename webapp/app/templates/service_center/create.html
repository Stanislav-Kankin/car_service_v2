{% extends "layout/base.html" %}

{% block title %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –°–¢–û ‚Äî CarBot{% endblock %}

{% block content %}
{% set fd = form_data or {} %}
<div class="mt-8 space-y-6">
    <a href="/me/dashboard" class="text-xs text-slate-400 hover:text-emerald-400 transition">
        ‚Üê –ù–∞–∑–∞–¥
    </a>

    <div class="relative">
        <div class="absolute inset-0 rounded-3xl bg-slate-900/70 backdrop-blur-2xl border border-slate-800"></div>

        <div class="relative z-10 p-6 md:p-8 space-y-6">
            <div>
                <p class="text-xs uppercase tracking-[0.25em] text-emerald-400/80 mb-1">
                    –°–¢–û
                </p>
                <h1 class="text-2xl md:text-3xl font-black text-slate-50 leading-tight">
                    –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞
                </h1>
                <p class="text-sm text-slate-400 mt-2 max-w-xl">
                    –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –º—ã –æ—Ç–ø—Ä–∞–≤–∏–º –∑–∞—è–≤–∫—É –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é.
                </p>
            </div>

            {% if error_message %}
            <div class="rounded-2xl bg-red-500/10 border border-red-500/30 p-4 text-sm text-red-200">
                {{ error_message }}
            </div>
            {% endif %}

            {% if success %}
            <div class="rounded-2xl bg-emerald-500/10 border border-emerald-500/30 p-4 text-sm text-emerald-200">
                ‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ú—ã —É–≤–µ–¥–æ–º–∏–º –≤–∞—Å –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.
            </div>
            {% endif %}

            <form method="post" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –ù–∞–∑–≤–∞–Ω–∏–µ
                        </label>
                        <input type="text" name="name" value="{{ fd.name or '' }}"
                           class="w-full rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3 text-sm text-slate-100 placeholder:text-slate-500 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40"
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–≤—Ç–æ–°–µ—Ä–≤–∏—Å ‚Ññ1" required>
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –¢–µ–ª–µ—Ñ–æ–Ω
                        </label>
                        <input type="text" name="phone" value="{{ fd.phone or '' }}"
                           class="w-full rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3 text-sm text-slate-100 placeholder:text-slate-500 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40"
                           placeholder="+7 900 000-00-00">
                    </div>
                </div>

                <div class="space-y-1.5">
                    <label class="block text-xs font-semibold text-slate-300">
                        –ê–¥—Ä–µ—Å
                    </label>
                    <input type="text" name="address" required value="{{ fd.address or '' }}"
                           class="w-full rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3 text-sm text-slate-100 placeholder:text-slate-500 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40"
                           placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º">
                    <input type="hidden" id="sc-lat" name="latitude" value="{{ fd.latitude or '' }}"/>
                    <input type="hidden" id="sc-lon" name="longitude" value="{{ fd.longitude or '' }}"/>
                    <div class="mt-2 flex flex-wrap items-center gap-2">
                        <button type="button" id="btn-sc-geo"
                                class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-900/70 px-4 py-2 text-xs font-semibold text-slate-100 hover:bg-slate-800 transition">
                            üìç –£–∫–∞–∑–∞—Ç—å —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ
                        </button>
                        <span id="sc-geo-status" class="text-[11px] text-slate-500">
                            {% if fd.latitude and fd.longitude %}–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ ‚úÖ{% else %}–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞{% endif %}
                        </span>
                    </div>
                    <p id="sc-geo-coords" class="text-[11px] text-slate-500 mt-2">
                        {% if fd.latitude and fd.longitude %}–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: {{ fd.latitude }}, {{ fd.longitude }}{% endif %}
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –°–∞–π—Ç / —Å–æ—Ü—Å–µ—Ç–∏
                        </label>
                        <input type="text" name="website" value="{{ fd.website or '' }}"
                           class="w-full rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3 text-sm text-slate-100 placeholder:text-slate-500 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40"
                           placeholder="https://...">
                    </div>

                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-slate-300">
                            –¢–∏–ø
                        </label>
                        <select name="org_type"
                                class="w-full rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3 text-sm text-slate-100 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/40">
                            <option value="company" {% if (fd.org_type or 'company') == 'company' %}selected{% endif %}>–ö–æ–º–ø–∞–Ω–∏—è</option>
                            <option value="private" {% if (fd.org_type or 'company') == 'private' %}selected{% endif %}>–ß–∞—Å—Ç–Ω–∏–∫</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="flex items-center gap-3 rounded-2xl border border-slate-700 bg-slate-900/40 px-4 py-3 cursor-pointer hover:bg-slate-900/60 transition">
                        <input type="checkbox" name="is_mobile_service" {% if fd.is_mobile_service %}checked{% endif %} class="accent-emerald-500">
                        <span class="text-sm text-slate-100 font-semibold">–í—ã–µ–∑–¥–Ω–æ–π –º–∞—Å—Ç–µ—Ä</span>
                    </label>

                    <label class="flex items-center gap-3 rounded-2xl border border-slate-700 bg-slate-900/40 px-4 py-3 cursor-pointer hover:bg-slate-900/60 transition">
                        <input type="checkbox" name="has_tow_truck" {% if fd.has_tow_truck %}checked{% endif %} class="accent-emerald-500">
                        <span class="text-sm text-slate-100 font-semibold">–ï—Å—Ç—å —ç–≤–∞–∫—É–∞—Ç–æ—Ä</span>
                    </label>
                </div>

                <div class="space-y-2">
                    <div class="text-xs font-semibold text-slate-300">
                        –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–º–∏–Ω–∏–º—É–º –æ–¥–Ω–∞)
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        {% for code, label in specialization_options %}
                        <label class="flex items-center gap-3 rounded-2xl border border-slate-700 bg-slate-900/40 px-4 py-3 cursor-pointer hover:bg-slate-900/60 transition">
                            <input type="checkbox" name="specializations" value="{{ code }}" {% if code in (fd.specializations or []) %}checked{% endif %} class="accent-emerald-500">
                            <span class="text-sm text-slate-100">{{ label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="submit"
                            class="inline-flex items-center justify-center gap-2 rounded-full bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 text-sm font-bold shadow-md shadow-emerald-600/20 transition">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é
                    </button>

                    <a href="/me/dashboard"
                       class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-900 hover:bg-slate-800 text-slate-100 px-6 py-3 text-sm font-bold border border-slate-700 transition">
                        –û—Ç–º–µ–Ω–∞
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
(function () {
    const btn = document.getElementById("btn-sc-geo");
    const status = document.getElementById("sc-geo-status");
    const coords = document.getElementById("sc-geo-coords");
    const latInput = document.getElementById("sc-lat");
    const lonInput = document.getElementById("sc-lon");
    const addressInput = document.querySelector('input[name="address"]');

    const setStatus = (text, ok = false) => {
        if (!status) return;
        status.textContent = text;
        status.className = "text-[11px] " + (ok ? "text-emerald-300" : "text-slate-500");
    };

    const setCoords = (lat, lon) => {
        if (latInput) latInput.value = String(lat);
        if (lonInput) lonInput.value = String(lon);
        if (coords) coords.textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat}, ${lon}`;
    };

    if (btn) {
        btn.addEventListener("click", () => {
            if (!navigator.geolocation) {
                setStatus("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ", false);
                return;
            }

            setStatus("–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ‚Ä¶", false);

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lon = pos.coords.longitude.toFixed(6);
                    setCoords(lat, lon);
                    setStatus("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ ‚úÖ", true);

                    if (addressInput && !addressInput.value.trim()) {
                        addressInput.value = "–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ";
                    }
                },
                (err) => {
                    setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é: " + (err && err.message ? err.message : "–æ—à–∏–±–∫–∞"), false);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );
        });
    }
})();
</script>

{% endblock %}
