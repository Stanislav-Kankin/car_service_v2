{% extends "layout/base.html" %}

{% block title %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –°–¢–û ‚Äî CarBot{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto mt-8 space-y-6">
  <div>
    <p class="text-xs uppercase tracking-[0.25em] text-emerald-400/80 mb-1">–ö–∞–±–∏–Ω–µ—Ç –°–¢–û</p>
    <h1 class="text-2xl font-semibold">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞</h1>
    <p class="text-sm text-slate-300">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ. –ù–æ–≤–∞—è –°–¢–û –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏.</p>
  </div>

  {% if success %}
  <div class="rounded-2xl border border-emerald-500/40 bg-emerald-500/10 px-4 py-3 text-sm text-emerald-100">
    ‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ú—ã —É–≤–µ–¥–æ–º–∏–º –≤–∞—Å –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.
  </div>
  {% endif %}

  {% if error_message %}
  <div class="rounded-2xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-100">
    {{ error_message }}
  </div>
  {% endif %}

  <div class="rounded-3xl border border-slate-800 bg-slate-900/80 p-6 shadow-lg shadow-black/20">
    <form method="post" action="/sc/create" class="space-y-5">
      <div class="grid gap-4 md:grid-cols-2">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-slate-200 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –°–¢–û *</label>
          <input name="name" required
            value="{{ (form_data.name if form_data is defined else '') }}"
            class="w-full rounded-2xl border border-slate-700 bg-slate-950/40 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–≤—Ç–æ–°–µ—Ä–≤–∏—Å –ü–ª—é—Å" />
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-slate-200 mb-1">–ê–¥—Ä–µ—Å *</label>
          <input name="address" required
            value="{{ (form_data.address if form_data is defined else '') }}"
            class="w-full rounded-2xl border border-slate-700 bg-slate-950/40 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
            placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º" />
          <p class="mt-2 text-xs text-slate-400">
            –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω—É–∂–Ω—ã –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –∑–∞—è–≤–æ–∫ –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é.
          </p>
        </div>

        <div class="md:col-span-2">
          <div class="flex flex-wrap gap-2">
            <button type="button" id="btn-sc-geo-current"
              class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-xs font-semibold text-slate-900 shadow shadow-emerald-500/25 hover:bg-emerald-400 transition">
              üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
            </button>
            <button type="button" id="btn-sc-geo-map"
              class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-4 py-2 text-xs font-semibold text-slate-100 hover:bg-slate-800 transition">
              üó∫ –í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
            </button>

            <span id="geo-status" class="text-xs text-slate-400 self-center"></span>
          </div>

          <input type="hidden" name="latitude" id="latitude" value="{{ (form_data.latitude if form_data is defined else '') }}">
          <input type="hidden" name="longitude" id="longitude" value="{{ (form_data.longitude if form_data is defined else '') }}">

          <div class="mt-2 text-xs text-slate-400">
            –¢–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:
            <span class="text-slate-200" id="geo-preview">
              {% if form_data is defined and form_data.latitude and form_data.longitude %}
              {{ form_data.latitude }}, {{ form_data.longitude }}
              {% else %}
              –Ω–µ —É–∫–∞–∑–∞–Ω—ã
              {% endif %}
            </span>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-200 mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input name="phone"
            value="{{ (form_data.phone if form_data is defined else '') }}"
            class="w-full rounded-2xl border border-slate-700 bg-slate-950/40 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
            placeholder="+7..." />
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-200 mb-1">–°–∞–π—Ç/—Å–æ—Ü—Å–µ—Ç–∏</label>
          <input name="website"
            value="{{ (form_data.website if form_data is defined else '') }}"
            class="w-full rounded-2xl border border-slate-700 bg-slate-950/40 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
            placeholder="https://..." />
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-slate-200 mb-2">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ *</label>
          <div class="grid gap-2 sm:grid-cols-2">
            {% for key, label in specialization_options %}
            {% set checked = false %}
            {% if form_data is defined and form_data.specializations is defined %}
              {% if key in form_data.specializations %}
                {% set checked = true %}
              {% endif %}
            {% endif %}
            <label class="flex items-center gap-3 rounded-2xl border border-slate-800 bg-slate-950/20 px-3 py-2 text-sm text-slate-200 hover:bg-slate-800/40 transition">
              <input type="checkbox" name="specializations" value="{{ key }}"
                {% if checked %}checked{% endif %}
                class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-emerald-500 focus:ring-emerald-500" />
              <span>{{ label }}</span>
            </label>
            {% endfor %}
          </div>
          <p class="mt-2 text-xs text-slate-400">–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º –æ–¥–Ω—É.</p>
        </div>

        <div class="md:col-span-2 flex flex-wrap gap-3">
          {% set mobile_checked = false %}
          {% set tow_checked = false %}
          {% if form_data is defined %}
            {% if form_data.is_mobile_service %}{% set mobile_checked = true %}{% endif %}
            {% if form_data.has_tow_truck %}{% set tow_checked = true %}{% endif %}
          {% endif %}

          <label class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-4 py-2 text-xs font-semibold text-slate-100 hover:bg-slate-800 transition">
            <input type="checkbox" name="is_mobile_service" value="1" {% if mobile_checked %}checked{% endif %}
              class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-emerald-500 focus:ring-emerald-500" />
            üöó –í—ã–µ–∑–¥–Ω–æ–π —Å–µ—Ä–≤–∏—Å
          </label>

          <label class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-4 py-2 text-xs font-semibold text-slate-100 hover:bg-slate-800 transition">
            <input type="checkbox" name="has_tow_truck" value="1" {% if tow_checked %}checked{% endif %}
              class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-emerald-500 focus:ring-emerald-500" />
            üõª –ï—Å—Ç—å —ç–≤–∞–∫—É–∞—Ç–æ—Ä
          </label>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 pt-2">
        <button type="submit"
          class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-6 py-3 text-sm font-semibold text-slate-900 shadow shadow-emerald-500/25 hover:bg-emerald-400 transition">
          ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é
        </button>

        <a href="/sc/dashboard"
          class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-6 py-3 text-sm font-semibold text-slate-100 hover:bg-slate-800 transition">
          ‚Üê –ù–∞–∑–∞–¥
        </a>
      </div>
    </form>
  </div>
</div>

<!-- GEO MODAL -->
<div id="geo-modal" class="fixed inset-0 hidden z-50">
  <div class="absolute inset-0 bg-black/60"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-xl rounded-3xl border border-slate-800 bg-slate-900/95 p-4 shadow-2xl">
      <div class="flex items-start justify-between gap-3 mb-3">
        <div>
          <div class="text-sm font-semibold text-slate-100">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ</div>
          <div class="text-xs text-slate-400">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –º–∞—Ä–∫–µ—Ä</div>
        </div>
        <button type="button" id="geo-close" class="rounded-full border border-slate-700 px-3 py-1 text-xs text-slate-200 hover:bg-slate-800">
          ‚úï
        </button>
      </div>

      <div id="geo-map" class="w-full rounded-2xl border border-slate-800" style="height: 360px;"></div>

      <div class="mt-3 flex flex-wrap justify-end gap-2">
        <button type="button" id="geo-cancel"
          class="rounded-full border border-slate-700 px-4 py-2 text-xs font-semibold text-slate-100 hover:bg-slate-800 transition">
          –û—Ç–º–µ–Ω–∞
        </button>
        <button type="button" id="geo-apply"
          class="rounded-full bg-emerald-500 px-4 py-2 text-xs font-semibold text-slate-900 hover:bg-emerald-400 transition">
          –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É —Ç–æ—á–∫—É
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  const latInput = document.getElementById("latitude");
  const lonInput = document.getElementById("longitude");
  const statusEl = document.getElementById("geo-status");
  const previewEl = document.getElementById("geo-preview");

  const btnCurrent = document.getElementById("btn-sc-geo-current");
  const btnMap = document.getElementById("btn-sc-geo-map");

  const modal = document.getElementById("geo-modal");
  const btnClose = document.getElementById("geo-close");
  const btnCancel = document.getElementById("geo-cancel");
  const btnApply = document.getElementById("geo-apply");
  const mapEl = document.getElementById("geo-map");

  let map = null;
  let marker = null;

  function setPreview(lat, lon) {
    if (previewEl) previewEl.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
  }

  function setCoords(lat, lon) {
    latInput.value = String(lat);
    lonInput.value = String(lon);
    setPreview(lat, lon);
    if (statusEl) statusEl.textContent = "‚úÖ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã";
  }

  function openModal() {
    modal.classList.remove("hidden");
    setTimeout(() => { if (map) map.invalidateSize(); }, 100);
  }

  function closeModal() {
    modal.classList.add("hidden");
  }

  function initMap(centerLat, centerLon) {
    if (!window.L) {
      if (statusEl) statusEl.textContent = "‚ùå –ö–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å (Leaflet).";
      return;
    }

    if (!map) {
      map = L.map(mapEl);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);

      marker = L.marker([centerLat, centerLon], { draggable: true }).addTo(map);

      map.on("click", (e) => {
        marker.setLatLng(e.latlng);
      });

      marker.on("dragend", () => {
        // –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –º–∞—Ä–∫–µ—Ä–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ
      });
    } else {
      marker.setLatLng([centerLat, centerLon]);
    }

    map.setView([centerLat, centerLon], 14);
  }

  btnCurrent?.addEventListener("click", () => {
    if (!navigator.geolocation) {
      if (statusEl) statusEl.textContent = "‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º.";
      return;
    }
    if (statusEl) statusEl.textContent = "‚è≥ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã‚Ä¶";

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        setCoords(lat, lon);
      },
      () => {
        if (statusEl) statusEl.textContent = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ.";
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });

  btnMap?.addEventListener("click", () => {
    // –ë–µ—Ä—ë–º —Ç–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å
    const lat = parseFloat(latInput.value);
    const lon = parseFloat(lonInput.value);

    if (Number.isFinite(lat) && Number.isFinite(lon)) {
      initMap(lat, lon);
      openModal();
      return;
    }

    // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ, –∏–Ω–∞—á–µ –¥–µ—Ñ–æ–ª—Ç
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          initMap(pos.coords.latitude, pos.coords.longitude);
          openModal();
        },
        () => {
          initMap(55.751244, 37.618423); // fallback
          openModal();
        },
        { enableHighAccuracy: true, timeout: 7000 }
      );
    } else {
      initMap(55.751244, 37.618423);
      openModal();
    }
  });

  btnApply?.addEventListener("click", () => {
    if (!marker) return;
    const p = marker.getLatLng();
    setCoords(p.lat, p.lng);
    closeModal();
  });

  btnClose?.addEventListener("click", closeModal);
  btnCancel?.addEventListener("click", closeModal);
})();
</script>
{% endblock %}
