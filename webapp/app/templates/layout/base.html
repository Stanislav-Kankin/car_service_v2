<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>{% block title %}MyGarage WebApp{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50">
  <header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-xl bg-emerald-500/20 border border-emerald-500/30 flex items-center justify-center">üöó</div>
        <div class="text-sm font-semibold">MyGarage</div>
      </div>

      <nav class="flex items-center gap-3 text-xs text-slate-300">
        <a href="/me/dashboard" class="hover:text-emerald-300 transition">–ö–ª–∏–µ–Ω—Ç</a>
        <a href="/sc/dashboard" class="hover:text-emerald-300 transition">–°–¢–û</a>
        <a href="/admin/dashboard" class="hover:text-emerald-300 transition">–ê–¥–º–∏–Ω–∫–∞</a>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    {% block content %}{% endblock %}
  </main>

  <script>
    function getCookie(name) {
      const m = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
      return m ? decodeURIComponent(m[2]) : null;
    }

    function setUserIdCookie(userId) {
      const isHttps = window.location.protocol === "https:";
      // –ù–∞ https –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ SameSite=None; Secure, –∏–Ω–∞—á–µ –±—Ä–∞—É–∑–µ—Ä/–≤–µ–±–≤—å—é –º–æ–≥—É—Ç –≤—ã–∫–∏–Ω—É—Ç—å cookie.
      // –ù–∞ http Secure –Ω–µ–ª—å–∑—è ‚Äî cookie –ø—Ä–æ—Å—Ç–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.
      const base = `user_id=${encodeURIComponent(userId)}; Path=/; Max-Age=2592000`;
      if (isHttps) {
        document.cookie = base + "; SameSite=None; Secure";
      } else {
        document.cookie = base + "; SameSite=Lax";
      }
    }

    function extractInitDataFromUrl() {
      // 1) tgWebAppData –≤ query (–∏–Ω–æ–≥–¥–∞ —Ç–∞–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Telegram Desktop "–≤ –±—Ä–∞—É–∑–µ—Ä–µ")
      const qs = new URLSearchParams(window.location.search);
      const fromQuery = qs.get("tgWebAppData");
      if (fromQuery) return decodeURIComponent(fromQuery);

      // 2) tgWebAppData –≤ hash (—á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
      // –ø—Ä–∏–º–µ—Ä: #tgWebAppData=...&tgWebAppVersion=...
      const hash = window.location.hash || "";
      if (hash.includes("tgWebAppData=")) {
        const h = hash.startsWith("#") ? hash.slice(1) : hash;
        const hs = new URLSearchParams(h);
        const fromHash = hs.get("tgWebAppData");
        if (fromHash) return decodeURIComponent(fromHash);
      }

      return "";
    }

    async function authViaTelegram(initData) {
      const resp = await fetch("/api/v1/auth/telegram-webapp", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ init_data: initData })
      });

      if (!resp.ok) {
        console.error("Auth error:", resp.status);
        return null;
      }

      const data = await resp.json();
      if (!data || !data.user_id) {
        console.error("Auth response has no user_id:", data);
        return null;
      }

      setUserIdCookie(data.user_id);
      return data.user_id;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // –ï—Å–ª–∏ cookie —É–∂–µ –µ—Å—Ç—å ‚Äî –Ω–µ –æ–±—è–∑–∞–Ω—ã –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤—ã–≤–∞—Ç—å—Å—è,
      // –Ω–æ –¥–ª—è Telegram WebView –ª—É—á—à–µ –∏–Ω–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è—Ç—å.
      // –°–¥–µ–ª–∞–µ–º —Ç–∞–∫: –µ—Å–ª–∏ –µ—Å—Ç—å Telegram/initData ‚Äî –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ–º cookie.
      // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å (–∏ –ø–æ–∫–∞–∂–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É, –µ—Å–ª–∏ cookie –Ω–µ—Ç).
      const existing = getCookie("user_id");

      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

      let initData = "";
      if (tg) {
        try { tg.ready(); } catch (e) {}
        initData = tg.initData || "";
      } else {
        initData = extractInitDataFromUrl();
      }

      if (initData) {
        // –µ—Å—Ç—å initData ‚Äî –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –æ–±–Ω–æ–≤–∏–º cookie
        await authViaTelegram(initData);
        return;
      }

      // initData –Ω–µ—Ç
      if (!existing) {
        // cookie –Ω–µ—Ç ‚Äî –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ —Ç–∞–∫ –∏ –±—É–¥–µ—Ç -> 401 –Ω–∞ –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
        console.warn("–ù–µ—Ç Telegram initData –∏ –Ω–µ—Ç cookie user_id. –û—Ç–∫—Ä–æ–π WebApp –∏–∑ Telegram –∏–ª–∏ –¥–æ–±–∞–≤—å tgWebAppData –≤ URL.");
      }
    });
  </script>
</body>
</html>
