<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <title>{% block title %}MyGarage WebApp{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50">
    <header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 rounded-xl bg-emerald-500/20 border border-emerald-500/30 flex items-center justify-center">
                    üöó</div>
                <div class="text-sm font-semibold">MyGarage</div>
            </div>

            <nav class="flex items-center gap-3 text-xs text-slate-300">
                <a href="/me/dashboard" class="hover:text-emerald-300 transition">–ö–ª–∏–µ–Ω—Ç</a>
                <a href="/sc/dashboard" class="hover:text-emerald-300 transition">–°–¢–û</a>
                <a href="/admin/dashboard" class="hover:text-emerald-300 transition">–ê–¥–º–∏–Ω–∫–∞</a>
            </nav>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-6">
        {% block content %}{% endblock %}
    </main>

    <script>
        function getCookie(name) {
            const m = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
            return m ? decodeURIComponent(m[2]) : null;
        }

        function setUserIdCookie(userId) {
            const isHttps = window.location.protocol === "https:";
            const host = window.location.hostname;

            // —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ –∏ –Ω–∞ www.dev-cloud-ksa.ru, –∏ –Ω–∞ dev-cloud-ksa.ru
            // –ï—Å–ª–∏ —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –¥—Ä—É–≥–æ–π –¥–æ–º–µ–Ω –≤ –±—É–¥—É—â–µ–º ‚Äî –ø–æ–¥—Å—Ç—Ä–æ–π —É—Å–ª–æ–≤–∏–µ.
            const useDomain =
                host === "dev-cloud-ksa.ru" ||
                host === "www.dev-cloud-ksa.ru";

            const baseParts = [
                `user_id=${encodeURIComponent(userId)}`,
                "Path=/",
                "Max-Age=2592000" // 30 –¥–Ω–µ–π
            ];

            if (useDomain) {
                baseParts.push("Domain=.dev-cloud-ksa.ru");
            }

            if (isHttps) {
                baseParts.push("SameSite=None");
                baseParts.push("Secure");
            } else {
                baseParts.push("SameSite=Lax");
            }

            document.cookie = baseParts.join("; ");
        }

        async function authViaTelegram(initData) {
            const resp = await fetch("/api/v1/auth/telegram-webapp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ init_data: initData })
            });

            if (!resp.ok) {
                console.error("Auth error:", resp.status);
                return null;
            }

            const data = await resp.json();
            if (!data || !data.user_id) {
                console.error("Auth response has no user_id:", data);
                return null;
            }

            setUserIdCookie(data.user_id);
            return String(data.user_id);
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const before = getCookie("user_id");

            // Telegram WebApp
            const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            if (!tg) {
                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –Ω–µ –∏–∑ Telegram ‚Äî –ø—Ä–æ—Å—Ç–æ –∂–∏–≤—ë–º –∫–∞–∫ –µ—Å—Ç—å.
                return;
            }

            try { tg.ready(); } catch (e) { }

            if (!tg.initData || tg.initData.length === 0) {
                console.warn("Telegram initData is empty");
                return;
            }

            const uid = await authViaTelegram(tg.initData);
            const after = getCookie("user_id");

            // –ï—Å–ª–∏ cookie –Ω–µ –±—ã–ª–æ / –ø–æ–º–µ–Ω—è–ª–æ—Å—å ‚Äî –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É,
            // —á—Ç–æ–±—ã –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∫–ª–∏–∫–∏ —Ç–æ—á–Ω–æ —à–ª–∏ —É–∂–µ —Å cookie.
            if (uid && (!before || before !== after)) {
                const url = window.location.pathname + window.location.search;
                window.location.replace(url);
            }
        });
    </script>

</body>

</html>
