<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>{% block title %}CarBot WebApp{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–≤–æ–∏ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="/static/css/main.css">
</head>

<body class="min-h-screen bg-slate-950 text-slate-50">

    <header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center text-slate-900 font-bold">
                    C
                </div>
                <span class="font-semibold tracking-wide">CarBot</span>
            </div>
            <nav class="text-sm text-slate-300">
                <!-- –ø–æ–∑–∂–µ —Å—é–¥–∞ –¥–æ–±–∞–≤–∏–º —Å—Å—ã–ª–∫–∏ –≤ –õ–ö/–≤—ã—Ö–æ–¥ -->
                <span class="opacity-60">MVP</span>
            </nav>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-8">
        {% block content %}{% endblock %}
    </main>

    <footer class="border-t border-slate-800 bg-slate-900/80 mt-8">
        <div class="max-w-5xl mx-auto px-4 py-4 text-xs text-slate-500 flex justify-between">
            <span>MyGarage &copy; {{ 2025 }}</span>
            <span>MVP-–≤–µ—Ä—Å–∏—è 3.11</span>
        </div>
    </footer>

    <script src="/static/js/main.js"></script>

    <!-- Telegram WebApp API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        console.log("üî• JS –∑–∞–≥—Ä—É–∂–µ–Ω");
        alert("JS —Ä–∞–±–æ—Ç–∞–µ—Ç!");
    </script>

    <!-- üî• –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π Telegram WebApp login -->
    <script>
        document.addEventListener("DOMContentLoaded", async () => {

            const tg = window.Telegram?.WebApp;
            if (!tg) {
                console.warn("Telegram WebApp not detected");
                return;
            }

            const initData = tg.initData;
            if (!initData) {
                console.warn("No initData");
                return;
            }

            console.log("üì≤ Telegram initData detected, sending to backend...");

            try {
                const resp = await fetch("/api/v1/auth/telegram-webapp", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ init_data: initData }),
                });

                const data = await resp.json();
                console.log("Auth response:", data);

                if (data.user_id) {

                    // üëâ –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è Telegram Mini App:
                    // Cookie MUST be: SameSite=None; Secure;
                    document.cookie = `user_id=${data.user_id}; Path=/; SameSite=None; Secure`;

                    console.log("‚ú® Cookie user_id set:", data.user_id);

                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                    location.reload();
                }

            } catch (err) {
                console.error("Auth error", err);
            }
        });
    </script>

</body>

</html>