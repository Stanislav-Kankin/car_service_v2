<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <title>{% block title %}MyGarage WebApp{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50">
    <header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-xl bg-emerald-500/20 border border-emerald-500/30 flex items-center justify-center">
                    üöó
                </div>
                <div class="text-sm font-semibold">MyGarage</div>
            </div>

            <nav class="flex items-center gap-3 text-xs text-slate-300">
                <a href="/me/dashboard" class="hover:text-emerald-300 transition">–ö–ª–∏–µ–Ω—Ç</a>
                <a href="/sc/dashboard" class="hover:text-emerald-300 transition">–°–¢–û</a>
                <a href="/admin/dashboard" class="hover:text-emerald-300 transition">–ê–¥–º–∏–Ω–∫–∞</a>
            </nav>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-6">
        {% block content %}{% endblock %}
    </main>

    <script>
        function getCookie(name) {
            const m = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
            return m ? decodeURIComponent(m[2]) : null;
        }

        function setUserIdCookie(userId) {
            const isHttps = window.location.protocol === "https:";
            const base = `user_id=${encodeURIComponent(userId)}; Path=/; Max-Age=2592000`;

            // –î–ª—è Telegram WebView –Ω–∞ https ‚Äî –ª—É—á—à–µ SameSite=None; Secure
            if (isHttps) {
                document.cookie = base + "; SameSite=None; Secure";
            } else {
                document.cookie = base + "; SameSite=Lax";
            }
        }

        function extractInitDataFromUrl() {
            const qs = new URLSearchParams(window.location.search);
            const fromQuery = qs.get("tgWebAppData");
            if (fromQuery) return decodeURIComponent(fromQuery);

            const hash = window.location.hash || "";
            if (hash.includes("tgWebAppData=")) {
                const h = hash.startsWith("#") ? hash.slice(1) : hash;
                const hs = new URLSearchParams(h);
                const fromHash = hs.get("tgWebAppData");
                if (fromHash) return decodeURIComponent(fromHash);
            }

            return "";
        }

        async function authViaTelegram(initData) {
            const resp = await fetch("/api/v1/auth/telegram-webapp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ init_data: initData })
            });

            if (!resp.ok) {
                console.error("Auth error:", resp.status);
                return null;
            }

            const data = await resp.json();
            if (!data || !data.user_id) {
                console.error("Auth response has no user_id:", data);
                return null;
            }

            setUserIdCookie(data.user_id);
            return data.user_id;
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const existing = getCookie("user_id");
            const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

            let initData = "";
            if (tg) {
                try { tg.ready(); } catch (e) { }
                initData = tg.initData || "";
            } else {
                initData = extractInitDataFromUrl();
            }

            // –ï—Å–ª–∏ initData –µ—Å—Ç—å ‚Äî –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –∏ –æ–±–Ω–æ–≤–∏–º cookie
            if (initData) {
                const before = existing;
                const uid = await authViaTelegram(initData);

                // –ï—Å–ª–∏ cookie –Ω–µ –±—ã–ª–æ (–∏–ª–∏ –ø–æ–º–µ–Ω—è–ª–æ—Å—å) ‚Äî –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –±–µ–∑ hash,
                // —á—Ç–æ–±—ã –≤—Å–µ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Ç–æ—á–Ω–æ —à–ª–∏ —Å cookie.
                const after = getCookie("user_id");
                if (uid && (!before || before !== after)) {
                    const url = window.location.pathname + window.location.search;
                    window.location.replace(url);
                }
                return;
            }

            // initData –Ω–µ—Ç
            if (!existing) {
                console.warn("–ù–µ—Ç Telegram initData –∏ –Ω–µ—Ç cookie user_id. –û—Ç–∫—Ä–æ–π WebApp –∏–∑ Telegram.");
            }
        });
    </script>

</body>

</html>
