<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>{% block title %}CarBot WebApp{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50">

    <header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center text-slate-900 font-bold">
                    C</div>
                <span class="font-semibold tracking-wide">CarBot</span>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-8">
        {% block content %}{% endblock %}
    </main>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const tg = window.Telegram?.WebApp;

            // Если не в Telegram WebApp — не пытаемся авторизовывать
            if (!tg) {
                console.warn("Telegram WebApp не найден — страница открыта не из Mini App");
                return;
            }

            const initData = tg.initData;
            if (!initData) {
                console.warn("Нет initData — Telegram не передал данные авторизации");
                return;
            }

            // Проверяем, есть ли уже user_id в cookie
            const hasUserCookie = document.cookie
                .split(";")
                .map(c => c.trim())
                .some(c => c.startsWith("user_id="));

            // Если cookie уже стоит — считаем пользователя авторизованным, больше ничего не делаем
            if (hasUserCookie) {
                return;
            }

            try {
                const resp = await fetch("/api/v1/auth/telegram-webapp", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ init_data: initData })
                });

                if (!resp.ok) {
                    console.error("Ошибка ответа от /api/v1/auth/telegram-webapp:", resp.status);
                    return;
                }

                const data = await resp.json();
                console.log("Ответ /api/v1/auth/telegram-webapp:", data);

                if (data.user_id) {
                    // Ставим cookie
                    document.cookie = `user_id=${data.user_id}; Path=/; SameSite=None; Secure`;

                    // Один раз отправляем пользователя в /me/dashboard (главный кабинет)
                    const targetPath = "/me/dashboard";
                    if (window.location.pathname !== targetPath) {
                        window.location.href = targetPath;
                    }
                    // Если уже на /me/dashboard — ничего не делаем, без reload-цикла
                }
            } catch (err) {
                console.error("Ошибка авторизации через Telegram WebApp:", err);
            }
        });
    </script>



</body>

</html>