<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>{% block title %}CarBot WebApp{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50">

    <header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center text-slate-900 font-bold">
                    C</div>
                <span class="font-semibold tracking-wide">CarBot</span>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-8">
        {% block content %}{% endblock %}
    </main>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const tg = window.Telegram?.WebApp;

            if (!tg) {
                console.warn("Telegram WebApp не найден — страница открыта не из Mini App");
                return;
            }

            const initData = tg.initData;
            if (!initData) {
                console.warn("Нет initData — Telegram не передал данные авторизации");
                return;
            }

            try {
                const resp = await fetch("/api/v1/auth/telegram-webapp", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ init_data: initData })
                });

                const data = await resp.json();
                console.log("Ответ /api/v1/auth/telegram-webapp:", data);

                if (data.user_id) {
                    // Ставим cookie
                    document.cookie = `user_id=${data.user_id}; Path=/; SameSite=None; Secure`;

                    // Правильный редирект:
                    // если мы уже на /me/dashboard — просто обновляем страницу
                    // если вдруг путь другой — уходим на /me/dashboard
                    const targetPath = "/me/dashboard";
                    if (window.location.pathname === targetPath) {
                        window.location.reload();
                    } else {
                        window.location.href = targetPath;
                    }
                }
            } catch (err) {
                console.error("Ошибка авторизации через Telegram WebApp:", err);
            }
        });
    </script>


</body>

</html>