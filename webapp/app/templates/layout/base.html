<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}CarBot WebApp{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50">

<header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center text-slate-900 font-bold">C</div>
            <span class="font-semibold tracking-wide">CarBot</span>
        </div>
    </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-8">
    {% block content %}{% endblock %}
</main>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

    console.log("üî• JS –≤–Ω—É—Ç—Ä–∏ base.html –ó–ê–ü–£–°–¢–ò–õ–°–Ø!");

    const tg = window.Telegram?.WebApp;
    if (!tg) {
        alert("‚ö†Ô∏è –≠—Ç–æ –ù–ï Mini App ‚Äî JS –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.");
        return;
    }

    const initData = tg.initData;
    if (!initData) {
        console.warn("‚ö†Ô∏è –ù–µ—Ç initData");
        return;
    }

    console.log("üì® –û—Ç–ø—Ä–∞–≤–ª—è–µ–º initData:", initData);

    try {
        const resp = await fetch("/api/v1/auth/telegram-webapp", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({init_data: initData})
        });

        const data = await resp.json();
        console.log("–û—Ç–≤–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", data);

        if (data.user_id) {
            document.cookie = `user_id=${data.user_id}; Path=/; SameSite=None; Secure`;
            console.log("Cookie —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:", data.user_id);
            location.reload();
        }
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", err);
    }
});
</script>

</body>
</html>
