<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{% block title %}MyGarage{% endblock %}</title>

    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    {% block head %}{% endblock %}
    <script>
        (function () {
            try {
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                }
            } catch (e) {}
        })();

        // Открыть ссылку внутри Telegram (Mini App)
        // ВАЖНО:
        // - openTelegramLink() в Telegram WebApp корректно работает в первую очередь с https://t.me/*
        // - для tg:// схемы (tg://user?id=...) чаще срабатывает openLink()
        function openTelegramLink(url) {
            try {
                if (window.Telegram && Telegram.WebApp) {
                    const isTme = (typeof url === 'string') && (url.startsWith('https://t.me/') || url.startsWith('http://t.me/'));

                    if (isTme && Telegram.WebApp.openTelegramLink) {
                        Telegram.WebApp.openTelegramLink(url);
                        return;
                    }

                    if (Telegram.WebApp.openLink) {
                        Telegram.WebApp.openLink(url);
                        return;
                    }
                }
            } catch (e) {}

            window.location.href = url;
        }

        // Открыть профиль/чат с пользователем по telegram_id
        // Важно: чаще открывается профиль, откуда можно написать.
        function openTelegramUser(userId) {
            if (!userId) return;
            openTelegramLink('tg://user?id=' + userId);
        }

        // Legacy-имя (в проекте много шаблонов используют openBotChat)
        function openBotChat(url) {
            openTelegramLink(url);
        }
    </script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-100">
    <!-- Header -->
    <header class="sticky top-0 z-40 border-b border-slate-900 bg-slate-950/80 backdrop-blur">
        <div class="mx-auto max-w-4xl px-4 py-3 flex items-center justify-between gap-3">
            <a href="/me/dashboard" class="flex items-center gap-2">
                <div class="h-9 w-9 rounded-xl bg-emerald-500/15 ring-1 ring-emerald-500/30 flex items-center justify-center">
                    <span class="text-emerald-300 font-bold">MG</span>
                </div>
                <div class="leading-tight">
                    <div class="font-semibold">MyGarage</div>
                    <div class="text-[11px] text-slate-400">Клиент · СТО · Админ</div>
                </div>
            </a>

            <nav class="flex items-center gap-2">
                <a href="/me/dashboard"
                   class="rounded-full px-3 py-1.5 text-xs font-semibold bg-slate-900/70 ring-1 ring-slate-800 hover:bg-slate-900">
                    Клиент
                </a>
                <a href="/sc/dashboard"
                   class="rounded-full px-3 py-1.5 text-xs font-semibold bg-slate-900/70 ring-1 ring-slate-800 hover:bg-slate-900">
                    СТО
                </a>

                {% set _is_admin = (request.state.is_admin if (request is defined and request and request.state and request.state.is_admin is defined) else False) %}
                {% if _is_admin %}
                <a href="/admin/service-centers"
                   class="rounded-full px-3 py-1.5 text-xs font-semibold bg-emerald-600/80 ring-1 ring-emerald-500/40 hover:bg-emerald-600">
                    Админка
                </a>
                {% endif %}
            </nav>
        </div>
    </header>

    <!-- Content -->
    <main class="mx-auto max-w-4xl px-4 py-6">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="mx-auto max-w-4xl px-4 pb-6">
        <div class="text-center text-[11px] text-slate-500">
            @{{ bot_username or "MyGarageServiceBot" }}
        </div>
    </footer>

    {% block scripts %}{% endblock %}
</body>
</html>
