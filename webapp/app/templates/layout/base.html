<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>{% block title %}CarBot WebApp{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50">

    <header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-xl bg-emerald-500/20 border border-emerald-500/30 flex items-center justify-center">
                    üöó
                </div>
                <div class="text-sm font-semibold">CarBot</div>
            </div>

            <nav class="flex items-center gap-3 text-xs text-slate-300">
                <a href="/me/dashboard" class="hover:text-emerald-300 transition">–ö–ª–∏–µ–Ω—Ç</a>
                <a href="/sc/dashboard" class="hover:text-emerald-300 transition">–°–¢–û</a>
                <a href="/admin/dashboard" class="hover:text-emerald-300 transition">–ê–¥–º–∏–Ω–∫–∞</a>
            </nav>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-6">
        {% block content %}{% endblock %}
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            // —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram WebApp
            const tg = window.Telegram && window.Telegram.WebApp;
            if (!tg) return;

            try {
                tg.ready();

                const initData = tg.initData || "";
                if (!initData) {
                    console.warn("Telegram initData –ø—É—Å—Ç–æ–π ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞");
                    return;
                }

                // ‚úÖ –í–ê–ñ–ù–û:
                // –ù–ï –¥–µ–ª–∞–µ–º "–µ—Å–ª–∏ cookie —É–∂–µ –µ—Å—Ç—å ‚Äî return".
                // –ü–æ—Ç–æ–º—É —á—Ç–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–µ–ª–µ–≥—Ä–∞–º-–∞–∫–∫–∞—É–Ω—Ç–∞ cookie –æ—Å—Ç–∞—ë—Ç—Å—è!
                const resp = await fetch("/api/v1/auth/telegram-webapp", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ init_data: initData })
                });

                if (!resp.ok) {
                    console.error("–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç /api/v1/auth/telegram-webapp:", resp.status);
                    return;
                }

                const data = await resp.json();
                if (!data.user_id) {
                    console.error("–ù–µ—Ç user_id –≤ –æ—Ç–≤–µ—Ç–µ /api/v1/auth/telegram-webapp:", data);
                    return;
                }

                // ‚úÖ –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º cookie –∫–∞–∂–¥—ã–π —Ä–∞–∑
                // (–∏–º–µ–Ω–Ω–æ —ç—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å–º–µ–Ω—É –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ Telegram)
                document.cookie = `user_id=${data.user_id}; Path=/; SameSite=None; Secure; Max-Age=2592000`;

                // –ï—Å–ª–∏ Telegram –ø—Ä–∏—Å–ª–∞–ª —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –ø—É—Ç—å ‚Äî –æ–¥–∏–Ω —Ä–∞–∑ –ø–µ—Ä–µ–±—Ä–æ—Å–∏–º
                const sp = tg.initDataUnsafe && tg.initDataUnsafe.start_param;
                if (sp && typeof sp === "string") {
                    // –ü—Ä–∏–º–µ—Ä: "me/dashboard" –∏–ª–∏ "sc/dashboard"
                    const targetPath = sp.startsWith("/") ? sp : ("/" + sp);
                    if (window.location.pathname !== targetPath) {
                        window.location.href = targetPath;
                        return;
                    }
                }
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram WebApp:", err);
            }
        });
    </script>

</body>

</html>
